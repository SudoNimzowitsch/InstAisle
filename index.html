<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>InstAisle</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="InstAisle">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#0f1117">
<meta name="mobile-web-app-capable" content="yes">
<!-- Firebase SDK -->
<script type="module">
// Firebase is loaded as a module ‚Äî see bottom of body
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@700;900&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#22263a;--border:#2e3347;
  --text:#eef0f8;--muted:#6b7196;--green:#4ade80;--amber:#fbbf24;
  --red:#f87171;--blue:#60a5fa;
}
html,body{height:100%;overflow:hidden;}
body{
  font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;height:100vh;
  max-width:430px;margin:0 auto;position:relative;overflow:hidden;
}

/* TOPBAR */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px 12px;background:var(--bg);
  border-bottom:1px solid var(--border);flex-shrink:0;z-index:10;
}
.logo{
  font-family:'Playfair Display',serif;font-size:1.45rem;font-weight:900;
  letter-spacing:-0.03em;
  background:linear-gradient(135deg,var(--green),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.topbar-right{display:flex;align-items:center;gap:8px;}
.store-pill{
  background:var(--surface2);border:1px solid var(--border);border-radius:20px;
  padding:5px 12px 5px 8px;font-size:0.72rem;font-weight:500;cursor:pointer;
  display:flex;align-items:center;gap:6px;color:var(--text);transition:border-color .15s;
}
.store-pill:hover{border-color:var(--green);}
.store-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;}
.icon-btn{
  background:var(--surface);border:1px solid var(--border);border-radius:50%;
  width:34px;height:34px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1rem;transition:border-color .15s;color:var(--text);
}
.icon-btn:hover{border-color:var(--green);}

/* SCREENS */
.screens{flex:1;overflow:hidden;position:relative;}
.screen{
  position:absolute;inset:0;overflow-y:auto;
  padding:16px 20px 100px;display:none;animation:slideIn .25s ease;
}
.screen.active{display:block;}
@keyframes slideIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}

/* BOTTOM NAV */
.bottomnav{display:flex;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;z-index:10;}
.nav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:10px 0 14px;cursor:pointer;border:none;background:none;color:var(--muted);
  font-family:'Outfit',sans-serif;font-size:0.62rem;font-weight:500;
  letter-spacing:.04em;text-transform:uppercase;transition:color .15s;
}
.nav-btn .nav-icon{font-size:1.25rem;}
.nav-btn.active{color:var(--green);}

/* BUTTONS */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  padding:10px 18px;border-radius:10px;border:none;
  font-family:'Outfit',sans-serif;font-size:0.85rem;font-weight:600;
  cursor:pointer;transition:all .15s;
}
.btn-primary{background:var(--green);color:#0a1a12;}
.btn-primary:hover{background:#6ee79a;}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
.btn-ghost:hover{border-color:var(--muted);color:var(--text);}
.btn-danger{background:transparent;color:var(--red);border:1px solid #3d1a1a;}
.btn-danger:hover{background:#2a1212;}
.btn-sm{padding:6px 12px;font-size:0.75rem;border-radius:8px;}
.btn-full{width:100%;}

/* SECTION HEADERS */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-title{font-size:.65rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);}

/* CARDS */
.card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:16px;margin-bottom:10px;transition:border-color .15s;
}
.card-header{display:flex;align-items:center;justify-content:space-between;}

/* INPUTS */
.input-wrap{margin-bottom:14px;}
.input-label{font-size:.7rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
.input{
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:11px 14px;font-family:'Outfit',sans-serif;
  font-size:.9rem;color:var(--text);outline:none;transition:border-color .15s;
}
.input:focus{border-color:var(--green);}
.input::placeholder{color:var(--muted);}
textarea.input{resize:vertical;min-height:90px;}

/* KEYWORD CHIPS */
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;min-height:10px;}
.chip{
  background:var(--surface2);border:1px solid var(--border);border-radius:20px;
  padding:3px 8px 3px 10px;font-size:.7rem;display:flex;align-items:center;gap:4px;color:var(--text);
}
.chip-x{
  cursor:pointer;color:var(--muted);font-size:1rem;line-height:1;
  display:flex;align-items:center;justify-content:center;
  width:16px;height:16px;border-radius:50%;flex-shrink:0;
  transition:background .1s,color .1s;
}
.chip-x:hover{background:var(--red);color:#fff;}

/* KEYWORD INPUT SECTION */
.kw-section{margin-top:4px;}
.kw-tabs{display:flex;gap:0;margin-bottom:8px;border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.kw-tab{
  flex:1;padding:6px 10px;font-family:'Outfit',sans-serif;font-size:.7rem;font-weight:600;
  background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;
  letter-spacing:.04em;
}
.kw-tab.active{background:var(--surface2);color:var(--text);}
.kw-panel{display:none;}
.kw-panel.active{display:block;}
.kw-add-row{display:flex;gap:6px;align-items:center;}
.kw-input{
  flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  padding:7px 10px;font-family:'Outfit',sans-serif;font-size:.78rem;color:var(--text);
  outline:none;transition:border-color .15s;min-width:0;
}
.kw-input:focus{border-color:var(--green);}
.kw-input::placeholder{color:var(--muted);}
.kw-add-btn{
  background:var(--green);color:#0a1a12;border:none;border-radius:8px;
  padding:7px 14px;font-family:'Outfit',sans-serif;font-size:.78rem;font-weight:700;
  cursor:pointer;flex-shrink:0;transition:background .15s;
}
.kw-add-btn:hover{background:#6ee79a;}
.kw-bulk{
  width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  padding:8px 10px;font-family:'Outfit',sans-serif;font-size:.78rem;color:var(--text);
  outline:none;transition:border-color .15s;resize:vertical;min-height:72px;
}
.kw-bulk:focus{border-color:var(--green);}
.kw-bulk::placeholder{color:var(--muted);}
.kw-bulk-btn{
  margin-top:6px;width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:7px;font-family:'Outfit',sans-serif;font-size:.75rem;
  font-weight:600;color:var(--text);cursor:pointer;transition:border-color .15s;
}
.kw-bulk-btn:hover{border-color:var(--green);color:var(--green);}

/* AISLE DRAG HANDLE */
.aisle-drag-handle{
  cursor:grab;color:var(--muted);font-size:1.1rem;line-height:1;
  padding:2px 4px;border-radius:4px;touch-action:none;
  transition:color .15s,background .15s;flex-shrink:0;letter-spacing:-1px;
  user-select:none;-webkit-user-select:none;
}
.aisle-drag-handle:hover{color:var(--text);background:var(--surface2);}
.aisle-drag-handle:active,.aisle-drag-handle.grabbing{cursor:grabbing;color:var(--green);}
.aisle-card-dragging{
  opacity:.4;outline:2px dashed var(--green);outline-offset:2px;border-radius:14px;
}
.aisle-card-dragover{
  outline:2px solid var(--green);outline-offset:2px;border-radius:14px;
  background:rgba(74,222,128,.04);
}
.aisle-img-zone{
  border:2px dashed var(--border);border-radius:10px;padding:18px 14px;
  text-align:center;cursor:pointer;transition:all .15s;color:var(--muted);
  position:relative;overflow:hidden;
}
.aisle-img-zone:hover{border-color:var(--blue);color:var(--blue);background:rgba(96,165,250,.04);}
.aisle-img-zone.scanning{border-color:var(--blue);border-style:solid;cursor:default;}
.aisle-img-zone.has-preview{border-color:var(--green);border-style:solid;padding:8px;}
.aisle-img-thumb{
  width:100%;border-radius:6px;max-height:110px;object-fit:cover;display:block;margin-bottom:8px;
}
.aisle-img-spinner{
  width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--blue);
  border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 8px;
}
.scan-result-row{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:10px;padding:8px 10px;background:rgba(96,165,250,.08);
  border:1px solid rgba(96,165,250,.2);border-radius:8px;
}
.scan-result-label{font-size:.7rem;color:var(--blue);}
.scan-accept-btn{
  background:var(--green);color:#0a1a12;border:none;border-radius:6px;
  padding:5px 12px;font-family:'Outfit',sans-serif;font-size:.72rem;font-weight:700;
  cursor:pointer;transition:background .15s;
}
.scan-accept-btn:hover{background:#6ee79a;}
.scan-discard-btn{
  background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:6px;
  padding:5px 10px;font-family:'Outfit',sans-serif;font-size:.72rem;font-weight:600;
  cursor:pointer;margin-left:6px;
}

/* LIST ITEMS */
.list-item{
  display:flex;align-items:center;gap:10px;padding:10px 12px;
  border-radius:10px;background:var(--surface2);margin-bottom:6px;
  transition:all .15s;position:relative;user-select:none;
}
.list-item.dragging{opacity:.35;border:2px dashed var(--green);background:var(--surface);}
.list-item.drag-over{border:2px solid var(--green);transform:scale(1.01);}
.drag-handle{
  cursor:grab;color:var(--muted);font-size:.95rem;line-height:1;
  padding:2px 3px;flex-shrink:0;touch-action:none;letter-spacing:-1px;
}
.drag-handle:active{cursor:grabbing;color:var(--green);}
.list-item.checked{opacity:.45;}
.list-item.checked .item-name{text-decoration:line-through;}
.item-check{
  width:20px;height:20px;border-radius:50%;border:2px solid var(--border);
  flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.item-check.done{background:var(--green);border-color:var(--green);}
.item-name{flex:1;font-size:.88rem;font-weight:400;}
.item-aisle-badge{
  font-size:.62rem;font-weight:600;padding:2px 7px;border-radius:20px;
  cursor:pointer;transition:all .15s;flex-shrink:0;
}
.item-aisle-badge:hover{filter:brightness(1.3);}
.ai-dot{font-size:.55rem;color:#7dd3fc;vertical-align:middle;}

/* AISLE GROUPS */
.aisle-group{margin-bottom:20px;}
.aisle-group-header{
  display:flex;align-items:center;gap:10px;padding:8px 12px;
  border-radius:10px;margin-bottom:8px;font-size:.72rem;font-weight:700;
  letter-spacing:.06em;text-transform:uppercase;
}
.aisle-count{margin-left:auto;opacity:.6;font-weight:400;font-size:.65rem;}
.drop-zone{
  min-height:8px;border-radius:8px;transition:all .2s;margin-top:4px;
}
.drop-zone.active{
  min-height:44px;border:2px dashed var(--green);
  background:rgba(74,222,128,.06);
  display:flex;align-items:center;justify-content:center;
  font-size:.72rem;color:var(--green);
}
.drop-zone.active::after{content:'Drop here';}

/* AI BADGE */
.ai-badge{
  display:inline-flex;align-items:center;gap:4px;
  background:linear-gradient(135deg,#1a2d4a,#1a3d29);
  border:1px solid #2a4a6a;border-radius:20px;
  padding:3px 9px;font-size:.62rem;font-weight:600;
  color:#7dd3fc;letter-spacing:.04em;
}

/* PROCESSING OVERLAY */
.processing-overlay{
  position:fixed;inset:0;background:rgba(15,17,23,.88);
  z-index:200;display:none;flex-direction:column;
  align-items:center;justify-content:center;gap:16px;
}
.processing-overlay.show{display:flex;}
.spinner{
  width:40px;height:40px;border:3px solid var(--border);
  border-top-color:var(--green);border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.processing-text{font-size:.85rem;color:var(--muted);text-align:center;padding:0 32px;}
.processing-title{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--text);}

/* MODAL */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:100;
  display:none;align-items:flex-end;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:20px 20px 0 0;padding:24px 20px 36px;
  width:100%;max-width:430px;margin:0 auto;
  animation:slideUp .25s ease;max-height:85vh;overflow-y:auto;
}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;}
.modal-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;margin-bottom:16px;}

/* UPLOAD ZONE */
.upload-zone{
  border:2px dashed var(--border);border-radius:14px;padding:22px;
  text-align:center;cursor:pointer;transition:all .15s;color:var(--muted);margin-bottom:14px;
}
.upload-zone:hover{border-color:var(--green);background:#0d2018;color:var(--green);}
.upload-zone.has-image{border-color:var(--green);border-style:solid;padding:10px;}
.upload-icon{font-size:1.5rem;margin-bottom:6px;}
.img-preview{width:100%;border-radius:8px;max-height:160px;object-fit:cover;display:block;}
#file-input{display:none;}

/* COLOR PICKER */
.color-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.color-opt{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .15s;}
.color-opt.selected{border-color:white;}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-icon{font-size:2.5rem;margin-bottom:12px;}
.empty-title{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:6px;}
.empty-sub{font-size:.8rem;line-height:1.6;}

/* TOAST */
.toast{
  position:fixed;bottom:80px;left:50%;
  transform:translateX(-50%) translateY(20px);
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:10px 18px;font-size:.82rem;font-weight:500;z-index:300;
  opacity:0;transition:all .25s ease;white-space:nowrap;pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* MISC */
.divider{height:1px;background:var(--border);margin:16px 0;}
.spacer{flex:1;}
.text-muted{color:var(--muted);font-size:.78rem;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#auth-screen{
  position:fixed;inset:0;background:var(--bg);z-index:500;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 28px;max-width:430px;margin:0 auto;
}
.auth-logo{
  font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:900;
  background:linear-gradient(135deg,var(--green),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:8px;
}
.auth-tagline{font-size:.82rem;color:var(--muted);margin-bottom:40px;text-align:center;}
.auth-tabs{display:flex;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:24px;overflow:hidden;width:100%;}
.auth-tab{
  flex:1;padding:10px;font-family:'Outfit',sans-serif;font-size:.8rem;font-weight:600;
  background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;
}
.auth-tab.active{background:var(--surface2);color:var(--text);}
.auth-panel{display:none;width:100%;}
.auth-panel.active{display:block;}
.auth-error{
  font-size:.75rem;color:var(--red);background:rgba(248,113,113,.08);
  border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:8px 12px;
  margin-bottom:12px;display:none;
}
.auth-error.show{display:block;}
.auth-divider{
  display:flex;align-items:center;gap:10px;margin:16px 0;color:var(--muted);font-size:.7rem;
}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.btn-google{
  width:100%;display:flex;align-items:center;justify-content:center;gap:10px;
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:11px;font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:600;
  color:var(--text);cursor:pointer;transition:all .15s;
}
.btn-google:hover{border-color:var(--blue);background:rgba(96,165,250,.06);}
.google-icon{width:18px;height:18px;}

/* ‚îÄ‚îÄ USER AVATAR / PROFILE PILL ‚îÄ‚îÄ */
.user-pill{
  background:var(--surface2);border:1px solid var(--border);border-radius:20px;
  padding:4px 10px 4px 4px;font-size:.72rem;font-weight:500;cursor:pointer;
  display:flex;align-items:center;gap:6px;color:var(--text);transition:border-color .15s;
}
.user-pill:hover{border-color:var(--blue);}
.user-avatar{
  width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--blue));
  display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700;
  color:#0a1a12;flex-shrink:0;overflow:hidden;
}
.user-avatar img{width:100%;height:100%;object-fit:cover;}

/* ‚îÄ‚îÄ SYNC INDICATOR ‚îÄ‚îÄ */
.sync-dot{
  width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0;
  transition:background .3s;
}
.sync-dot.syncing{background:var(--amber);animation:pulse .8s infinite;}
.sync-dot.error{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ SHARE STORE CARD UI ‚îÄ‚îÄ */
.share-code-box{
  background:var(--surface2);border:1px solid var(--green);border-radius:12px;
  padding:16px;text-align:center;margin:12px 0;
}
.share-code{
  font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;
  letter-spacing:.2em;color:var(--green);margin:8px 0 4px;
}
.share-code-hint{font-size:.7rem;color:var(--muted);}
.shared-badge{
  display:inline-flex;align-items:center;gap:5px;
  background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.25);
  border-radius:20px;padding:2px 8px;font-size:.62rem;color:var(--blue);font-weight:600;
}

/* ‚îÄ‚îÄ PROFILE MODAL ‚îÄ‚îÄ */
.profile-avatar-lg{
  width:64px;height:64px;border-radius:50%;
  background:linear-gradient(135deg,var(--green),var(--blue));
  display:flex;align-items:center;justify-content:center;
  font-size:1.6rem;font-weight:700;color:#0a1a12;margin:0 auto 12px;overflow:hidden;
}
.profile-avatar-lg img{width:100%;height:100%;object-fit:cover;}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-logo">InstAisle</div>
  <div class="auth-tagline">Smart grocery lists, synced everywhere</div>

  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
    <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
  </div>

  <!-- Sign In Panel -->
  <div class="auth-panel active" id="auth-panel-signin">
    <div class="auth-error" id="auth-error-signin"></div>
    <div class="input-wrap">
      <label class="input-label">Email</label>
      <input class="input" id="signin-email" type="email" placeholder="you@example.com" autocomplete="email">
    </div>
    <div class="input-wrap">
      <label class="input-label">Password</label>
      <input class="input" id="signin-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
        onkeydown="if(event.key==='Enter') signInEmail()">
    </div>
    <button class="btn btn-primary btn-full" onclick="signInEmail()" id="btn-signin">Sign In</button>
    <div class="auth-divider">or</div>
    <button class="btn-google" onclick="signInGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
  </div>

  <!-- Sign Up Panel -->
  <div class="auth-panel" id="auth-panel-signup">
    <div class="auth-error" id="auth-error-signup"></div>
    <div class="input-wrap">
      <label class="input-label">Display Name</label>
      <input class="input" id="signup-name" type="text" placeholder="Your name" autocomplete="name">
    </div>
    <div class="input-wrap">
      <label class="input-label">Email</label>
      <input class="input" id="signup-email" type="email" placeholder="you@example.com" autocomplete="email">
    </div>
    <div class="input-wrap">
      <label class="input-label">Password</label>
      <input class="input" id="signup-password" type="password" placeholder="Min. 6 characters" autocomplete="new-password"
        onkeydown="if(event.key==='Enter') signUpEmail()">
    </div>
    <button class="btn btn-primary btn-full" onclick="signUpEmail()" id="btn-signup">Create Account</button>
    <div class="auth-divider">or</div>
    <button class="btn-google" onclick="signInGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">InstAisle</div>
  <div class="topbar-right">
    <div class="sync-dot" id="sync-dot" title="Sync status"></div>
    <div class="store-pill" onclick="openStoreSwitch()">
      <div class="store-dot" id="active-store-dot"></div>
      <span id="active-store-name">No store</span>
      <span style="color:var(--muted)">‚ñæ</span>
    </div>
    <div class="user-pill" onclick="openProfileModal()" id="user-pill">
      <div class="user-avatar" id="user-avatar-sm">?</div>
      <span id="user-name-sm">Account</span>
    </div>
    <div class="icon-btn" onclick="openAddList()" title="New list">Ôºã</div>
  </div>
</div>

<!-- SCREENS -->
<div class="screens">
  <div class="screen active" id="screen-list"><div id="list-content"></div></div>
  <div class="screen" id="screen-stores">
    <div class="section-header">
      <span class="section-title">My Stores</span>
      <button class="btn btn-sm btn-primary" onclick="openNewStore()">+ Add Store</button>
    </div>
    <div id="stores-list"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottomnav">
  <button class="nav-btn active" id="nav-list" onclick="switchScreen('list')">
    <span class="nav-icon">üõí</span>List
  </button>
  <button class="nav-btn" id="nav-stores" onclick="switchScreen('stores')">
    <span class="nav-icon">üè™</span>Stores
  </button>
</div>

<!-- PROCESSING OVERLAY -->
<div class="processing-overlay" id="processing-overlay">
  <div class="spinner"></div>
  <div class="processing-title">Asking Claude‚Ä¶</div>
  <div class="processing-text" id="processing-text">Classifying your items by aisle</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Store Switch -->
<div class="modal-overlay" id="modal-store-switch" onclick="closeModal('modal-store-switch')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Choose Store</div>
    <div id="store-switch-list"></div>
    <div class="divider"></div>
    <button class="btn btn-ghost btn-full" onclick="closeModal('modal-store-switch');openNewStore()">+ Add New Store</button>
  </div>
</div>

<!-- New / Edit Store -->
<div class="modal-overlay" id="modal-store" onclick="closeModal('modal-store')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title" id="store-modal-title">New Store</div>
    <div class="input-wrap">
      <label class="input-label">Store Name</label>
      <input class="input" id="store-name-input" placeholder="e.g. Trader Joe's">
    </div>
    <div class="input-wrap">
      <label class="input-label">Color</label>
      <div class="color-picker" id="store-color-picker"></div>
    </div>
    <div class="divider"></div>
    <div class="section-header">
      <span class="section-title">Aisles</span>
      <button class="btn btn-sm btn-ghost" onclick="addAisleRow()">+ Aisle</button>
    </div>
    <div id="aisle-rows"></div>
    <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="saveStore()">Save Store</button>
  </div>
</div>

<!-- Add List -->
<div class="modal-overlay" id="modal-add-list" onclick="closeModal('modal-add-list')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">New Shopping List</div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
      <span class="ai-badge">‚ú¶ AI</span>
      <span class="text-muted">Claude classifies items using your aisle keywords as context</span>
    </div>
    <div class="input-wrap">
      <label class="input-label">Items (one per line)</label>
      <textarea class="input" id="list-text-input" placeholder="Bananas&#10;Chicken breast&#10;Greek yogurt&#10;Olive oil&#10;Shampoo"></textarea>
    </div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div class="upload-icon" id="upload-icon">üìé</div>
      <p style="font-size:.78rem" id="upload-label">Tap to upload a file or photo of your list</p>
    </div>
    <input type="file" id="file-input" accept="*/*" onchange="handleFileUpload(event)">
    <!-- Hidden input for aisle photo scans; id set dynamically before click -->
    <input type="file" id="aisle-img-input" accept="image/*" capture="environment" style="display:none" onchange="handleAisleImageUpload(event)">
    <button class="btn btn-primary btn-full" onclick="processListInput()">‚ú¶ Organise with AI ‚Üí</button>
  </div>
</div>

<!-- Move Item -->
<div class="modal-overlay" id="modal-move-item" onclick="closeModal('modal-move-item')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Move Item</div>
    <p class="text-muted" style="margin-bottom:16px">Where is <strong id="move-item-name" style="color:var(--text)"></strong> located?</p>
    <div id="move-aisle-options"></div>
    <div class="divider"></div>
    <button class="btn btn-ghost btn-full btn-sm" onclick="closeModal('modal-move-item')">Cancel</button>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal-overlay" id="modal-profile" onclick="closeModal('modal-profile')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="profile-avatar-lg" id="profile-avatar-lg">?</div>
    <div style="text-align:center;margin-bottom:20px">
      <div id="profile-display-name" style="font-size:1.1rem;font-weight:600;margin-bottom:4px">User</div>
      <div id="profile-email" class="text-muted"></div>
    </div>
    <div class="divider"></div>
    <div class="section-header" style="margin-bottom:10px">
      <span class="section-title">Join a Shared Store</span>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <input class="input" id="join-code-input" placeholder="Enter 6-letter code" maxlength="6"
        style="text-transform:uppercase;letter-spacing:.1em;font-weight:600"
        oninput="this.value=this.value.toUpperCase()">
      <button class="btn btn-primary" onclick="joinStoreByCode()" style="flex-shrink:0">Join</button>
    </div>
    <div class="divider"></div>
    <button class="btn btn-danger btn-full" onclick="signOut()">Sign Out</button>
  </div>
</div>

<!-- Share Store Modal -->
<div class="modal-overlay" id="modal-share-store" onclick="closeModal('modal-share-store')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Share Store</div>
    <p class="text-muted" style="margin-bottom:16px">Share this code with others so they can join and sync this store's list in real time.</p>
    <div class="share-code-box">
      <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">Share Code</div>
      <div class="share-code" id="share-code-display">------</div>
      <div class="share-code-hint">Others enter this in their profile ‚Üí Join Store</div>
    </div>
    <button class="btn btn-primary btn-full" style="margin-bottom:8px" onclick="copyShareCode()">üìã Copy Code</button>
    <button class="btn btn-ghost btn-full btn-sm" onclick="closeModal('modal-share-store')">Close</button>
  </div>
</div>

<script type="module">
// ‚îÄ‚îÄ Firebase imports (must be first in a module) ‚îÄ‚îÄ
import { initializeApp }                              from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut as fbSignOut,
         createUserWithEmailAndPassword, signInWithEmailAndPassword,
         updateProfile, GoogleAuthProvider, signInWithPopup }
                                                      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, collection, setDoc, getDoc, onSnapshot,
         updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, arrayRemove }
                                                      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE CONFIGURATION
//  Get it from: Firebase Console ‚Üí Project Settings ‚Üí Your Apps
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyC_QHkzWMXgx-p3tRANKO_1ioRXuj91RcA",
  authDomain:        "instaisle-e8d6b.firebaseapp.com",
  projectId:         "instaisle-e8d6b",
  storageBucket:     "instaisle-e8d6b.firebasestorage.app",
  messagingSenderId: "674691002191",
  appId:             "1:674691002191:web:a326ba46c09e1d90435f3a",
  measurementId:     "G-TT3FQXVYQV"
};

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
const app  = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db   = getFirestore(app);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPOSE to global scope (bridge to non-module JS below)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._fb = { auth, db, fbSignOut, createUserWithEmailAndPassword,
               signInWithEmailAndPassword, updateProfile,
               GoogleAuthProvider, signInWithPopup,
               doc, collection, setDoc, getDoc, onSnapshot,
               updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, arrayRemove };

// ‚îÄ‚îÄ Auth state listener ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  if (user) {
    window._currentUser = user;
    updateUserUI(user);
    document.getElementById('auth-screen').style.display = 'none';
    await loadUserData(user.uid);
  } else {
    window._currentUser = null;
    document.getElementById('auth-screen').style.display = 'flex';
    // Clear any live listeners
    if (window._storeUnsubs) window._storeUnsubs.forEach(fn => fn());
    window._storeUnsubs = [];
  }
});

// ‚îÄ‚îÄ Update top-bar user UI ‚îÄ‚îÄ
function updateUserUI(user) {
  const initials = (user.displayName || user.email || '?')
    .split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase();
  const avatarSm  = document.getElementById('user-avatar-sm');
  const nameSm    = document.getElementById('user-name-sm');
  const avatarLg  = document.getElementById('profile-avatar-lg');
  const nameEl    = document.getElementById('profile-display-name');
  const emailEl   = document.getElementById('profile-email');

  if (user.photoURL) {
    avatarSm.innerHTML  = `<img src="${user.photoURL}" alt="">`;
    avatarLg.innerHTML  = `<img src="${user.photoURL}" alt="">`;
  } else {
    avatarSm.textContent  = initials;
    avatarLg.textContent  = initials;
  }
  nameSm.textContent  = user.displayName || user.email.split('@')[0];
  nameEl.textContent  = user.displayName || 'User';
  emailEl.textContent = user.email;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIRESTORE LOAD & SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._storeUnsubs = [];

async function loadUserData(uid) {
  const { db, doc, collection, onSnapshot, query, where, getDocs } = window._fb;
  setSyncDot('syncing');

  // Load stores the user owns or is a member of
  const storesRef = collection(db, 'stores');

  // owned stores
  const ownedQ   = query(storesRef, where('ownerUid', '==', uid));
  // shared stores
  const sharedQ  = query(storesRef, where('members', 'array-contains', uid));

  const [ownedSnap, sharedSnap] = await Promise.all([getDocs(ownedQ), getDocs(sharedQ)]);

  const storeDocs = [...ownedSnap.docs, ...sharedSnap.docs];

  // Rebuild local state from Firestore
  state.stores = [];
  state.lists  = {};
  state.corrections = {};

  if (storeDocs.length === 0) {
    // First time ‚Äî seed demo store to Firestore
    await seedDemoStore(uid);
    return;
  }

  storeDocs.forEach(snap => {
    const d = snap.data();
    state.stores.push({
      id: snap.id, name: d.name, color: d.color, aisles: d.aisles || [],
      ownerUid: d.ownerUid, members: d.members || [], shareCode: d.shareCode || null,
      isShared: (d.members || []).length > 0 || d.ownerUid !== uid
    });
    state.lists[snap.id]       = d.list        || [];
    state.corrections[snap.id] = d.corrections || {};
  });

  if (!state.activeStoreId || !state.stores.find(s => s.id === state.activeStoreId)) {
    state.activeStoreId = state.stores[0]?.id || null;
  }

  renderAll();
  setSyncDot('ok');

  // Set up real-time listeners for each store
  window._storeUnsubs.forEach(fn => fn());
  window._storeUnsubs = storeDocs.map(snap =>
    onSnapshot(doc(db, 'stores', snap.id), (d) => {
      if (!d.exists()) return;
      const data = d.data();
      // Update store in state
      const idx = state.stores.findIndex(s => s.id === d.id);
      if (idx !== -1) {
        state.stores[idx] = { ...state.stores[idx], name: data.name, color: data.color,
          aisles: data.aisles || [], members: data.members || [], shareCode: data.shareCode || null };
        state.lists[d.id]       = data.list        || [];
        state.corrections[d.id] = data.corrections || {};
        renderAll();
        setSyncDot('ok');
      }
    })
  );
}

async function seedDemoStore(uid) {
  const { db, doc, setDoc, serverTimestamp } = window._fb;
  const id = 'store-' + uid.substring(0,8);
  const demo = {
    ownerUid: uid, members: [], shareCode: null,
    name: 'Whole Foods', color: '#4ade80',
    createdAt: serverTimestamp(),
    aisles: [
      {name:'Aisle 1 ‚Äì Produce',       keywords:['apple','banana','orange','grape','berries','lettuce','spinach','kale','broccoli','carrot','tomato','cucumber','pepper','onion','garlic','lemon','lime','avocado','mushroom','fruit','vegetable','herbs','cilantro','ginger','zucchini','celery','arugula']},
      {name:'Aisle 2 ‚Äì Dairy & Eggs',  keywords:['milk','cheese','yogurt','butter','cream','eggs','egg','sour cream','kefir','mozzarella','cheddar','parmesan','brie','cottage cheese','feta','ricotta','cream cheese']},
      {name:'Aisle 3 ‚Äì Meat & Seafood',keywords:['chicken','beef','pork','salmon','tuna','shrimp','turkey','lamb','steak','ground beef','bacon','sausage','ham','cod','tilapia','fish','meat','prosciutto','deli']},
      {name:'Aisle 4 ‚Äì Bread & Bakery',keywords:['bread','bagel','muffin','croissant','bun','roll','tortilla','pita','sourdough','baguette','wrap','english muffin','loaf','brioche']},
      {name:'Aisle 5 ‚Äì Pantry',        keywords:['pasta','rice','flour','sugar','salt','olive oil','oil','vinegar','sauce','soup','beans','lentil','quinoa','oats','cereal','granola','honey','jam','peanut butter','crackers','chips','nuts','almonds','cashews','broth','stock','baking soda','baking powder','vanilla','cocoa','chocolate','canned']},
      {name:'Aisle 6 ‚Äì Beverages',     keywords:['water','juice','soda','coffee','tea','wine','beer','sparkling','kombucha','almond milk','oat milk','soy milk','lemonade','cider','espresso','matcha']},
      {name:'Aisle 7 ‚Äì Frozen',        keywords:['frozen','ice cream','pizza','edamame','peas','corn','veggie burger','french fries','waffles','sorbet','gelato','burritos']},
      {name:'Aisle 8 ‚Äì Personal Care', keywords:['shampoo','conditioner','soap','lotion','toothpaste','toothbrush','deodorant','razors','sunscreen','vitamins','supplements','medicine','floss','mouthwash','moisturizer']},
    ],
    list: [], corrections: {}
  };
  await setDoc(doc(db, 'stores', id), demo);
  state.stores = [{...demo, id, isShared: false}];
  state.lists[id] = [];
  state.corrections[id] = {};
  state.activeStoreId = id;
  renderAll();
  setSyncDot('ok');

  // subscribe
  window._storeUnsubs.push(
    window._fb.onSnapshot(window._fb.doc(db, 'stores', id), (d) => {
      if (!d.exists()) return;
      const data = d.data();
      const idx = state.stores.findIndex(s => s.id === d.id);
      if (idx !== -1) {
        state.stores[idx] = { ...state.stores[idx], name: data.name, color: data.color,
          aisles: data.aisles || [], members: data.members || [], shareCode: data.shareCode || null };
        state.lists[d.id]       = data.list        || [];
        state.corrections[d.id] = data.corrections || {};
        renderAll();
      }
    })
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE TO FIRESTORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.persistStore = async function(storeId) {
  if (!window._currentUser) return;
  const { db, doc, updateDoc } = window._fb;
  const store = state.stores.find(s => s.id === storeId);
  if (!store) return;
  setSyncDot('syncing');
  try {
    await updateDoc(doc(db, 'stores', storeId), {
      name: store.name, color: store.color, aisles: store.aisles,
      list: state.lists[storeId] || [],
      corrections: state.corrections[storeId] || {}
    });
    setSyncDot('ok');
  } catch(e) {
    console.error('Sync error', e);
    setSyncDot('error');
  }
};

window.createStoreInFirestore = async function(storeData) {
  if (!window._currentUser) return storeData.id;
  const { db, doc, setDoc, serverTimestamp, onSnapshot } = window._fb;
  const uid = window._currentUser.uid;
  setSyncDot('syncing');
  await setDoc(doc(db, 'stores', storeData.id), {
    ownerUid: uid, members: [], shareCode: null,
    name: storeData.name, color: storeData.color, aisles: storeData.aisles,
    list: [], corrections: {}, createdAt: serverTimestamp()
  });
  setSyncDot('ok');
  // subscribe
  window._storeUnsubs.push(
    onSnapshot(doc(db, 'stores', storeData.id), (d) => {
      if (!d.exists()) return;
      const data = d.data();
      const idx = state.stores.findIndex(s => s.id === d.id);
      if (idx !== -1) {
        state.stores[idx] = { ...state.stores[idx], name: data.name, color: data.color,
          aisles: data.aisles || [], members: data.members || [], shareCode: data.shareCode || null };
        state.lists[d.id]       = data.list        || [];
        state.corrections[d.id] = data.corrections || {};
        renderAll();
      }
    })
  );
  return storeData.id;
};

window.deleteStoreFromFirestore = async function(storeId) {
  if (!window._currentUser) return;
  const { db, doc, deleteDoc } = window._fb;
  await deleteDoc(doc(db, 'stores', storeId));
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARE STORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.generateShareCode = async function(storeId) {
  if (!window._currentUser) return;
  const { db, doc, updateDoc } = window._fb;
  // Generate a random 6-char code ‚Äî collision probability is negligible
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const code = Array.from({length:6}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
  await updateDoc(doc(db, 'stores', storeId), { shareCode: code });
  const idx = state.stores.findIndex(s => s.id === storeId);
  if (idx !== -1) state.stores[idx].shareCode = code;
  return code;
};

window.openShareStoreModal = async function(storeId) {
  const store = state.stores.find(s => s.id === storeId);
  if (!store) return;
  let code = store.shareCode;
  if (!code) {
    showProcessing('Generating share code‚Ä¶');
    code = await window.generateShareCode(storeId);
    hideProcessing();
  }
  document.getElementById('share-code-display').textContent = code;
  document.getElementById('share-code-display').dataset.storeId = storeId;
  openModal('modal-share-store');
};

window.copyShareCode = function() {
  const code = document.getElementById('share-code-display').textContent;
  navigator.clipboard.writeText(code).then(() => showToast('Code copied ‚úì')).catch(()=>{
    showToast('Code: ' + code);
  });
};

window.joinStoreByCode = async function() {
  if (!window._currentUser) return;
  const { db, collection, query, where, getDocs, doc, updateDoc, arrayUnion, onSnapshot } = window._fb;
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  if (code.length < 4) { showToast('Enter a valid code'); return; }
  showProcessing('Looking up store‚Ä¶');
  try {
    const q = query(collection(db,'stores'), where('shareCode','==',code));
    const snap = await getDocs(q);
    if (snap.empty) { hideProcessing(); showToast('No store found with that code'); return; }
    const storeDoc = snap.docs[0];
    const uid = window._currentUser.uid;
    if (storeDoc.data().ownerUid === uid || (storeDoc.data().members||[]).includes(uid)) {
      hideProcessing(); showToast('You already have access to this store'); return;
    }
    await updateDoc(doc(db,'stores',storeDoc.id), { members: arrayUnion(uid) });
    // subscribe and load
    const data = storeDoc.data();
    state.stores.push({
      id: storeDoc.id, name: data.name, color: data.color, aisles: data.aisles||[],
      ownerUid: data.ownerUid, members: [...(data.members||[]), uid],
      shareCode: data.shareCode, isShared: true
    });
    state.lists[storeDoc.id]       = data.list        || [];
    state.corrections[storeDoc.id] = data.corrections || {};
    if (!state.activeStoreId) state.activeStoreId = storeDoc.id;
    window._storeUnsubs.push(
      onSnapshot(doc(db,'stores',storeDoc.id), (d) => {
        if (!d.exists()) return;
        const dd = d.data();
        const idx = state.stores.findIndex(s => s.id === d.id);
        if (idx !== -1) {
          state.stores[idx] = { ...state.stores[idx], name: dd.name, color: dd.color,
            aisles: dd.aisles||[], members: dd.members||[], shareCode: dd.shareCode||null };
          state.lists[d.id]       = dd.list        || [];
          state.corrections[d.id] = dd.corrections || {};
          renderAll();
        }
      })
    );
    renderAll();
    hideProcessing();
    closeModal('modal-profile');
    document.getElementById('join-code-input').value = '';
    showToast(`Joined "${data.name}" ‚úì`);
  } catch(e) {
    hideProcessing();
    console.error(e);
    showToast('Could not join store ‚Äî try again');
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH ACTIONS (exposed globally)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.signInEmail = async function() {
  const { auth, signInWithEmailAndPassword } = window._fb;
  const email = document.getElementById('signin-email').value.trim();
  const pass  = document.getElementById('signin-password').value;
  const errEl = document.getElementById('auth-error-signin');
  errEl.classList.remove('show');
  if (!email || !pass) { showAuthError('signin','Please fill in all fields'); return; }
  document.getElementById('btn-signin').disabled = true;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    showAuthError('signin', friendlyAuthError(e.code));
  }
  document.getElementById('btn-signin').disabled = false;
};

window.signUpEmail = async function() {
  const { auth, createUserWithEmailAndPassword, updateProfile } = window._fb;
  const name  = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const pass  = document.getElementById('signup-password').value;
  if (!name || !email || !pass) { showAuthError('signup','Please fill in all fields'); return; }
  if (pass.length < 6) { showAuthError('signup','Password must be at least 6 characters'); return; }
  document.getElementById('btn-signup').disabled = true;
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name });
  } catch(e) {
    showAuthError('signup', friendlyAuthError(e.code));
  }
  document.getElementById('btn-signup').disabled = false;
};

window.signInGoogle = async function() {
  const { auth, GoogleAuthProvider, signInWithPopup } = window._fb;
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  } catch(e) {
    if (e.code !== 'auth/popup-closed-by-user') {
      showAuthError('signin', friendlyAuthError(e.code));
    }
  }
};

window.signOut = async function() {
  const { auth, fbSignOut } = window._fb;
  await fbSignOut(auth);
  // Reset state
  state.stores=[]; state.lists={}; state.corrections={};
  state.activeStoreId=null;
  closeModal('modal-profile');
  renderAll();
};

// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ
function showAuthError(panel, msg) {
  const el = document.getElementById('auth-error-' + panel);
  el.textContent = msg;
  el.classList.add('show');
}

function friendlyAuthError(code) {
  const map = {
    'auth/user-not-found':'No account found with that email.',
    'auth/wrong-password':'Incorrect password.',
    'auth/email-already-in-use':'An account with this email already exists.',
    'auth/invalid-email':'Please enter a valid email address.',
    'auth/weak-password':'Password is too weak ‚Äî use at least 6 characters.',
    'auth/invalid-credential':'Invalid email or password.',
    'auth/too-many-requests':'Too many attempts. Please wait and try again.',
    'auth/network-request-failed':'Network error. Check your connection.',
  };
  return map[code] || 'Something went wrong. Please try again.';
}

// ‚îÄ‚îÄ sync dot UI ‚îÄ‚îÄ
function setSyncDot(status) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (status === 'syncing' ? ' syncing' : status === 'error' ? ' error' : '');
  dot.title = status === 'syncing' ? 'Syncing‚Ä¶' : status === 'error' ? 'Sync error' : 'Synced';
}
window.setSyncDot = setSyncDot;

// Signal that the Firebase module is fully loaded
window._fbReady = true;

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AISLE_COLORS = ['#4ade80','#60a5fa','#f472b6','#fb923c','#a78bfa','#34d399','#e879f9','#facc15','#f87171','#22d3ee'];
const STORE_COLORS = ['#4ade80','#60a5fa','#f472b6','#fb923c','#a78bfa','#34d399','#facc15','#f87171'];

// ‚îÄ‚îÄ Cloud Function region ‚Äî update this if you deploy to a different region ‚îÄ‚îÄ
// Find your region in Firebase Console ‚Üí Functions ‚Üí copy from the URL
const FIREBASE_REGION = 'us-central1';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  stores: [], activeStoreId: null,
  lists: {},
  corrections: {},
  editingStoreId: null,
};
let tempAisles = [];
let tempColor = STORE_COLORS[0];
let moveItemIndex = null;

// drag state
let dragSrcIdx = null, dragSrcAisle = null;
let touchClone = null, touchSrcIdx = null, touchSrcAisle = null;
let touchOffX = 0, touchOffY = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  ['signin','signup'].forEach(t => {
    document.getElementById('auth-panel-'+t)?.classList.toggle('active', t===tab);
  });
  document.querySelectorAll('.auth-tab').forEach((b,i)=>{
    b.classList.toggle('active', (i===0&&tab==='signin')||(i===1&&tab==='signup'));
  });
}

// Safe callers ‚Äî wait for Firebase module to be ready before delegating
function signInEmail()  { if(window._fbReady) window.signInEmail();  else showToast('Loading‚Ä¶ please try again'); }
function signUpEmail()  { if(window._fbReady) window.signUpEmail();  else showToast('Loading‚Ä¶ please try again'); }
function signInGoogle() { if(window._fbReady) window.signInGoogle(); else showToast('Loading‚Ä¶ please try again'); }
function signOut()      { if(window._fbReady) window.signOut();      else showToast('Loading‚Ä¶ please try again'); }
function joinStoreByCode()          { if(window._fbReady) window.joinStoreByCode();          else showToast('Loading‚Ä¶'); }
function openShareStoreModal(id)    { if(window._fbReady) window.openShareStoreModal(id);    else showToast('Loading‚Ä¶'); }
function copyShareCode()            { if(window._fbReady) window.copyShareCode();            else showToast('Loading‚Ä¶'); }

function openProfileModal() {
  // Pre-fill API key input if already saved
  const saved = localStorage.getItem('_anthropicKey');
  if (saved) {
    document.getElementById('api-key-input').value = saved;
    window._anthropicKey = saved;
  }
  openModal('modal-profile');
}

function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) { showToast('Please enter an API key'); return; }
  if (!key.startsWith('sk-ant-')) { showToast('Key should start with sk-ant-‚Ä¶'); return; }
  localStorage.setItem('_anthropicKey', key);
  window._anthropicKey = key;
  showToast('API key saved ‚úì');
  closeModal('modal-profile');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function boot() {
  // Load saved API key
  const savedKey = localStorage.getItem('_anthropicKey');
  if (savedKey) window._anthropicKey = savedKey;
  // Firebase module handles data loading on auth state change
  renderAll();
}

// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchScreen(name) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){ renderTopbar(); renderListScreen(); renderStoresScreen(); }

function renderTopbar(){
  const s=getActiveStore();
  document.getElementById('active-store-name').textContent = s?s.name:'No store';
  document.getElementById('active-store-dot').style.background = s?s.color:'#555';
}

function renderListScreen(){
  const cont=document.getElementById('list-content');
  const store=getActiveStore();
  if(!store){ cont.innerHTML=`<div class="empty"><div class="empty-icon">üè™</div><div class="empty-title">No store selected</div><div class="empty-sub">Go to Stores and add your first store.</div></div>`; return; }
  const items=state.lists[store.id]||[];
  if(!items.length){ cont.innerHTML=`<div class="empty"><div class="empty-icon">üõí</div><div class="empty-title">Your list is empty</div><div class="empty-sub">Tap <strong>Ôºã</strong> to add items or paste a shopping list.</div></div>`; return; }

  // group
  const groups={};
  items.forEach((item,idx)=>{
    const key=(item.aisleIndex!==null&&item.aisleIndex!==undefined)?item.aisleIndex:'unmatched';
    if(!groups[key]) groups[key]=[];
    groups[key].push({...item,idx});
  });
  const keys=Object.keys(groups).filter(k=>k!=='unmatched').sort((a,b)=>+a-+b);
  if(groups['unmatched']) keys.push('unmatched');

  const total=items.length, done=items.filter(i=>i.checked).length;
  let html=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
    <div style="font-size:.75rem;color:var(--muted)">${done}/${total} items ‚úì</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-sm btn-ghost" onclick="clearChecked()">Clear checked</button>
      <button class="btn btn-sm btn-danger" onclick="clearList()">Clear all</button>
    </div>
  </div>`;

  keys.forEach(key=>{
    const gItems=groups[key];
    const isUM=key==='unmatched';
    const color=isUM?'#fbbf24':AISLE_COLORS[+key%AISLE_COLORS.length];
    const aisle=!isUM?store.aisles[+key]:null;
    const aisleName=isUM?'? Unmatched Items':(aisle?aisle.name:`Aisle ${+key+1}`);
    const unchecked=gItems.filter(i=>!i.checked).length;

    html+=`<div class="aisle-group">
      <div class="aisle-group-header" style="background:${hexRgba(color,.12)};color:${color}">
        ${isUM?'‚ö†':'üõí'} ${esc(aisleName)}
        <span class="aisle-count">${unchecked} left</span>
      </div>
      <div class="items-container" data-aisle-key="${key}">`;

    gItems.forEach(item=>{
      const bgBadge=hexRgba(color,.18);
      const aiDot=item.aiClassified?`<span class="ai-dot" title="Classified by Claude">‚ú¶</span>`:'';
      html+=`<div class="list-item ${item.checked?'checked':''}"
          data-item-idx="${item.idx}" data-aisle-key="${key}"
          draggable="true"
          ondragstart="dStart(event,${item.idx},'${key}')"
          ondragend="dEnd(event)"
          ondragover="dOver(event)"
          ondrop="dDrop(event,${item.idx},'${key}')"
          ontouchstart="tStart(event,${item.idx},'${key}')"
          ontouchmove="tMove(event)"
          ontouchend="tEnd(event)">
        <div class="drag-handle" title="Drag to reorder">‚†ø</div>
        <div class="item-check ${item.checked?'done':''}" onclick="toggleCheck(${item.idx})">
          ${item.checked?'<span style="font-size:.7rem;color:#0a1a12">‚úì</span>':''}
        </div>
        <div class="item-name">${esc(item.name)} ${aiDot}</div>
        <div class="item-aisle-badge" style="background:${bgBadge};color:${color}" onclick="openMoveItem(${item.idx})">
          ${isUM?'?':`A${+key+1}`}
        </div>
      </div>`;
    });

    // Drop zone at bottom of each aisle group
    html+=`<div class="drop-zone" data-aisle-key="${key}"
        ondragover="dzOver(event)" ondragleave="dzLeave(event)" ondrop="dzDrop(event,'${key}')"></div>`;
    html+=`</div></div>`;
  });

  cont.innerHTML=html;
}

function renderStoresScreen(){
  const cont=document.getElementById('stores-list');
  if(!state.stores.length){ cont.innerHTML=`<div class="empty"><div class="empty-icon">üè™</div><div class="empty-title">No stores yet</div><div class="empty-sub">Add your first store to get started.</div></div>`; return; }
  cont.innerHTML=state.stores.map(store=>{
    const ll=(state.lists[store.id]||[]).length;
    const cc=Object.keys(state.corrections[store.id]||{}).length;
    const isOwner=!window._currentUser||store.ownerUid===window._currentUser?.uid;
    const sharedBadge=store.isShared||store.shareCode?`<span class="shared-badge">üîó Shared</span>`:'';
    return `<div class="card">
      <div class="card-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:12px;height:12px;border-radius:50%;background:${store.color};flex-shrink:0"></div>
          <div>
            <div style="font-weight:600;font-size:.95rem;display:flex;align-items:center;gap:8px">${esc(store.name)} ${sharedBadge}</div>
            <div class="text-muted">${store.aisles.length} aisles ¬∑ ${ll} items ¬∑ ${cc} corrections</div>
          </div>
        </div>
        <div style="display:flex;gap:6px">
          ${isOwner?`<button class="btn btn-sm btn-ghost" onclick="window.openShareStoreModal('${store.id}')">üîó Share</button>`:''}
          ${isOwner?`<button class="btn btn-sm btn-ghost" onclick="editStore('${store.id}')">Edit</button>`:''}
          <button class="btn btn-sm btn-danger" onclick="deleteStore('${store.id}')">‚úï</button>
        </div>
      </div>
      ${state.activeStoreId===store.id
        ?'<div style="margin-top:10px;font-size:.65rem;color:var(--green);font-weight:600;letter-spacing:.08em;text-transform:uppercase">‚óè Active</div>'
        :`<button class="btn btn-sm btn-ghost" style="margin-top:10px" onclick="setActiveStore('${store.id}')">Set Active</button>`}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openStoreSwitch(){
  document.getElementById('store-switch-list').innerHTML=state.stores.map(s=>`
    <div class="card" style="cursor:pointer;border-color:${state.activeStoreId===s.id?s.color:'var(--border)'};margin-bottom:8px" onclick="setActiveStore('${s.id}')">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:10px;height:10px;border-radius:50%;background:${s.color};flex-shrink:0"></div>
        <span style="font-weight:${state.activeStoreId===s.id?'600':'400'}">${esc(s.name)}</span>
        ${state.activeStoreId===s.id?'<span style="margin-left:auto;color:var(--green);font-size:.75rem">Active</span>':''}
      </div>
    </div>`).join('')||'<p class="text-muted" style="text-align:center;padding:12px 0">No stores yet.</p>';
  openModal('modal-store-switch');
}

function setActiveStore(id){ state.activeStoreId=id; closeModal('modal-store-switch'); renderAll(); }

function openNewStore(){
  state.editingStoreId=null;
  pendingScannedKws={}; aisleImgTargetIdx=null;
  document.getElementById('store-modal-title').textContent='New Store';
  document.getElementById('store-name-input').value='';
  tempColor=STORE_COLORS[state.stores.length%STORE_COLORS.length];
  tempAisles=[
    {name:'Aisle 1 ‚Äì Produce', keywords:['apple','banana','vegetable','fruit']},
    {name:'Aisle 2 ‚Äì Dairy',   keywords:['milk','cheese','yogurt','eggs']},
  ];
  renderStoreModal();
  openModal('modal-store');
}

function editStore(id){
  const store=state.stores.find(s=>s.id===id);
  pendingScannedKws={}; aisleImgTargetIdx=null;
  state.editingStoreId=id;
  document.getElementById('store-modal-title').textContent='Edit Store';
  document.getElementById('store-name-input').value=store.name;
  tempColor=store.color;
  tempAisles=store.aisles.map(a=>({name:a.name,keywords:[...a.keywords]}));
  renderStoreModal();
  openModal('modal-store');
}

function renderStoreModal(){
  document.getElementById('store-color-picker').innerHTML=STORE_COLORS.map(c=>
    `<div class="color-opt ${c===tempColor?'selected':''}" style="background:${c}" onclick="pickColor('${c}')"></div>`
  ).join('');
  renderAisleRows();
}

function pickColor(c){
  tempColor=c;
  document.getElementById('store-color-picker').innerHTML=STORE_COLORS.map(col=>
    `<div class="color-opt ${col===c?'selected':''}" style="background:${col}" onclick="pickColor('${col}')"></div>`
  ).join('');
}

// ‚îÄ‚îÄ AISLE ROWS with fixed chip deletion + bulk keyword upload + image scan ‚îÄ‚îÄ
let aisleImgTargetIdx = null; // which aisle is currently being scanned
let pendingScannedKws = {};   // aisleIdx -> [keywords] from scan, awaiting accept

function renderAisleRows(){
  document.getElementById('aisle-rows').innerHTML=tempAisles.map((aisle,i)=>{
    const color=AISLE_COLORS[i%AISLE_COLORS.length];
    const pending=pendingScannedKws[i];
    return `<div class="card" id="aisle-card-${i}" data-aisle-idx="${i}" style="border-left:3px solid ${color};padding:14px;margin-bottom:10px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div class="aisle-drag-handle" data-aisle-idx="${i}" title="Drag to reorder">‚†ø</div>
        <span style="font-size:.63rem;font-weight:700;color:${color};letter-spacing:.1em;text-transform:uppercase">AISLE ${i+1}</span>
        <div style="flex:1"></div>
        ${tempAisles.length>1?`<button class="btn btn-sm btn-danger" onclick="removeAisle(${i})">‚úï</button>`:''}
      </div>
      <input class="input" id="aisle-name-${i}" value="${esc(aisle.name)}"
        placeholder="e.g. Produce" style="font-size:.82rem;padding:8px 12px;margin-bottom:12px">
      <div style="font-size:.63rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;font-weight:600">Keywords</div>
      <div class="chips" id="chips-${i}" data-aisle="${i}">${renderChips(i)}</div>
      <div class="kw-section">
        <div class="kw-tabs">
          <button class="kw-tab active" id="tab-one-${i}" onclick="switchKwTab(${i},'one')">Add one</button>
          <button class="kw-tab" id="tab-bulk-${i}" onclick="switchKwTab(${i},'bulk')">Paste list</button>
          <button class="kw-tab" id="tab-scan-${i}" onclick="switchKwTab(${i},'scan')">üì∑ Scan photo</button>
        </div>
        <div class="kw-panel active" id="panel-one-${i}">
          <div class="kw-add-row">
            <input class="kw-input" id="kw-${i}" placeholder="e.g. frozen peas‚Ä¶"
              onkeydown="if(event.key==='Enter'){event.preventDefault();addKw(${i});}">
            <button class="kw-add-btn" onclick="addKw(${i})">Add</button>
          </div>
        </div>
        <div class="kw-panel" id="panel-bulk-${i}">
          <textarea class="kw-bulk" id="kw-bulk-${i}"
            placeholder="Paste keywords separated by commas or line breaks:&#10;brown eggs, 2% milk&#10;instant ramen"></textarea>
          <button class="kw-bulk-btn" onclick="addBulkKw(${i})">+ Add all keywords</button>
        </div>
        <div class="kw-panel" id="panel-scan-${i}">
          <div class="aisle-img-zone" id="scan-zone-${i}" onclick="triggerAisleScan(${i})">
            <div style="font-size:1.4rem;margin-bottom:6px">üì∏</div>
            <div style="font-size:.75rem;font-weight:600;margin-bottom:3px">Take or upload an aisle photo</div>
            <div style="font-size:.68rem">Claude will identify what's on the shelves and add keywords automatically</div>
          </div>
          ${pending ? renderScanResult(i, pending) : ''}
        </div>
      </div>
    </div>`;
  }).join('');

  // Event-delegated chip deletion
  document.querySelectorAll('.chips[data-aisle]').forEach(container=>{
    container.addEventListener('click', e=>{
      const x=e.target.closest('.chip-x');
      if(!x) return;
      const chip=x.closest('.chip');
      const kw=chip?.dataset.kw;
      const ai=parseInt(container.dataset.aisle,10);
      if(kw!==undefined && !isNaN(ai)) removeKw(ai,kw);
    });
  });

  // Wire up aisle drag-to-reorder
  initAisleDrag();
}

function renderChips(i){
  return tempAisles[i].keywords.map(k=>
    `<div class="chip" data-kw="${esc(k)}">${esc(k)}<span class="chip-x" title="Remove">√ó</span></div>`
  ).join('');
}

function refreshChips(i){
  const el=document.getElementById('chips-'+i);
  if(!el) return;
  el.innerHTML=renderChips(i);
}

function switchKwTab(i, tab){
  ['one','bulk','scan'].forEach(t=>{
    document.getElementById('tab-'+t+'-'+i)?.classList.toggle('active', t===tab);
    document.getElementById('panel-'+t+'-'+i)?.classList.toggle('active', t===tab);
  });
  if(tab==='one') document.getElementById('kw-'+i)?.focus();
  else if(tab==='bulk') document.getElementById('kw-bulk-'+i)?.focus();
}

function addKw(i){
  const inp=document.getElementById('kw-'+i);
  if(!inp) return;
  const val=inp.value.trim().toLowerCase();
  if(!val){ inp.focus(); return; }
  if(!tempAisles[i].keywords.includes(val)) tempAisles[i].keywords.push(val);
  inp.value='';
  refreshChips(i);
  inp.focus();
}

function addBulkKw(i){
  const ta=document.getElementById('kw-bulk-'+i);
  if(!ta) return;
  // Split on commas OR newlines only ‚Äî preserves spaces within keywords
  const vals=ta.value.split(/[,\n]+/).map(v=>v.trim().toLowerCase()).filter(Boolean);
  let added=0;
  vals.forEach(v=>{ if(v && !tempAisles[i].keywords.includes(v)){ tempAisles[i].keywords.push(v); added++; } });
  ta.value='';
  refreshChips(i);
  showToast(`${added} keyword${added!==1?'s':''} added`);
}

function removeKw(i,kw){
  tempAisles[i].keywords=tempAisles[i].keywords.filter(k=>k!==kw);
  refreshChips(i);
}

// ‚îÄ‚îÄ AISLE IMAGE SCANNING ‚îÄ‚îÄ

function triggerAisleScan(i){
  syncNames();
  aisleImgTargetIdx=i;
  const inp=document.getElementById('aisle-img-input');
  inp.value='';
  inp.click();
}

async function handleAisleImageUpload(e){
  const f=e.target.files[0]; if(!f) return;
  e.target.value='';
  const i=aisleImgTargetIdx;
  if(i===null||i===undefined) return;

  // Show image preview + spinner in scan zone
  const zone=document.getElementById('scan-zone-'+i);
  if(!zone) return;

  const dataUrl=await fileToDataUrl(f);
  const b64=dataUrl.split(',')[1];
  const mime=f.type||'image/jpeg';

  zone.classList.add('scanning');
  zone.innerHTML=`
    <img class="aisle-img-thumb" src="${dataUrl}" alt="Aisle photo">
    <div class="aisle-img-spinner"></div>
    <div style="font-size:.7rem;color:var(--blue)">Scanning shelves with Claude‚Ä¶</div>`;

  try {
    const keywords=await scanAisleImage(b64, mime);
    pendingScannedKws[i]=keywords;
    zone.classList.remove('scanning');
    zone.classList.add('has-preview');
    zone.onclick=null; // disable re-trigger while result showing

    // Show preview + result row below zone
    zone.innerHTML=`<img class="aisle-img-thumb" src="${dataUrl}" alt="Aisle photo">
      <div style="font-size:.68rem;color:var(--muted);margin-top:4px">
        Found <strong style="color:var(--green)">${keywords.length}</strong> items ‚Äî review below before adding
      </div>`;

    // Re-render result row in panel
    const panel=document.getElementById('panel-scan-'+i);
    if(panel){
      // Remove old result row if present, then append new one
      panel.querySelector('.scan-result-row')?.remove();
      panel.insertAdjacentHTML('beforeend', renderScanResult(i, keywords));
    }
  } catch(err){
    console.error(err);
    zone.classList.remove('scanning');
    zone.innerHTML=`<div style="font-size:1.4rem;margin-bottom:6px">‚ö†Ô∏è</div>
      <div style="font-size:.75rem;color:var(--red)">Scan failed ‚Äî tap to try again</div>`;
    zone.onclick=()=>triggerAisleScan(i);
    showToast('Could not read image');
  }
}

function renderScanResult(i, keywords){
  if(!keywords||!keywords.length) return `<div style="font-size:.7rem;color:var(--muted);text-align:center;margin-top:8px">No items detected ‚Äî try a clearer photo</div>`;
  // Show first few as a preview list, then accept/discard buttons
  const preview=keywords.slice(0,8).map(k=>`<span style="font-size:.68rem;color:var(--text)">${esc(k)}</span>`).join(', ')
    +(keywords.length>8?` <span style="color:var(--muted)">+${keywords.length-8} more</span>`:'');
  return `<div class="scan-result-row">
    <div>
      <div class="scan-result-label" style="margin-bottom:4px">‚ú¶ Detected: ${preview}</div>
    </div>
  </div>
  <div style="display:flex;gap:6px;margin-top:8px">
    <button class="scan-accept-btn" style="flex:1" onclick="acceptScanKws(${i})">‚úì Add ${keywords.length} keyword${keywords.length!==1?'s':''}</button>
    <button class="scan-discard-btn" onclick="discardScan(${i})">Discard</button>
  </div>`;
}

function acceptScanKws(i){
  const kws=pendingScannedKws[i]||[];
  let added=0;
  kws.forEach(k=>{ if(!tempAisles[i].keywords.includes(k)){ tempAisles[i].keywords.push(k); added++; } });
  delete pendingScannedKws[i];
  // Reset scan zone, re-render chips, switch to 'one' tab
  refreshChips(i);
  const panel=document.getElementById('panel-scan-'+i);
  const zone=document.getElementById('scan-zone-'+i);
  if(zone){
    zone.classList.remove('has-preview','scanning');
    zone.onclick=()=>triggerAisleScan(i);
    zone.innerHTML=`<div style="font-size:1.4rem;margin-bottom:6px">üì∏</div>
      <div style="font-size:.75rem;font-weight:600;margin-bottom:3px">Take or upload an aisle photo</div>
      <div style="font-size:.68rem">Claude will identify what's on the shelves and add keywords automatically</div>`;
  }
  if(panel) panel.querySelectorAll('.scan-result-row,.scan-accept-btn,.scan-discard-btn').forEach(el=>el.remove());
  showToast(`${added} keyword${added!==1?'s':''} added from photo ‚úì`);
  switchKwTab(i,'one');
}

function discardScan(i){
  delete pendingScannedKws[i];
  const zone=document.getElementById('scan-zone-'+i);
  if(zone){
    zone.classList.remove('has-preview','scanning');
    zone.onclick=()=>triggerAisleScan(i);
    zone.innerHTML=`<div style="font-size:1.4rem;margin-bottom:6px">üì∏</div>
      <div style="font-size:.75rem;font-weight:600;margin-bottom:3px">Take or upload an aisle photo</div>
      <div style="font-size:.68rem">Claude will identify what's on the shelves and add keywords automatically</div>`;
  }
  const panel=document.getElementById('panel-scan-'+i);
  if(panel){
    panel.querySelectorAll('.scan-result-row,.scan-accept-btn,.scan-discard-btn').forEach(el=>el.remove());
  }
}

async function scanAisleImage(b64, mime){
  const apiKey = window._anthropicKey;
  if(!apiKey){ showToast('Add your Anthropic API key in Settings'); return []; }
  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body:JSON.stringify({
      model:'claude-haiku-4-5-20251001',
      max_tokens:1000,
      messages:[{
        role:'user',
        content:[
          {type:'image', source:{type:'base64', media_type:mime, data:b64}},
          {type:'text', text:`This is a photo of a grocery store aisle or shelf section. 
Identify every distinct product category, product type, or item you can see on the shelves.
Return ONLY a JSON array of short lowercase keyword strings (1‚Äì4 words each) suitable for matching shopping list items to this aisle.
Be specific and comprehensive ‚Äî include brand-agnostic product names.
No markdown, no explanation, just the JSON array:
["whole milk","2% milk","oat milk","greek yogurt","butter","cream cheese","cheddar","eggs"]`}
        ]
      }]
    })
  });
  if(!res.ok) throw new Error(`API ${res.status}`);
  const data=await res.json();
  const text=data.content.map(c=>c.text||'').join('').trim()
    .replace(/^```json?\s*/i,'').replace(/```\s*$/i,'').trim();
  const parsed=JSON.parse(text);
  return Array.isArray(parsed) ? parsed.map(k=>String(k).toLowerCase().trim()).filter(Boolean) : [];
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=e=>resolve(e.target.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

function addAisleRow(){
  syncNames(); // persist typed names before re-render
  tempAisles.push({name:`Aisle ${tempAisles.length+1}`,keywords:[]});
  renderAisleRows();
  // scroll modal to bottom to reveal new aisle
  const modal=document.querySelector('#modal-store .modal');
  if(modal) setTimeout(()=>{ modal.scrollTop=modal.scrollHeight; },50);
}

function removeAisle(i){ syncNames(); tempAisles.splice(i,1); renumberAisleNames(); renderAisleRows(); }

function syncNames(){
  tempAisles.forEach((_,i)=>{
    const el=document.getElementById('aisle-name-'+i);
    if(el) tempAisles[i].name=el.value;
  });
}

// ‚îÄ‚îÄ AISLE DRAG-TO-REORDER (pointer events ‚Äî works inside scrolling modals) ‚îÄ‚îÄ
function initAisleDrag(){
  const handles=document.querySelectorAll('.aisle-drag-handle');
  handles.forEach(handle=>{
    handle.addEventListener('pointerdown', onAisleDragStart, {passive:false});
  });
}

let aisleGhost=null, aisleDragSrcIdx=null, aislePointerStartY=0, aisleScrollStart=0;

function onAisleDragStart(e){
  if(e.button!==undefined && e.button!==0) return; // left-click / touch only
  e.preventDefault();
  syncNames(); // save typed values before we reorder

  const handle=e.currentTarget;
  aisleDragSrcIdx=parseInt(handle.dataset.aisleIdx,10);
  const srcCard=document.getElementById('aisle-card-'+aisleDragSrcIdx);
  if(!srcCard) return;

  const modal=document.querySelector('#modal-store .modal');
  const cardRect=srcCard.getBoundingClientRect();
  const modalRect=modal ? modal.getBoundingClientRect() : {top:0,left:0};

  aislePointerStartY=e.clientY;
  aisleScrollStart=modal ? modal.scrollTop : 0;

  // Create ghost clone
  aisleGhost=srcCard.cloneNode(true);
  Object.assign(aisleGhost.style,{
    position:'fixed',
    top: cardRect.top+'px',
    left: cardRect.left+'px',
    width: cardRect.width+'px',
    zIndex: '500',
    opacity: '0.85',
    pointerEvents: 'none',
    boxShadow: '0 8px 32px rgba(0,0,0,.45)',
    border: '2px solid var(--green)',
    borderRadius: '14px',
    transition: 'none',
    margin: '0',
  });
  document.body.appendChild(aisleGhost);

  srcCard.classList.add('aisle-card-dragging');
  handle.classList.add('grabbing');

  document.addEventListener('pointermove', onAisleDragMove, {passive:false});
  document.addEventListener('pointerup',   onAisleDragEnd,  {passive:false});
  document.addEventListener('pointercancel', onAisleDragEnd,{passive:false});
}

function onAisleDragMove(e){
  if(!aisleGhost) return;
  e.preventDefault();

  const dy=e.clientY - aislePointerStartY;
  const modal=document.querySelector('#modal-store .modal');
  const scrollDy=modal ? modal.scrollTop - aisleScrollStart : 0;
  const srcCard=document.getElementById('aisle-card-'+aisleDragSrcIdx);
  if(!srcCard) return;

  const srcRect=srcCard.getBoundingClientRect();
  aisleGhost.style.top = (srcRect.top + dy + scrollDy) + 'px';

  // Find which card the ghost centre is hovering over
  const ghostCY=e.clientY;
  document.querySelectorAll('.card[data-aisle-idx]').forEach(card=>{
    const idx=parseInt(card.dataset.aisleIdx,10);
    card.classList.remove('aisle-card-dragover');
    if(idx===aisleDragSrcIdx) return;
    const r=card.getBoundingClientRect();
    if(ghostCY >= r.top && ghostCY <= r.bottom){
      card.classList.add('aisle-card-dragover');
    }
  });
}

function onAisleDragEnd(e){
  if(!aisleGhost) return;
  document.removeEventListener('pointermove', onAisleDragMove);
  document.removeEventListener('pointerup',   onAisleDragEnd);
  document.removeEventListener('pointercancel', onAisleDragEnd);

  // Find drop target
  let targetIdx=null;
  document.querySelectorAll('.card[data-aisle-idx]').forEach(card=>{
    if(card.classList.contains('aisle-card-dragover')){
      targetIdx=parseInt(card.dataset.aisleIdx,10);
    }
    card.classList.remove('aisle-card-dragover','aisle-card-dragging');
  });

  aisleGhost.remove(); aisleGhost=null;
  document.querySelectorAll('.aisle-drag-handle').forEach(h=>h.classList.remove('grabbing'));

  if(targetIdx!==null && targetIdx!==aisleDragSrcIdx){
    // Reorder tempAisles
    const moved=tempAisles.splice(aisleDragSrcIdx,1)[0];
    tempAisles.splice(targetIdx,0,moved);

    // Also reorder pendingScannedKws by the same move
    const newPending={};
    Object.keys(pendingScannedKws).forEach(k=>{
      const oldIdx=parseInt(k,10);
      let newIdx=oldIdx;
      if(oldIdx===aisleDragSrcIdx){ newIdx=targetIdx; }
      else if(aisleDragSrcIdx<targetIdx && oldIdx>aisleDragSrcIdx && oldIdx<=targetIdx){ newIdx=oldIdx-1; }
      else if(aisleDragSrcIdx>targetIdx && oldIdx>=targetIdx && oldIdx<aisleDragSrcIdx){ newIdx=oldIdx+1; }
      newPending[newIdx]=pendingScannedKws[k];
    });
    pendingScannedKws=newPending;

    renumberAisleNames();
    renderAisleRows();
  }

  aisleDragSrcIdx=null;
}

// Auto-renumber aisle names that match the pattern "Aisle N" or "Aisle N ‚Äì ‚Ä¶"
// so moving Aisle 3 to position 1 renames it to Aisle 1, shifting others up.
function renumberAisleNames(){
  tempAisles.forEach((aisle,i)=>{
    // Match "Aisle <number>" optionally followed by " ‚Äì rest of name"
    const m=aisle.name.match(/^Aisle\s+\d+(\s*[‚Äì-]\s*.*)?$/i);
    if(m){
      const suffix=m[1]||'';
      aisle.name=`Aisle ${i+1}${suffix}`;
    }
  });
}

async function saveStore(){
  syncNames();
  const name=document.getElementById('store-name-input').value.trim();
  if(!name){ showToast('Please enter a store name'); return; }
  if(!tempAisles.length){ showToast('Add at least one aisle'); return; }
  const aisles=tempAisles.map(a=>({name:a.name,keywords:[...a.keywords]}));

  if(state.editingStoreId){
    const store=state.stores.find(s=>s.id===state.editingStoreId);
    store.name=name; store.color=tempColor; store.aisles=aisles;
    if(state.lists[store.id]?.length){
      state.lists[store.id]=state.lists[store.id].map(item=>({
        ...item, aisleIndex: rematch(item.name,store)
      }));
    }
    if(window.persistStore) await window.persistStore(store.id);
  } else {
    const id='store-'+Date.now();
    const newStore={id,name,color:tempColor,aisles,ownerUid:window._currentUser?.uid,members:[],shareCode:null,isShared:false};
    state.stores.push(newStore);
    state.lists[id]=[]; state.corrections[id]={};
    if(!state.activeStoreId) state.activeStoreId=id;
    if(window.createStoreInFirestore) await window.createStoreInFirestore(newStore);
  }
  closeModal('modal-store'); renderAll(); showToast('Store saved ‚úì');
}

function rematch(itemName,store){
  const corr=state.corrections[store.id]||{};
  const norm=normalise(itemName);
  if(corr[norm]!==undefined) return corr[norm];
  return kwMatch(norm,store.aisles);
}

async function deleteStore(id){
  if(!confirm('Delete this store and its list?')) return;
  state.stores=state.stores.filter(s=>s.id!==id);
  delete state.lists[id]; delete state.corrections[id];
  if(state.activeStoreId===id) state.activeStoreId=state.stores[0]?.id||null;
  if(window.deleteStoreFromFirestore) await window.deleteStoreFromFirestore(id);
  renderAll(); showToast('Store deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIST ‚Äì AI MATCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddList(){
  if(!getActiveStore()){ showToast('Please select a store first'); switchScreen('stores'); return; }
  document.getElementById('list-text-input').value='';
  resetUploadZone();
  openModal('modal-add-list');
}

let uploadedImageB64 = null; // stores base64 of uploaded image for AI parsing
let uploadedImageType = null;

function handleFileUpload(e){
  const f=e.target.files[0]; if(!f) return;
  e.target.value='';
  const zone=document.getElementById('upload-zone');
  const iconEl=document.getElementById('upload-icon');
  const labelEl=document.getElementById('upload-label');

  // Detect if it's an image
  if(f.type.startsWith('image/')){
    const reader=new FileReader();
    reader.onload=ev=>{
      const dataUrl=ev.target.result;

      // Resize image to max 1024px on longest side before sending to API
      // This prevents "internal error" responses from Gemini on large phone photos
      const img = new Image();
      img.onload = () => {
        const MAX = 1024;
        let w = img.width, h = img.height;
        if (w > MAX || h > MAX) {
          if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
          else       { w = Math.round(w * MAX / h); h = MAX; }
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        const resized = canvas.toDataURL('image/jpeg', 0.85);
        uploadedImageB64 = resized.split(',')[1];
        uploadedImageType = 'image/jpeg';

        // Show preview
        zone.classList.add('has-image');
        zone.innerHTML=`<img class="img-preview" src="${resized}" alt="List preview">
          <p style="font-size:.7rem;color:var(--green);margin-top:8px">‚úì Image ready ‚Äî Gemini will read your handwriting</p>`;
      };
      img.src = dataUrl;
    };
    reader.readAsDataURL(f);
  } else {
    // Text / any other file ‚Äî read as text
    uploadedImageB64=null; uploadedImageType=null;
    const reader=new FileReader();
    reader.onload=ev=>{
      document.getElementById('list-text-input').value=ev.target.result;
      zone.classList.remove('has-image');
      zone.innerHTML=`<div class="upload-icon">‚úÖ</div><p style="font-size:.78rem">${esc(f.name)} loaded</p>`;
    };
    reader.onerror=()=>{ showToast('Could not read file'); };
    reader.readAsText(f);
  }
}

async function processListInput(){
  const store=getActiveStore();
  closeModal('modal-add-list');

  // ‚îÄ‚îÄ Image path ‚îÄ‚îÄ
  if(uploadedImageB64){
    showProcessing('Reading your list‚Ä¶');
    try {
      const names=await parseImageWithGemini(uploadedImageB64, uploadedImageType||'image/jpeg');
      uploadedImageB64=null; uploadedImageType=null;
      resetUploadZone();
      if(!names.length){ hideProcessing(); showToast('No items found ‚Äî try a clearer photo'); return; }
      showProcessing(`Found ${names.length} items ‚Äî sorting by aisle‚Ä¶`);
      const results=await classifyWithClaude(names,store);
      state.lists[store.id]=applyCorr(results,store);
      hideProcessing(); renderListScreen(); showToast(`${names.length} items from photo organised ‚úì`);
      persistActiveStore();
    } catch(err){
      hideProcessing(); console.error(err);
      showToast('Could not read image: ' + (err.message||'unknown error'));
    }
    return;
  }

  // ‚îÄ‚îÄ Text path ‚îÄ‚îÄ
  const raw=document.getElementById('list-text-input').value.trim();
  resetUploadZone();
  if(!raw){ showToast('Enter at least one item'); return; }
  const names=raw.split('\n').map(l=>l.replace(/^[-‚Ä¢*\d.)]+\s*/,'').trim()).filter(Boolean);
  if(!names.length){ showToast('No items found'); return; }
  showProcessing('Asking Claude to classify your items‚Ä¶');
  try {
    const results=await classifyWithClaude(names,store);
    state.lists[store.id]=applyCorr(results,store);
    hideProcessing(); renderListScreen(); showToast(`${names.length} items organised ‚úì`);
    persistActiveStore();
  } catch(err){
    hideProcessing(); console.error(err);
    state.lists[store.id]=applyCorr(
      names.map(name=>({name,aisleIndex:kwMatch(normalise(name),store.aisles),aiClassified:false,checked:false})),
      store
    );
    renderListScreen(); showToast('Used keyword matching (AI unavailable)');
    persistActiveStore();
  }
}

function resetUploadZone(){
  uploadedImageB64=null; uploadedImageType=null;
  const zone=document.getElementById('upload-zone');
  if(zone){
    zone.classList.remove('has-image');
    zone.innerHTML=`<div class="upload-icon" id="upload-icon">üìé</div>
      <p style="font-size:.78rem" id="upload-label">Tap to upload a file or photo of your list</p>`;
  }
}

async function parseImageWithGemini(b64, mimeType){
  // Get Firebase auth token to authenticate with our Cloud Function
  const user = window._currentUser;
  if(!user){ showToast('Please sign in first'); return []; }
  const token = await user.getIdToken();

  const res = await fetch(
    `https://${FIREBASE_REGION}-instaisle-e8d6b.cloudfunctions.net/parseShoppingList`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ imageBase64: b64, mimeType })
    }
  );
  if(!res.ok){
    const err = await res.json().catch(()=>({}));
    throw new Error(err?.error || `Server error ${res.status}`);
  }
  const data = await res.json();
  return Array.isArray(data.items) ? data.items.filter(Boolean) : [];
}

async function classifyWithClaude(items,store){
  const apiKey = window._anthropicKey;
  if(!apiKey){ showToast('Add your Anthropic API key in Settings'); return []; }
  const aisleDesc=store.aisles.map((a,i)=>
    `Aisle ${i} ‚Äî "${a.name}": ${a.keywords.slice(0,18).join(', ')}`
  ).join('\n');

  const prompt=`You are a grocery store assistant. Assign each item below to the most appropriate aisle.

Store layout:
${aisleDesc}

Items to classify (0-indexed):
${items.map((item,i)=>`${i}: ${item}`).join('\n')}

Reply ONLY with a valid JSON array, no markdown, no explanation:
[{"index":0,"aisleIndex":2},{"index":1,"aisleIndex":0}]

Rules:
- aisleIndex must be an integer 0‚Äì${store.aisles.length-1}
- Never use null ‚Äî always choose the most plausible aisle
- Base decisions on the aisle keywords and general grocery knowledge`;

  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body:JSON.stringify({
      model:'claude-opus-4-5',
      max_tokens:1000,
      messages:[{role:'user',content:prompt}]
    })
  });
  if(!res.ok) throw new Error(`API ${res.status}`);
  const data=await res.json();
  const text=data.content.map(c=>c.text||'').join('').trim()
    .replace(/^```json?\s*/i,'').replace(/```\s*$/i,'').trim();
  const parsed=JSON.parse(text);
  return parsed.map(r=>({
    name: items[r.index]??items[0],
    aisleIndex: Math.max(0,Math.min(store.aisles.length-1, +r.aisleIndex)),
    aiClassified: true,
    checked: false,
  }));
}

function applyCorr(items,store){
  const corr=state.corrections[store.id]||{};
  return items.map(item=>{
    const norm=normalise(item.name);
    if(corr[norm]!==undefined) return {...item,aisleIndex:corr[norm],aiClassified:false};
    return item;
  });
}

function kwMatch(norm,aisles){
  let best=0,bestIdx=null;
  aisles.forEach((a,i)=>{
    let sc=0; a.keywords.forEach(k=>{ if(norm.includes(k.toLowerCase())) sc+=k.length; });
    if(sc>best){ best=sc; bestIdx=i; }
  });
  return bestIdx;
}

function normalise(s){ return s.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ITEM ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCheck(idx){
  const store=getActiveStore();
  state.lists[store.id][idx].checked=!state.lists[store.id][idx].checked;
  renderListScreen();
  persistActiveStore();
}
function clearChecked(){
  const store=getActiveStore();
  state.lists[store.id]=state.lists[store.id].filter(i=>!i.checked);
  renderListScreen(); showToast('Checked items removed');
  persistActiveStore();
}
function clearList(){
  if(!confirm('Clear the entire list?')) return;
  state.lists[getActiveStore().id]=[];
  renderListScreen();
  persistActiveStore();
}

function openMoveItem(idx){
  const store=getActiveStore();
  const item=state.lists[store.id][idx];
  moveItemIndex=idx;
  document.getElementById('move-item-name').textContent=item.name;
  const opts=document.getElementById('move-aisle-options');
  opts.innerHTML=store.aisles.map((aisle,ai)=>{
    const color=AISLE_COLORS[ai%AISLE_COLORS.length];
    const isAct=item.aisleIndex===ai;
    return `<div class="card" style="cursor:pointer;border-color:${isAct?color:'var(--border)'};margin-bottom:8px" onclick="moveToAisle(${ai})">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0"></div>
        <span style="font-size:.85rem;font-weight:${isAct?'600':'400'}">${esc(aisle.name)}</span>
        ${isAct?`<span style="margin-left:auto;color:${color};font-size:.7rem">Current</span>`:''}
      </div>
    </div>`;
  }).join('');
  const isUM=item.aisleIndex===null||item.aisleIndex===undefined;
  opts.innerHTML+=`<div class="card" style="cursor:pointer;border-color:${isUM?'var(--amber)':'var(--border)'};margin-bottom:8px" onclick="moveToAisle(null)">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:8px;height:8px;border-radius:50%;background:var(--amber);flex-shrink:0"></div>
      <span style="font-size:.85rem;font-weight:${isUM?'600':'400'}">Unmatched</span>
    </div>
  </div>`;
  openModal('modal-move-item');
}

function moveToAisle(aisleIndex){
  const store=getActiveStore();
  const item=state.lists[store.id][moveItemIndex];
  const norm=normalise(item.name);
  if(!state.corrections[store.id]) state.corrections[store.id]={};
  if(aisleIndex===null) delete state.corrections[store.id][norm];
  else state.corrections[store.id][norm]=aisleIndex;
  item.aisleIndex=aisleIndex;
  closeModal('modal-move-item'); renderListScreen(); showToast('Correction saved ‚úì');
  persistActiveStore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG ‚Äî MOUSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dStart(e,idx,aisleKey){
  dragSrcIdx=idx; dragSrcAisle=aisleKey;
  e.dataTransfer.effectAllowed='move';
  setTimeout(()=>{
    const el=document.querySelector(`[data-item-idx="${idx}"]`);
    if(el) el.classList.add('dragging');
  },0);
}
function dEnd(e){
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('dragging','drag-over'));
  document.querySelectorAll('.drop-zone').forEach(el=>el.classList.remove('active'));
  dragSrcIdx=null; dragSrcAisle=null;
}
function dOver(e){
  e.preventDefault(); e.dataTransfer.dropEffect='move';
  if(+e.currentTarget.dataset.itemIdx!==dragSrcIdx) e.currentTarget.classList.add('drag-over');
}
function dDrop(e,targetIdx,targetAisleKey){
  e.preventDefault(); e.stopPropagation();
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('drag-over'));
  if(dragSrcIdx===null||dragSrcIdx===targetIdx) return;
  reorderItems(dragSrcIdx, targetIdx, targetAisleKey);
}
function dzOver(e){ e.preventDefault(); e.currentTarget.classList.add('active'); }
function dzLeave(e){ e.currentTarget.classList.remove('active'); }
function dzDrop(e,aisleKey){
  e.preventDefault(); e.currentTarget.classList.remove('active');
  if(dragSrcIdx===null) return;
  moveToEndOfAisle(dragSrcIdx, aisleKey);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG ‚Äî TOUCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tStart(e,idx,aisleKey){
  if(!e.target.classList.contains('drag-handle')&&!e.target.closest('.drag-handle')) return;
  e.preventDefault();
  const touch=e.touches[0];
  touchSrcIdx=idx; touchSrcAisle=aisleKey;
  const el=e.currentTarget;
  const rect=el.getBoundingClientRect();
  touchOffX=touch.clientX-rect.left; touchOffY=touch.clientY-rect.top;
  touchClone=el.cloneNode(true);
  Object.assign(touchClone.style,{
    position:'fixed',left:rect.left+'px',top:rect.top+'px',width:rect.width+'px',
    opacity:'0.82',zIndex:'999',border:'2px solid var(--green)',borderRadius:'10px',
    pointerEvents:'none',background:'#22263a',transition:'none'
  });
  document.body.appendChild(touchClone);
  el.style.opacity='0.3';
}
function tMove(e){
  if(!touchClone) return;
  e.preventDefault();
  const t=e.touches[0];
  touchClone.style.left=(t.clientX-touchOffX)+'px';
  touchClone.style.top=(t.clientY-touchOffY)+'px';
  touchClone.style.display='none';
  const under=document.elementFromPoint(t.clientX,t.clientY);
  touchClone.style.display='';
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('drag-over'));
  document.querySelectorAll('.drop-zone').forEach(el=>el.classList.remove('active'));
  const ti=under?.closest('.list-item');
  if(ti&&+ti.dataset.itemIdx!==touchSrcIdx) ti.classList.add('drag-over');
  const dz=under?.closest('.drop-zone');
  if(dz) dz.classList.add('active');
}
function tEnd(e){
  if(!touchClone){ touchSrcIdx=null; return; }
  const t=e.changedTouches[0];
  touchClone.remove(); touchClone=null;
  document.querySelectorAll('[data-item-idx]').forEach(el=>el.style.opacity='');
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('drag-over'));
  document.querySelectorAll('.drop-zone').forEach(el=>el.classList.remove('active'));
  const under=document.elementFromPoint(t.clientX,t.clientY);
  const ti=under?.closest('.list-item');
  const dz=under?.closest('.drop-zone');
  if(touchSrcIdx===null){ touchSrcIdx=null; return; }
  if(ti&&+ti.dataset.itemIdx!==touchSrcIdx){
    reorderItems(touchSrcIdx,+ti.dataset.itemIdx,ti.dataset.aisleKey);
  } else if(dz){
    moveToEndOfAisle(touchSrcIdx,dz.dataset.aisleKey);
  }
  touchSrcIdx=null; touchSrcAisle=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REORDER HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function reorderItems(srcIdx, targetIdx, targetAisleKey){
  const store=getActiveStore();
  const items=state.lists[store.id];
  const moved=items[srcIdx];
  const targetAisle=targetAisleKey==='unmatched'?null:+targetAisleKey;
  moved.aisleIndex=targetAisle;
  items.splice(srcIdx,1);
  const insertAt=srcIdx<targetIdx?targetIdx-1:targetIdx;
  items.splice(Math.max(0,insertAt),0,moved);
  saveCorr(moved,targetAisle,store);
  renderListScreen();
  persistActiveStore();
}

function moveToEndOfAisle(srcIdx, aisleKey){
  const store=getActiveStore();
  const items=state.lists[store.id];
  const moved=items[srcIdx];
  const targetAisle=aisleKey==='unmatched'?null:+aisleKey;
  moved.aisleIndex=targetAisle;
  items.splice(srcIdx,1);
  items.push(moved);
  saveCorr(moved,targetAisle,store);
  renderListScreen();
  persistActiveStore();
}

function saveCorr(item,aisleIndex,store){
  const norm=normalise(item.name);
  if(!state.corrections[store.id]) state.corrections[store.id]={};
  if(aisleIndex===null) delete state.corrections[store.id][norm];
  else state.corrections[store.id][norm]=aisleIndex;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROCESSING OVERLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showProcessing(msg){
  document.getElementById('processing-text').textContent=msg||'';
  document.getElementById('processing-overlay').classList.add('show');
}
function hideProcessing(){
  document.getElementById('processing-overlay').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getActiveStore(){ return state.stores.find(s=>s.id===state.activeStoreId)||null; }
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2600);
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function hexRgba(hex,a){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE SAVE HOOKS
// Patch state-mutating functions to persist to Firestore
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function persistActiveStore() {
  if (window.persistStore && state.activeStoreId) {
    window.persistStore(state.activeStoreId);
  }
}


boot();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/InstAisle/sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
