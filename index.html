<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<title>InstAisle</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="InstAisle">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#0f1117">
<!-- Firebase SDK -->
<script type="module">
// Firebase is loaded as a module ‚Äî see bottom of body
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@700;900&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#22263a;--border:#2e3347;
  --text:#eef0f8;--muted:#6b7196;--green:#4ade80;--amber:#fbbf24;
  --red:#f87171;--blue:#60a5fa;
}
html,body{height:100%;min-height:100dvh;overflow:hidden;}
body{
  font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);
  display:flex;flex-direction:column;height:100vh;height:100dvh;
  max-width:430px;margin:0 auto;position:relative;overflow:hidden;
}

/* TOPBAR */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px 12px;background:var(--bg);
  border-bottom:1px solid var(--border);flex-shrink:0;z-index:10;
}
.logo{
  font-family:'Playfair Display',serif;font-size:1.45rem;font-weight:900;
  letter-spacing:-0.03em;
  background:linear-gradient(135deg,var(--green),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.topbar-right{display:flex;align-items:center;gap:8px;}
.store-pill{
  background:var(--surface2);border:1px solid var(--border);border-radius:20px;
  padding:5px 12px 5px 8px;font-size:0.72rem;font-weight:500;cursor:pointer;
  display:flex;align-items:center;gap:6px;color:var(--text);transition:border-color .15s;
}
.store-pill:hover{border-color:var(--green);}
.store-dot{width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;}
.icon-btn{
  background:var(--surface);border:1px solid var(--border);border-radius:50%;
  width:34px;height:34px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1rem;transition:border-color .15s;color:var(--text);
}
.icon-btn:hover{border-color:var(--green);}

/* SCREENS */
.screens{flex:1;overflow:hidden;position:relative;}
.screen{
  position:absolute;inset:0;overflow-y:auto;
  padding:16px 20px 100px;display:none;animation:slideIn .25s ease;
}
.screen.active{display:block;}
@keyframes slideIn{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:translateX(0)}}

/* BOTTOM NAV */
.bottomnav{display:flex;background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;z-index:10;padding-bottom:env(safe-area-inset-bottom,0px);}
.nav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:14px 0;cursor:pointer;border:none;background:none;color:var(--muted);
  font-family:'Outfit',sans-serif;font-size:0.62rem;font-weight:500;
  letter-spacing:.04em;text-transform:uppercase;transition:color .15s;
}
.nav-btn .nav-icon{font-size:1.875rem;display:flex;align-items:center;justify-content:center;} .nav-btn .nav-icon svg{width:1.875rem;height:1.875rem;}
.nav-btn.active{color:var(--green);}

/* BUTTONS */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  padding:10px 18px;border-radius:10px;border:none;
  font-family:'Outfit',sans-serif;font-size:0.85rem;font-weight:600;
  cursor:pointer;transition:all .15s;
}
.btn-primary{background:var(--green);color:#0a1a12;}
.btn-primary:hover{background:#6ee79a;}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}
.btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border);}
.btn-ghost:hover{border-color:var(--muted);color:var(--text);}
.btn-danger{background:transparent;color:var(--red);border:1px solid #3d1a1a;}
.btn-danger:hover{background:#2a1212;}
.btn-sm{padding:6px 12px;font-size:0.75rem;border-radius:8px;}
.btn-full{width:100%;}

/* SECTION HEADERS */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-title{font-size:.65rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);}

/* CARDS */
.card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:16px;margin-bottom:10px;transition:border-color .15s;
}
.card-header{display:flex;align-items:center;justify-content:space-between;}

/* INPUTS */
.input-wrap{margin-bottom:14px;}
.input-label{font-size:.7rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
.input{
  width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:11px 14px;font-family:'Outfit',sans-serif;
  font-size:.9rem;color:var(--text);outline:none;transition:border-color .15s;
}
.input:focus{border-color:var(--green);}
.input::placeholder{color:var(--muted);}
textarea.input{resize:vertical;min-height:90px;}

/* KEYWORD CHIPS */
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;min-height:10px;}
.chip{
  background:var(--surface2);border:1px solid var(--border);border-radius:20px;
  padding:3px 8px 3px 10px;font-size:.7rem;display:flex;align-items:center;gap:4px;color:var(--text);
}
.chip-x{
  cursor:pointer;color:var(--muted);font-size:1rem;line-height:1;
  display:flex;align-items:center;justify-content:center;
  width:16px;height:16px;border-radius:50%;flex-shrink:0;
  transition:background .1s,color .1s;
}
.chip-x:hover{background:var(--red);color:#fff;}

/* KEYWORD INPUT SECTION */
.kw-section{margin-top:4px;}
.kw-tabs{display:flex;gap:0;margin-bottom:8px;border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.kw-tab{
  flex:1;padding:6px 10px;font-family:'Outfit',sans-serif;font-size:.7rem;font-weight:600;
  background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;
  letter-spacing:.04em;
}
.kw-tab.active{background:var(--surface2);color:var(--text);}
.kw-panel{display:none;}
.kw-panel.active{display:block;}
.kw-add-row{display:flex;gap:6px;align-items:center;}
.kw-input{
  flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  padding:7px 10px;font-family:'Outfit',sans-serif;font-size:.78rem;color:var(--text);
  outline:none;transition:border-color .15s;min-width:0;
}
.kw-input:focus{border-color:var(--green);}
.kw-input::placeholder{color:var(--muted);}
.kw-add-btn{
  background:var(--green);color:#0a1a12;border:none;border-radius:8px;
  padding:7px 14px;font-family:'Outfit',sans-serif;font-size:.78rem;font-weight:700;
  cursor:pointer;flex-shrink:0;transition:background .15s;
}
.kw-add-btn:hover{background:#6ee79a;}
.kw-bulk{
  width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;
  padding:8px 10px;font-family:'Outfit',sans-serif;font-size:.78rem;color:var(--text);
  outline:none;transition:border-color .15s;resize:vertical;min-height:72px;
}
.kw-bulk:focus{border-color:var(--green);}
.kw-bulk::placeholder{color:var(--muted);}
.kw-bulk-btn{
  margin-top:6px;width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:7px;font-family:'Outfit',sans-serif;font-size:.75rem;
  font-weight:600;color:var(--text);cursor:pointer;transition:border-color .15s;
}
.kw-bulk-btn:hover{border-color:var(--green);color:var(--green);}

/* AISLE DRAG HANDLE */
.aisle-drag-handle{
  cursor:grab;color:var(--muted);font-size:1.1rem;line-height:1;
  padding:2px 4px;border-radius:4px;touch-action:none;
  transition:color .15s,background .15s;flex-shrink:0;letter-spacing:-1px;
  user-select:none;-webkit-user-select:none;
}
.aisle-drag-handle:hover{color:var(--text);background:var(--surface2);}
.aisle-drag-handle:active,.aisle-drag-handle.grabbing{cursor:grabbing;color:var(--green);}
.aisle-card-dragging{
  opacity:.4;outline:2px dashed var(--green);outline-offset:2px;border-radius:14px;
}
.aisle-card-dragover{
  outline:2px solid var(--green);outline-offset:2px;border-radius:14px;
  background:rgba(74,222,128,.04);
}
.aisle-img-zone{
  border:2px dashed var(--border);border-radius:10px;padding:18px 14px;
  text-align:center;cursor:pointer;transition:all .15s;color:var(--muted);
  position:relative;overflow:hidden;
}
.aisle-img-zone:hover{border-color:var(--blue);color:var(--blue);background:rgba(96,165,250,.04);}
.aisle-img-zone.scanning{border-color:var(--blue);border-style:solid;cursor:default;}
.aisle-img-zone.has-preview{border-color:var(--green);border-style:solid;padding:8px;}
.aisle-img-thumb{
  width:100%;border-radius:6px;max-height:110px;object-fit:cover;display:block;margin-bottom:8px;
}
.aisle-img-spinner{
  width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--blue);
  border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 8px;
}
.scan-result-row{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:10px;padding:8px 10px;background:rgba(96,165,250,.08);
  border:1px solid rgba(96,165,250,.2);border-radius:8px;
}
.scan-result-label{font-size:.7rem;color:var(--blue);}
.scan-accept-btn{
  background:var(--green);color:#0a1a12;border:none;border-radius:6px;
  padding:5px 12px;font-family:'Outfit',sans-serif;font-size:.72rem;font-weight:700;
  cursor:pointer;transition:background .15s;
}
.scan-accept-btn:hover{background:#6ee79a;}
.scan-discard-btn{
  background:transparent;color:var(--muted);border:1px solid var(--border);border-radius:6px;
  padding:5px 10px;font-family:'Outfit',sans-serif;font-size:.72rem;font-weight:600;
  cursor:pointer;margin-left:6px;
}

/* LIST ITEMS */
.edit-list-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;background:var(--surface);
  border:1px solid var(--border);border-radius:10px;
  margin-bottom:6px;
}
.edit-item-name{flex:1;font-size:.9rem;color:var(--text);}
.edit-item-aisle{font-size:.72rem;padding:2px 8px;border-radius:20px;font-weight:600;flex-shrink:0;}
.edit-item-delete{
  background:none;border:none;color:var(--muted);font-size:1.1rem;
  cursor:pointer;padding:2px 4px;line-height:1;flex-shrink:0;
  border-radius:6px;transition:color .15s,background .15s;
}
.edit-item-delete:hover{color:#f87171;background:rgba(239,68,68,.1);}
.list-item{
  display:flex;align-items:center;gap:10px;padding:10px 12px;
  border-radius:10px;background:var(--surface2);margin-bottom:6px;
  transition:all .15s;position:relative;user-select:none;
}
.list-item.dragging{opacity:.35;border:2px dashed var(--green);background:var(--surface);}
.list-item.drag-over{border:2px solid var(--green);transform:scale(1.01);}
.drag-handle{
  cursor:grab;color:var(--muted);font-size:.95rem;line-height:1;
  padding:2px 3px;flex-shrink:0;touch-action:none;letter-spacing:-1px;
}
.drag-handle:active{cursor:grabbing;color:var(--green);}
.list-item.checked{opacity:.45;}
.list-item.checked .item-name{text-decoration:line-through;}
.item-check{
  width:20px;height:20px;border-radius:50%;border:2px solid var(--border);
  flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;
}
.item-check.done{background:var(--green);border-color:var(--green);}
.item-name{flex:1;font-size:.88rem;font-weight:400;}
.item-aisle-badge{
  font-size:.62rem;font-weight:600;padding:2px 7px;border-radius:20px;
  cursor:pointer;transition:all .15s;flex-shrink:0;
}
.item-aisle-badge:hover{filter:brightness(1.3);}
.ai-dot{font-size:.55rem;color:#7dd3fc;vertical-align:middle;}

/* AISLE GROUPS */
.aisle-group{margin-bottom:20px;}
.aisle-group-header{
  display:flex;align-items:center;gap:10px;padding:8px 12px;
  border-radius:10px;margin-bottom:8px;font-size:.72rem;font-weight:700;
  letter-spacing:.06em;text-transform:uppercase;
}
.aisle-count{margin-left:auto;opacity:.6;font-weight:400;font-size:.65rem;}
.drop-zone{
  min-height:8px;border-radius:8px;transition:all .2s;margin-top:4px;
}
.drop-zone.active{
  min-height:44px;border:2px dashed var(--green);
  background:rgba(74,222,128,.06);
  display:flex;align-items:center;justify-content:center;
  font-size:.72rem;color:var(--green);
}
.drop-zone.active::after{content:'Drop here';}

/* AI BADGE */
.ai-badge{
  display:inline-flex;align-items:center;gap:4px;
  background:linear-gradient(135deg,#1a2d4a,#1a3d29);
  border:1px solid #2a4a6a;border-radius:20px;
  padding:3px 9px;font-size:.62rem;font-weight:600;
  color:#7dd3fc;letter-spacing:.04em;
}

/* PROCESSING OVERLAY */
.processing-overlay{
  position:fixed;inset:0;background:rgba(15,17,23,.88);
  z-index:200;display:none;flex-direction:column;
  align-items:center;justify-content:center;gap:16px;
}
.processing-overlay.show{display:flex;}
.spinner{
  width:40px;height:40px;border:3px solid var(--border);
  border-top-color:var(--green);border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.processing-text{font-size:.85rem;color:var(--muted);text-align:center;padding:0 32px;}
.processing-title{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--text);}

/* MODAL */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.72);z-index:100;
  display:none;align-items:flex-end;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:20px 20px 0 0;padding:24px 20px 36px;
  width:100%;max-width:430px;margin:0 auto;
  animation:slideUp .25s ease;max-height:85vh;overflow-y:auto;
}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;}
.modal-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;margin-bottom:16px;}

/* UPLOAD ZONE */
.upload-zone{
  border:2px dashed var(--border);border-radius:14px;padding:22px;
  text-align:center;cursor:pointer;transition:all .15s;color:var(--muted);margin-bottom:14px;
}
.upload-zone:hover{border-color:var(--green);background:#0d2018;color:var(--green);}
.upload-zone.has-image{border-color:var(--green);border-style:solid;padding:10px;}
.upload-icon{font-size:1.5rem;margin-bottom:6px;}
.img-preview{width:100%;border-radius:8px;max-height:160px;object-fit:cover;display:block;}
#file-input{display:none;}

/* COLOR PICKER */
.color-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.color-opt{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:border-color .15s;}
.color-opt.selected{border-color:white;}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-icon{font-size:2.5rem;margin-bottom:12px;}
.empty-title{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:6px;}
.empty-sub{font-size:.8rem;line-height:1.6;}

/* TOAST */
.toast{
  position:fixed;bottom:80px;left:50%;
  transform:translateX(-50%) translateY(20px);
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:10px 18px;font-size:.82rem;font-weight:500;z-index:300;
  opacity:0;transition:all .25s ease;white-space:nowrap;pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* MISC */
.divider{height:1px;background:var(--border);margin:16px 0;}
/* ‚îÄ‚îÄ STORE LIBRARY & NEARBY ‚îÄ‚îÄ */
.lib-chain-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px;}
.lib-chain-card{
  background:var(--surface2);border:1px solid var(--border);border-radius:12px;
  padding:12px 10px;cursor:pointer;transition:all .15s;text-align:left;
  display:flex;flex-direction:column;gap:4px;
}
.lib-chain-card:hover{border-color:var(--green);background:rgba(74,222,128,.06);}
.lib-chain-card.selected{border-color:var(--green);background:rgba(74,222,128,.10);}
.lib-chain-name{font-size:.78rem;font-weight:600;color:var(--text);}
.lib-chain-meta{font-size:.62rem;color:var(--muted);}
.lib-chain-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:3px;}
.lib-chain-row{display:flex;align-items:flex-start;gap:7px;}
.nearby-list{display:flex;flex-direction:column;gap:8px;margin-bottom:4px;}
.nearby-card{
  background:var(--surface2);border:1px solid var(--border);border-radius:12px;
  padding:12px 14px;cursor:pointer;transition:all .15s;
  display:flex;align-items:center;gap:12px;
}
.nearby-card:hover{border-color:var(--green);}
.nearby-card.selected{border-color:var(--green);background:rgba(74,222,128,.10);}
.nearby-card-info{flex:1;min-width:0;}
.nearby-name{font-size:.82rem;font-weight:600;color:var(--text);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.nearby-address{font-size:.65rem;color:var(--muted);margin-top:2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.nearby-meta{display:flex;gap:6px;margin-top:4px;align-items:center;flex-wrap:wrap;}
.nearby-dist{font-size:.65rem;color:var(--muted);}
.nearby-open{font-size:.62rem;font-weight:600;padding:1px 6px;border-radius:6px;}
.nearby-open.open{background:rgba(74,222,128,.15);color:var(--green);}
.nearby-open.closed{background:rgba(248,113,113,.12);color:var(--red);}
.nearby-match-pill{font-size:.6rem;font-weight:700;padding:2px 7px;border-radius:8px;
  background:rgba(74,222,128,.15);color:var(--green);flex-shrink:0;white-space:nowrap;}
.nearby-no-match-pill{font-size:.6rem;font-weight:600;padding:2px 7px;border-radius:8px;
  background:var(--surface);color:var(--muted);flex-shrink:0;white-space:nowrap;}
.lib-tabs{display:flex;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;margin-bottom:14px;overflow:hidden;}
.lib-tab{flex:1;padding:8px 4px;font-family:'Outfit',sans-serif;font-size:.75rem;
  font-weight:600;background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;}
.lib-tab.active{background:var(--surface);color:var(--text);}
.lib-panel{display:none;}
.lib-panel.active{display:block;}
.source-badge{font-size:.6rem;font-weight:700;padding:1px 6px;border-radius:6px;
  background:rgba(96,165,250,.12);color:var(--blue);display:inline-block;margin-left:4px;}
.source-badge.real{background:rgba(74,222,128,.12);color:var(--green);}
.loc-status{font-size:.72rem;color:var(--muted);text-align:center;padding:20px;}

.spacer{flex:1;}
.text-muted{color:var(--muted);font-size:.78rem;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#auth-screen{
  position:fixed;inset:0;background:var(--bg);z-index:500;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 28px;max-width:430px;margin:0 auto;
}
.auth-logo{
  font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:900;
  background:linear-gradient(135deg,var(--green),var(--blue));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:8px;
}
.auth-tagline{font-size:.82rem;color:var(--muted);margin-bottom:40px;text-align:center;}
.auth-tabs{display:flex;background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:24px;overflow:hidden;width:100%;}
.auth-tab{
  flex:1;padding:10px;font-family:'Outfit',sans-serif;font-size:.8rem;font-weight:600;
  background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;
}
.auth-tab.active{background:var(--surface2);color:var(--text);}
.auth-panel{display:none;width:100%;}
.auth-panel.active{display:block;}
.auth-success{
  display:none;background:rgba(34,197,94,.12);color:#4ade80;
  border:1px solid rgba(34,197,94,.25);border-radius:8px;
  padding:10px 14px;font-size:.82rem;margin-bottom:12px;
}
.auth-success.show{display:block;}
.pw-wrap{position:relative;display:flex;align-items:center;}
.pw-wrap .input{flex:1;padding-right:42px;}
.pw-eye{
  position:absolute;right:10px;background:none;border:none;
  color:var(--muted);cursor:pointer;padding:6px;line-height:0;
  display:flex;align-items:center;justify-content:center;
  transition:color .15s;border-radius:4px;
}
.pw-eye:hover{color:var(--text);background:rgba(255,255,255,.05);}
.btn-link-subtle{
  background:none;border:none;color:var(--muted);font-size:.8rem;
  cursor:pointer;padding:2px 4px;text-decoration:underline;
  text-underline-offset:2px;
}
.btn-link-subtle:hover{color:var(--text);}
.auth-error{
  font-size:.75rem;color:var(--red);background:rgba(248,113,113,.08);
  border:1px solid rgba(248,113,113,.2);border-radius:8px;padding:8px 12px;
  margin-bottom:12px;display:none;
}
.auth-error.show{display:block;}
.auth-divider{
  display:flex;align-items:center;gap:10px;margin:16px 0;color:var(--muted);font-size:.7rem;
}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.btn-google{
  width:100%;display:flex;align-items:center;justify-content:center;gap:10px;
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:11px;font-family:'Outfit',sans-serif;font-size:.85rem;font-weight:600;
  color:var(--text);cursor:pointer;transition:all .15s;
}
.btn-google:hover{border-color:var(--blue);background:rgba(96,165,250,.06);}
.google-icon{width:18px;height:18px;}

/* ‚îÄ‚îÄ USER AVATAR / PROFILE PILL ‚îÄ‚îÄ */
.user-pill{
  background:var(--surface2);border:1px solid var(--border);border-radius:20px;
  padding:4px 10px 4px 4px;font-size:.72rem;font-weight:500;cursor:pointer;
  display:flex;align-items:center;gap:6px;color:var(--text);transition:border-color .15s;
}
.user-pill:hover{border-color:var(--blue);}
.user-avatar{
  width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--blue));
  display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700;
  color:#0a1a12;flex-shrink:0;overflow:hidden;
}
.user-avatar img{width:100%;height:100%;object-fit:cover;}

/* ‚îÄ‚îÄ SYNC INDICATOR ‚îÄ‚îÄ */
.sync-dot{
  width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0;
  transition:background .3s;
}
.sync-dot.syncing{background:var(--amber);animation:pulse .8s infinite;}
.sync-dot.error{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ SHARE STORE CARD UI ‚îÄ‚îÄ */
.share-code-box{
  background:var(--surface2);border:1px solid var(--green);border-radius:12px;
  padding:16px;text-align:center;margin:12px 0;
}
.share-code{
  font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;
  letter-spacing:.2em;color:var(--green);margin:8px 0 4px;
}
.share-code-hint{font-size:.7rem;color:var(--muted);}
.shared-badge{
  display:inline-flex;align-items:center;gap:5px;
  background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.25);
  border-radius:20px;padding:2px 8px;font-size:.62rem;color:var(--blue);font-weight:600;
}

/* ‚îÄ‚îÄ PROFILE MODAL ‚îÄ‚îÄ */
.profile-avatar-lg{
  width:64px;height:64px;border-radius:50%;
  background:linear-gradient(135deg,var(--green),var(--blue));
  display:flex;align-items:center;justify-content:center;
  font-size:1.6rem;font-weight:700;color:#0a1a12;margin:0 auto 12px;overflow:hidden;
}
.profile-avatar-lg img{width:100%;height:100%;object-fit:cover;}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-logo">InstAisle</div>
  <div class="auth-tagline">Shop in style.</div>

  <div class="auth-tabs">
    <button class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</button>
    <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
  </div>

  <!-- Sign In Panel -->
  <div class="auth-panel active" id="auth-panel-signin">
    <div class="auth-error" id="auth-error-signin"></div>
    <div class="input-wrap">
      <label class="input-label">Email</label>
      <input class="input" id="signin-email" type="email" placeholder="you@example.com" autocomplete="email">
    </div>
    <div class="input-wrap">
      <label class="input-label">Password</label>
      <input class="input" id="signin-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"
        onkeydown="if(event.key==='Enter') signInEmail()">
    </div>
    <button class="btn btn-primary btn-full" onclick="signInEmail()" id="btn-signin">Sign In</button>
    <div style="text-align:center;margin:10px 0 4px">
      <button class="btn-link-subtle" onclick="showForgotPassword()">Forgot password?</button>
    </div>
    <div class="auth-divider">or</div>
    <button class="btn-google" onclick="signInGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
  </div>

  <!-- Forgot Password Panel -->
  <div class="auth-panel" id="auth-panel-forgot">
    <div class="auth-error" id="auth-error-forgot"></div>
    <div class="auth-success" id="auth-success-forgot"></div>
    <p style="font-size:.85rem;color:var(--muted);margin-bottom:16px;text-align:center">
      Enter your email and we'll send you a link to reset your password.
    </p>
    <div class="input-wrap">
      <label class="input-label">Email</label>
      <input class="input" id="forgot-email" type="email" placeholder="you@example.com" autocomplete="email"
        onkeydown="if(event.key==='Enter') sendResetEmail()">
    </div>
    <button class="btn btn-primary btn-full" onclick="sendResetEmail()" id="btn-forgot">Send Reset Link</button>
    <button class="btn btn-ghost btn-full btn-sm" style="margin-top:8px" onclick="switchAuthTab('signin')">‚Üê Back to Sign In</button>
  </div>

  <!-- Sign Up Panel -->
  <div class="auth-panel" id="auth-panel-signup">
    <div class="auth-error" id="auth-error-signup"></div>
    <div class="input-wrap">
      <label class="input-label">Display Name</label>
      <input class="input" id="signup-name" type="text" placeholder="Your name" autocomplete="name">
    </div>
    <div class="input-wrap">
      <label class="input-label">Email</label>
      <input class="input" id="signup-email" type="email" placeholder="you@example.com" autocomplete="email">
    </div>
    <div class="input-wrap">
      <label class="input-label">Password</label>
      <div class="pw-wrap">
        <input class="input" id="signup-password" type="password" placeholder="Min. 6 characters" autocomplete="new-password">
        <button class="pw-eye" type="button" onclick="togglePw('signup-password',this)" tabindex="-1" aria-label="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    </div>
    <div class="input-wrap">
      <label class="input-label">Confirm Password</label>
      <div class="pw-wrap">
        <input class="input" id="signup-password-confirm" type="password" placeholder="Re-enter password" autocomplete="new-password"
          onkeydown="if(event.key==='Enter') signUpEmail()">
        <button class="pw-eye" type="button" onclick="togglePw('signup-password-confirm',this)" tabindex="-1" aria-label="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    </div>
    <button class="btn btn-primary btn-full" onclick="signUpEmail()" id="btn-signup">Create Account</button>
    <div class="auth-divider">or</div>
    <button class="btn-google" onclick="signInGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="modal-delete-confirm" onclick="cancelDelete()">
  <div class="modal" onclick="event.stopPropagation()" style="max-width:320px">
    <div class="modal-handle"></div>
    <div class="modal-title" style="text-align:center">Delete Store?</div>
    <p class="text-muted" style="text-align:center;margin-bottom:20px;font-size:.88rem">
      This will permanently delete <strong id="delete-confirm-name"></strong> and its list. This cannot be undone.
    </p>
    <button class="btn btn-danger btn-full" onclick="confirmDelete()" style="margin-bottom:8px">Delete</button>
    <button class="btn btn-ghost btn-full" onclick="cancelDelete()">Cancel</button>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">InstAisle</div>
  <div class="topbar-right">
    <div class="sync-dot" id="sync-dot" title="Sync status"></div>
    <div class="store-pill" onclick="openStoreSwitch()">
      <div class="store-dot" id="active-store-dot"></div>
      <span id="active-store-name">No store</span>
      <span style="color:var(--muted)">‚ñæ</span>
    </div>
    <div class="user-pill" onclick="openProfileModal()" id="user-pill">
      <div class="user-avatar" id="user-avatar-sm">?</div>
      <span id="user-name-sm">Account</span>
    </div>
    <div class="icon-btn" onclick="openAddList()" title="New list">Ôºã</div>
  </div>
</div>

<!-- SCREENS -->
<div class="screens">
  <div class="screen active" id="screen-list"><div id="list-content"></div></div>
  <div class="screen" id="screen-stores">
    <div class="section-header">
      <span class="section-title">My Stores</span>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <button class="btn btn-primary" style="flex:1" onclick="openLibraryModal()"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px">
  <path d="M3 9l1-5h16l1 5"/>
  <path d="M3 9a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2"/>
  <path d="M5 11v9h14v-9"/>
  <rect x="8" y="13" width="8" height="5" rx="1"/>
  <path d="M9.5 15 Q11 14.4 12.5 15.2 Q14 15.8 14.5 15" stroke-width="1.1"/>
  <path d="M9.5 17 Q11 16.5 13 17" stroke-width="1.1"/>
</svg>Store Library</button>
      <button class="btn btn-ghost" style="flex:1" onclick="openNewStore()">+ Build My Own</button>
    </div>
    <div id="stores-list"></div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottomnav">
  <button class="nav-btn active" id="nav-list" onclick="switchScreen('list')">
    <span class="nav-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
  <rect x="4" y="2" width="16" height="20" rx="2"/>
  <line x1="8" y1="6" x2="8" y2="6"/>
  <line x1="10" y1="6" x2="17" y2="6"/>
  <line x1="8" y1="10" x2="8" y2="10"/>
  <line x1="10" y1="10" x2="16" y2="10"/>
  <line x1="8" y1="14" x2="8" y2="14"/>
  <line x1="10" y1="14" x2="15" y2="14"/>
  <circle cx="8" cy="6" r="1" fill="currentColor" stroke="none"/>
  <circle cx="8" cy="10" r="1" fill="currentColor" stroke="none"/>
  <circle cx="8" cy="14" r="1" fill="currentColor" stroke="none"/>
  <path d="M10 6 Q12 5.5 14 6.2 Q16 6.8 17 6" stroke-width="1.2"/>
  <path d="M10 10 Q12 9.4 14 10.1 Q15.5 10.6 16 10" stroke-width="1.2"/>
  <path d="M10 14 Q11.5 13.5 13 14 Q14 14.4 15 14" stroke-width="1.2"/>
</svg></span>List
  </button>
  <button class="nav-btn" id="nav-stores" onclick="switchScreen('stores')">
    <span class="nav-icon"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
  <path d="M3 9l1-5h16l1 5"/>
  <path d="M3 9a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2"/>
  <path d="M5 11v9h14v-9"/>
  <rect x="8" y="13" width="8" height="5" rx="1"/>
  <path d="M9.5 15 Q11 14.4 12.5 15.2 Q14 15.8 14.5 15" stroke-width="1.1"/>
  <path d="M9.5 17 Q11 16.5 13 17" stroke-width="1.1"/>
</svg></span>Stores
  </button>
</div>

<!-- PROCESSING OVERLAY -->
<div class="processing-overlay" id="processing-overlay">
  <div class="spinner"></div>
  <div class="processing-title">Reading your list‚Ä¶</div>
  <div class="processing-text" id="processing-text">Classifying your items by aisle</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Store Switch -->
<div class="modal-overlay" id="modal-store-switch" onclick="closeModal('modal-store-switch')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Choose Store</div>
    <div id="store-switch-list"></div>
    <div class="divider"></div>
    <button class="btn btn-primary btn-full" style="margin-bottom:8px" onclick="document.getElementById('modal-store-switch').classList.remove('open');openLibraryModal()"><svg width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px">
  <path d="M3 9l1-5h16l1 5"/>
  <path d="M3 9a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2"/>
  <path d="M5 11v9h14v-9"/>
  <rect x="8" y="13" width="8" height="5" rx="1"/>
  <path d="M9.5 15 Q11 14.4 12.5 15.2 Q14 15.8 14.5 15" stroke-width="1.1"/>
  <path d="M9.5 17 Q11 16.5 13 17" stroke-width="1.1"/>
</svg>Add from Store Library</button>
    <button class="btn btn-ghost btn-full" onclick="document.getElementById('modal-store-switch').classList.remove('open');openNewStore()">+ Build My Own Store</button>
  </div>
</div>

<!-- Store Library Modal -->
<div class="modal-overlay" id="modal-library" onclick="closeModal('modal-library')">
  <div class="modal" onclick="event.stopPropagation()" style="max-height:90vh;display:flex;flex-direction:column;overflow:hidden">
    <div class="modal-handle" style="flex-shrink:0"></div>
    <div class="modal-title" style="flex-shrink:0">Store Library</div>
    <div class="lib-tabs" style="flex-shrink:0">
      <button class="lib-tab active" id="libtab-nearby" onclick="switchLibTab('nearby')">üìç Nearby</button>
      <button class="lib-tab" id="libtab-browse" onclick="switchLibTab('browse')">Browse All</button>
    </div>
    <!-- Scrollable panel area -->
    <div style="flex:1;overflow-y:auto;min-height:0">
      <!-- Nearby panel -->
      <div class="lib-panel active" id="libpanel-nearby">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input class="input" id="nearby-location-input" type="text"
            placeholder="Search a location, or use GPS below‚Ä¶"
            style="flex:1;font-size:.82rem"
            onkeydown="if(event.key==='Enter') searchNearbyLocation()"
            autocomplete="off">
          <button class="btn btn-primary" onclick="searchNearbyLocation()" style="flex-shrink:0;padding:0 14px;font-size:.82rem">Go</button>
        </div>
        <button class="btn btn-ghost btn-full btn-sm" id="btn-find-nearby" onclick="findNearbyStores()" style="margin-bottom:10px">üìç Use My Location</button>
        <div id="nearby-status" class="loc-status" style="display:none"></div>
        <div id="nearby-list-container"></div>
        <div id="nearby-load-more-trigger" style="height:1px"></div>
      </div>
      <!-- Browse panel -->
      <div class="lib-panel" id="libpanel-browse">
        <input class="input" id="lib-search-input" placeholder="Search chains (Market Basket, Trader Joe's‚Ä¶)"
          oninput="renderLibraryBrowse()" style="margin-bottom:12px">
        <div id="lib-browse-grid" class="lib-chain-grid"></div>
      </div>
    </div>
    <!-- Fixed bottom section -->
    <div style="flex-shrink:0">
      <div class="divider"></div>
      <div id="lib-selected-preview" style="display:none">
        <div style="font-size:.72rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px">Selected</div>
        <div id="lib-selected-name" style="font-size:.92rem;font-weight:600;margin-bottom:4px"></div>
        <div id="lib-selected-meta" style="font-size:.7rem;color:var(--muted);margin-bottom:12px"></div>
        <button class="btn btn-primary btn-full" onclick="addStoreFromLibrary()">Add This Store ‚Üí</button>
      </div>
      <button class="btn btn-ghost btn-full btn-sm" style="margin-top:8px" onclick="closeModal('modal-library')">Cancel</button>
    </div>
  </div>
</div>

<!-- New / Edit Store -->
<div class="modal-overlay" id="modal-store" onclick="closeModal('modal-store')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title" id="store-modal-title">New Store</div>
    <div class="input-wrap">
      <label class="input-label">Store Name</label>
      <input class="input" id="store-name-input" placeholder="e.g. Trader Joe's">
    </div>
    <div class="input-wrap">
      <label class="input-label">Color</label>
      <div class="color-picker" id="store-color-picker"></div>
    </div>
    <div class="divider"></div>
    <div class="section-header">
      <span class="section-title">Aisles</span>
      <button class="btn btn-sm btn-ghost" onclick="addAisleRow()">+ Aisle</button>
    </div>
    <div id="aisle-rows"></div>
    <button class="btn btn-primary btn-full" style="margin-top:16px" onclick="saveStore()">Save Store</button>
  </div>
</div>

<!-- Add List -->
<div class="modal-overlay" id="modal-add-list" onclick="closeModal('modal-add-list')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">New Shopping List</div>
    <div class="input-wrap">
      <label class="input-label">Items</label>
      <textarea class="input" id="list-text-input" placeholder="Bananas&#10;Chicken breast&#10;Greek yogurt&#10;Olive oil&#10;Shampoo"></textarea>
    </div>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div class="upload-icon" id="upload-icon">üìé</div>
      <p style="font-size:.78rem" id="upload-label">Tap to upload a file or photo of your list</p>
    </div>
    <input type="file" id="file-input" accept="*/*" onchange="handleFileUpload(event)">
    <!-- Hidden input for aisle photo scans; id set dynamically before click -->
    <input type="file" id="aisle-img-input" accept="image/*" capture="environment" style="display:none" onchange="handleAisleImageUpload(event)">
    <button class="btn btn-primary btn-full" onclick="processListInput()">‚ú¶ Organize list ‚Üí</button>
  </div>
</div>

<!-- Move Item -->
<div class="modal-overlay" id="modal-move-item" onclick="closeModal('modal-move-item')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Move Item</div>
    <p class="text-muted" style="margin-bottom:16px">Where is <strong id="move-item-name" style="color:var(--text)"></strong> located?</p>
    <div id="move-aisle-options"></div>
    <div class="divider"></div>
    <button class="btn btn-ghost btn-full btn-sm" onclick="closeModal('modal-move-item')">Cancel</button>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal-overlay" id="modal-profile" onclick="closeModal('modal-profile')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="profile-avatar-lg" id="profile-avatar-lg">?</div>
    <div style="text-align:center;margin-bottom:20px">
      <div id="profile-display-name" style="font-size:1.1rem;font-weight:600;margin-bottom:4px">User</div>
      <div id="profile-email" class="text-muted"></div>
    </div>
    <div class="divider"></div>
    <div class="section-header" style="margin-bottom:10px">
      <span class="section-title">Join a Shared Store</span>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <input class="input" id="join-code-input" placeholder="Enter 6-letter code" maxlength="6"
        style="text-transform:uppercase;letter-spacing:.1em;font-weight:600"
        oninput="this.value=this.value.toUpperCase()">
      <button class="btn btn-primary" onclick="joinStoreByCode()" style="flex-shrink:0">Join</button>
    </div>
    <div class="divider"></div>
    <div class="section-header" style="margin-bottom:10px">
      <span class="section-title">Change Password</span>
    </div>
    <div id="change-pass-msg" style="display:none;font-size:.8rem;padding:8px 12px;border-radius:8px;margin-bottom:10px"></div>
    <div class="input-wrap" id="change-pass-fields">
      <label class="input-label">Current Password</label>
      <div class="pw-wrap">
        <input class="input" id="current-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        <button class="pw-eye" type="button" onclick="window.togglePw('current-password',this)" tabindex="-1" aria-label="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
      <label class="input-label" style="margin-top:10px">New Password</label>
      <div class="pw-wrap">
        <input class="input" id="new-password" type="password" placeholder="Min. 6 characters" autocomplete="new-password">
        <button class="pw-eye" type="button" onclick="window.togglePw('new-password',this)" tabindex="-1" aria-label="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
      <label class="input-label" style="margin-top:10px">Confirm New Password</label>
      <div class="pw-wrap">
        <input class="input" id="confirm-password" type="password" placeholder="Min. 6 characters" autocomplete="new-password">
        <button class="pw-eye" type="button" onclick="window.togglePw('confirm-password',this)" tabindex="-1" aria-label="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      </div>
    </div>
    <button class="btn btn-primary btn-full" style="margin-bottom:16px" onclick="changePassword()" id="btn-change-pass">Update Password</button>
    <div class="divider"></div>
    <button class="btn btn-danger btn-full" onclick="signOut()">Sign Out</button>
  </div>
</div>

<!-- Edit List Modal -->
<div class="modal-overlay" id="modal-edit-list" onclick="closeModal('modal-edit-list')">
  <div class="modal" onclick="event.stopPropagation()" style="max-height:85vh;display:flex;flex-direction:column">
    <div class="modal-handle"></div>
    <div class="modal-title">Edit List</div>

    <!-- Add item row -->
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-shrink:0;align-items:flex-end">
      <textarea class="input" id="edit-list-new-item" placeholder="Add items, separated by commas or line breaks‚Ä¶"
        rows="2"
        style="flex:1;resize:none;line-height:1.4"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();addItemFromEdit();}"
        autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
      <button class="btn btn-primary" onclick="addItemFromEdit()" style="flex-shrink:0;padding:0 18px;height:44px">Add</button>
    </div>

    <!-- Item list -->
    <div id="edit-list-items" style="overflow-y:auto;flex:1;margin:0 -4px;padding:0 4px"></div>

    <div style="margin-top:16px;flex-shrink:0">
      <button class="btn btn-primary btn-full" onclick="closeModal('modal-edit-list')">Done</button>
    </div>
  </div>
</div>

<!-- Share Store Modal -->
<div class="modal-overlay" id="modal-share-store" onclick="closeModal('modal-share-store')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">Share Store</div>
    <p class="text-muted" style="margin-bottom:16px">Share this code with others so they can join and sync this store's list in real time.</p>
    <div class="share-code-box">
      <div style="font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">Share Code</div>
      <div class="share-code" id="share-code-display">------</div>
      <div class="share-code-hint">Others enter this in their profile ‚Üí Join Store</div>
    </div>
    <button class="btn btn-primary btn-full" style="margin-bottom:8px" onclick="copyShareCode()">üìã Copy Code</button>
    <button class="btn btn-ghost btn-full btn-sm" onclick="closeModal('modal-share-store')">Close</button>
  </div>
</div>

<script type="module">
// ‚îÄ‚îÄ Firebase imports (must be first in a module) ‚îÄ‚îÄ
import { initializeApp }                              from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut as fbSignOut,
         createUserWithEmailAndPassword, signInWithEmailAndPassword,
         updateProfile, GoogleAuthProvider, signInWithPopup,
         sendPasswordResetEmail, updatePassword,
         reauthenticateWithCredential, EmailAuthProvider }
                                                      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, collection, setDoc, getDoc, onSnapshot,
         updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, arrayRemove }
                                                      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIREBASE CONFIGURATION
//  Get it from: Firebase Console ‚Üí Project Settings ‚Üí Your Apps
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyC_QHkzWMXgx-p3tRANKO_1ioRXuj91RcA",
  authDomain:        "instaisle-e8d6b.firebaseapp.com",
  projectId:         "instaisle-e8d6b",
  storageBucket:     "instaisle-e8d6b.firebasestorage.app",
  messagingSenderId: "674691002191",
  appId:             "1:674691002191:web:a326ba46c09e1d90435f3a",
  measurementId:     "G-TT3FQXVYQV"
};

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
const app  = initializeApp(FIREBASE_CONFIG);
const auth = getAuth(app);
const db   = getFirestore(app);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPOSE to global scope (bridge to non-module JS below)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._fb = { auth, db, fbSignOut, createUserWithEmailAndPassword,
               signInWithEmailAndPassword, updateProfile,
               GoogleAuthProvider, signInWithPopup,
               sendPasswordResetEmail, updatePassword,
               reauthenticateWithCredential, EmailAuthProvider,
               doc, collection, setDoc, getDoc, onSnapshot,
               updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, arrayUnion, arrayRemove };

// ‚îÄ‚îÄ Auth state listener ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  if (user) {
    window._currentUser = user;
    updateUserUI(user);
    document.getElementById('auth-screen').style.display = 'none';
    await loadUserData(user.uid);
  } else {
    window._currentUser = null;
    document.getElementById('auth-screen').style.display = 'flex';
    // Clear any live listeners
    if (window._storeUnsubs) window._storeUnsubs.forEach(fn => fn());
    window._storeUnsubs = [];
  }
});

// ‚îÄ‚îÄ Update top-bar user UI ‚îÄ‚îÄ
function updateUserUI(user) {
  const initials = (user.displayName || user.email || '?')
    .split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase();
  const avatarSm  = document.getElementById('user-avatar-sm');
  const nameSm    = document.getElementById('user-name-sm');
  const avatarLg  = document.getElementById('profile-avatar-lg');
  const nameEl    = document.getElementById('profile-display-name');
  const emailEl   = document.getElementById('profile-email');

  if (user.photoURL) {
    avatarSm.innerHTML  = `<img src="${user.photoURL}" alt="">`;
    avatarLg.innerHTML  = `<img src="${user.photoURL}" alt="">`;
  } else {
    avatarSm.textContent  = initials;
    avatarLg.textContent  = initials;
  }
  nameSm.textContent  = user.displayName || user.email.split('@')[0];
  nameEl.textContent  = user.displayName || 'User';
  emailEl.textContent = user.email;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIRESTORE LOAD & SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._storeUnsubs = [];

async function loadUserData(uid) {
  const { db, doc, collection, onSnapshot, query, where, getDocs } = window._fb;
  setSyncDot('syncing');

  // Load stores the user owns or is a member of
  const storesRef = collection(db, 'stores');

  // owned stores
  const ownedQ   = query(storesRef, where('ownerUid', '==', uid));
  // shared stores
  const sharedQ  = query(storesRef, where('members', 'array-contains', uid));

  const [ownedSnap, sharedSnap] = await Promise.all([getDocs(ownedQ), getDocs(sharedQ)]);

  const storeDocs = [...ownedSnap.docs, ...sharedSnap.docs];

  // Rebuild local state from Firestore
  state.stores = [];
  state.lists  = {};
  state.corrections = {};

  if (storeDocs.length === 0) {
    // First time ‚Äî seed demo store to Firestore
    await seedDemoStore(uid);
    return;
  }

  storeDocs.forEach(snap => {
    const d = snap.data();
    state.stores.push({
      id: snap.id, name: d.name, color: d.color, aisles: d.aisles || [],
      ownerUid: d.ownerUid, members: d.members || [], shareCode: d.shareCode || null,
      isShared: (d.members || []).length > 0 || d.ownerUid !== uid
    });
    state.lists[snap.id]       = d.list        || [];
    state.corrections[snap.id] = d.corrections || {};
  });

  if (!state.activeStoreId || !state.stores.find(s => s.id === state.activeStoreId)) {
    state.activeStoreId = state.stores[0]?.id || null;
  }

  renderAll();
  setSyncDot('ok');

  // Preload store locations in background so nearby tab is instant
  loadStoreLocations();

  // Set up real-time listeners for each store
  window._storeUnsubs.forEach(fn => fn());
  window._storeUnsubs = storeDocs.map(snap =>
    onSnapshot(doc(db, 'stores', snap.id), (d) => {
      if (!d.exists()) return;
      if (window._isSaving) return;
      const data = d.data();
      const idx = state.stores.findIndex(s => s.id === d.id);
      if (idx !== -1) {
        state.stores[idx] = { ...state.stores[idx], name: data.name, color: data.color,
          aisles: data.aisles || [], members: data.members || [], shareCode: data.shareCode || null };
        state.lists[d.id]       = data.list        || [];
        state.corrections[d.id] = data.corrections || {};
        renderAll();
        setSyncDot('ok');
      }
    })
  );
}

async function seedDemoStore(uid) {
  const { db, doc, setDoc, serverTimestamp } = window._fb;
  const id = 'store-' + uid.substring(0,8);
  const demo = {
    ownerUid: uid, members: [], shareCode: null,
    name: 'General Store', color: '#4ade80',
    createdAt: serverTimestamp(),
    aisles: [
      {name:'Aisle 1 ‚Äì Produce',       keywords:['apple','banana','orange','grape','berries','lettuce','spinach','kale','broccoli','carrot','tomato','cucumber','pepper','onion','garlic','lemon','lime','avocado','mushroom','fruit','vegetable','herbs','cilantro','ginger','zucchini','celery','arugula']},
      {name:'Aisle 2 ‚Äì Dairy & Eggs',  keywords:['milk','cheese','yogurt','butter','cream','eggs','egg','sour cream','kefir','mozzarella','cheddar','parmesan','brie','cottage cheese','feta','ricotta','cream cheese']},
      {name:'Aisle 3 ‚Äì Meat & Seafood',keywords:['chicken','beef','pork','salmon','tuna','shrimp','turkey','lamb','steak','ground beef','bacon','sausage','ham','cod','tilapia','fish','meat','prosciutto','deli']},
      {name:'Aisle 4 ‚Äì Bread & Bakery',keywords:['bread','bagel','muffin','croissant','bun','roll','tortilla','pita','sourdough','baguette','wrap','english muffin','loaf','brioche']},
      {name:'Aisle 5 ‚Äì Pantry',        keywords:['pasta','rice','flour','sugar','salt','olive oil','oil','vinegar','sauce','soup','beans','lentil','quinoa','oats','cereal','granola','honey','jam','peanut butter','crackers','chips','nuts','almonds','cashews','broth','stock','baking soda','baking powder','vanilla','cocoa','chocolate','canned']},
      {name:'Aisle 6 ‚Äì Beverages',     keywords:['water','juice','soda','coffee','tea','wine','beer','sparkling','kombucha','almond milk','oat milk','soy milk','lemonade','cider','espresso','matcha']},
      {name:'Aisle 7 ‚Äì Frozen',        keywords:['frozen','ice cream','pizza','edamame','peas','corn','veggie burger','french fries','waffles','sorbet','gelato','burritos']},
      {name:'Aisle 8 ‚Äì Personal Care', keywords:['shampoo','conditioner','soap','lotion','toothpaste','toothbrush','deodorant','razors','sunscreen','vitamins','supplements','medicine','floss','mouthwash','moisturizer']},
    ],
    list: [], corrections: {}
  };
  await setDoc(doc(db, 'stores', id), demo);
  state.stores = [{...demo, id, isShared: false}];
  state.lists[id] = [];
  state.corrections[id] = {};
  state.activeStoreId = id;
  renderAll();
  setSyncDot('ok');

  // subscribe
  window._storeUnsubs.push(
    window._fb.onSnapshot(window._fb.doc(db, 'stores', id), (d) => {
      if (!d.exists()) return;
      if (window._isSaving) return;
      const data = d.data();
      const idx = state.stores.findIndex(s => s.id === d.id);
      if (idx !== -1) {
        state.stores[idx] = { ...state.stores[idx], name: data.name, color: data.color,
          aisles: data.aisles || [], members: data.members || [], shareCode: data.shareCode || null };
        state.lists[d.id]       = data.list        || [];
        state.corrections[d.id] = data.corrections || {};
        renderAll();
      }
    })
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE TO FIRESTORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.persistStore = async function(storeId) {
  if (!window._currentUser) return;
  const { db, doc, updateDoc } = window._fb;
  const store = state.stores.find(s => s.id === storeId);
  if (!store) return;
  setSyncDot('syncing');
  window._isSaving = true;
  try {
    await updateDoc(doc(db, 'stores', storeId), {
      name: store.name, color: store.color, aisles: store.aisles,
      list: state.lists[storeId] || [],
      corrections: state.corrections[storeId] || {}
    });
    setSyncDot('ok');
  } catch(e) {
    console.error('Sync error', e);
    setSyncDot('error');
  } finally {
    setTimeout(() => { window._isSaving = false; }, 1500);
  }
};

window.createStoreInFirestore = async function(storeData) {
  if (!window._currentUser) return storeData.id;
  const { db, doc, setDoc, serverTimestamp, onSnapshot } = window._fb;
  const uid = window._currentUser.uid;
  setSyncDot('syncing');
  await setDoc(doc(db, 'stores', storeData.id), {
    ownerUid: uid, members: [], shareCode: null,
    name: storeData.name, color: storeData.color, aisles: storeData.aisles,
    list: [], corrections: {}, createdAt: serverTimestamp()
  });
  setSyncDot('ok');
  // subscribe
  window._storeUnsubs.push(
    onSnapshot(doc(db, 'stores', storeData.id), (d) => {
      if (!d.exists()) return;
      if (window._isSaving) return;
      const data = d.data();
      const idx = state.stores.findIndex(s => s.id === d.id);
      if (idx !== -1) {
        state.stores[idx] = { ...state.stores[idx], name: data.name, color: data.color,
          aisles: data.aisles || [], members: data.members || [], shareCode: data.shareCode || null };
        state.lists[d.id]       = data.list        || [];
        state.corrections[d.id] = data.corrections || {};
        renderAll();
      }
    })
  );
  return storeData.id;
};

window.deleteStoreFromFirestore = async function(storeId) {
  if (!window._currentUser) return;
  const { db, doc, deleteDoc } = window._fb;
  await deleteDoc(doc(db, 'stores', storeId));
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARE STORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.generateShareCode = async function(storeId) {
  if (!window._currentUser) return;
  const { db, doc, updateDoc } = window._fb;
  // Generate a random 6-char code ‚Äî collision probability is negligible
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const code = Array.from({length:6}, () => chars[Math.floor(Math.random()*chars.length)]).join('');
  await updateDoc(doc(db, 'stores', storeId), { shareCode: code });
  const idx = state.stores.findIndex(s => s.id === storeId);
  if (idx !== -1) state.stores[idx].shareCode = code;
  return code;
};

window.openShareStoreModal = async function(storeId) {
  const store = state.stores.find(s => s.id === storeId);
  if (!store) return;
  let code = store.shareCode;
  if (!code) {
    showProcessing('Generating share code‚Ä¶');
    code = await window.generateShareCode(storeId);
    hideProcessing();
  }
  document.getElementById('share-code-display').textContent = code;
  document.getElementById('share-code-display').dataset.storeId = storeId;
  openModal('modal-share-store');
};

window.copyShareCode = function() {
  const code = document.getElementById('share-code-display').textContent;
  navigator.clipboard.writeText(code).then(() => showToast('Code copied ‚úì')).catch(()=>{
    showToast('Code: ' + code);
  });
};

window.joinStoreByCode = async function() {
  if (!window._currentUser) return;
  const { db, collection, query, where, getDocs, doc, updateDoc, arrayUnion, onSnapshot } = window._fb;
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  if (code.length < 4) { showToast('Enter a valid code'); return; }
  showProcessing('Looking up store‚Ä¶');
  try {
    const q = query(collection(db,'stores'), where('shareCode','==',code));
    const snap = await getDocs(q);
    if (snap.empty) { hideProcessing(); showToast('No store found with that code'); return; }
    const storeDoc = snap.docs[0];
    const uid = window._currentUser.uid;
    if (storeDoc.data().ownerUid === uid || (storeDoc.data().members||[]).includes(uid)) {
      hideProcessing(); showToast('You already have access to this store'); return;
    }
    await updateDoc(doc(db,'stores',storeDoc.id), { members: arrayUnion(uid) });
    // subscribe and load
    const data = storeDoc.data();
    state.stores.push({
      id: storeDoc.id, name: data.name, color: data.color, aisles: data.aisles||[],
      ownerUid: data.ownerUid, members: [...(data.members||[]), uid],
      shareCode: data.shareCode, isShared: true
    });
    state.lists[storeDoc.id]       = data.list        || [];
    state.corrections[storeDoc.id] = data.corrections || {};
    if (!state.activeStoreId) state.activeStoreId = storeDoc.id;
    window._storeUnsubs.push(
      onSnapshot(doc(db,'stores',storeDoc.id), (d) => {
        if (!d.exists()) return;
        if (window._isSaving) return;
        const dd = d.data();
        const idx = state.stores.findIndex(s => s.id === d.id);
        if (idx !== -1) {
          state.stores[idx] = { ...state.stores[idx], name: dd.name, color: dd.color,
            aisles: dd.aisles||[], members: dd.members||[], shareCode: dd.shareCode||null };
          state.lists[d.id]       = dd.list        || [];
          state.corrections[d.id] = dd.corrections || {};
          renderAll();
        }
      })
    );
    renderAll();
    hideProcessing();
    closeModal('modal-profile');
    document.getElementById('join-code-input').value = '';
    showToast(`Joined "${data.name}" ‚úì`);
  } catch(e) {
    hideProcessing();
    console.error(e);
    showToast('Could not join store ‚Äî try again');
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH ACTIONS (exposed globally)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.signInEmail = async function() {
  const { auth, signInWithEmailAndPassword } = window._fb;
  const email = document.getElementById('signin-email').value.trim();
  const pass  = document.getElementById('signin-password').value;
  const errEl = document.getElementById('auth-error-signin');
  errEl.classList.remove('show');
  if (!email || !pass) { showAuthError('signin','Please fill in all fields'); return; }
  document.getElementById('btn-signin').disabled = true;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    showAuthError('signin', friendlyAuthError(e.code));
  }
  document.getElementById('btn-signin').disabled = false;
};

window.signUpEmail = async function() {
  const { auth, createUserWithEmailAndPassword, updateProfile } = window._fb;
  const name    = document.getElementById('signup-name').value.trim();
  const email   = document.getElementById('signup-email').value.trim();
  const pass    = document.getElementById('signup-password').value;
  const confirm = document.getElementById('signup-password-confirm').value;
  if (!name || !email || !pass || !confirm) { showAuthError('signup','Please fill in all fields'); return; }
  if (pass.length < 6)  { showAuthError('signup','Password must be at least 6 characters'); return; }
  if (pass !== confirm) { showAuthError('signup','Passwords do not match'); return; }
  document.getElementById('btn-signup').disabled = true;
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name });
  } catch(e) {
    showAuthError('signup', friendlyAuthError(e.code));
  }
  document.getElementById('btn-signup').disabled = false;
};

window.signInGoogle = async function() {
  const { auth, GoogleAuthProvider, signInWithPopup } = window._fb;
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  } catch(e) {
    if (e.code !== 'auth/popup-closed-by-user') {
      showAuthError('signin', friendlyAuthError(e.code));
    }
  }
};

window.togglePw = function togglePw(inputId, btn) {
  const input = document.getElementById(inputId);
  const show  = input.type === 'password';
  input.type  = show ? 'text' : 'password';
  btn.innerHTML = show ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
  btn.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
}

window.showForgotPassword = function() {
  document.querySelectorAll('.auth-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('auth-panel-forgot').classList.add('active');
  document.getElementById('auth-error-forgot').classList.remove('show');
  document.getElementById('auth-success-forgot').classList.remove('show');
  const emailFromSignIn = document.getElementById('signin-email').value.trim();
  if (emailFromSignIn) document.getElementById('forgot-email').value = emailFromSignIn;
};

window.sendResetEmail = async function() {
  const { auth, sendPasswordResetEmail } = window._fb;
  const email = document.getElementById('forgot-email').value.trim();
  const errEl = document.getElementById('auth-error-forgot');
  const sucEl = document.getElementById('auth-success-forgot');
  errEl.classList.remove('show');
  sucEl.classList.remove('show');

  if (!email) { showAuthError('forgot', 'Please enter your email address.'); return; }

  const btn = document.getElementById('btn-forgot');
  btn.disabled = true;
  btn.textContent = 'Sending‚Ä¶';

  try {
    await sendPasswordResetEmail(auth, email);
    sucEl.textContent = 'Reset link sent! Check your inbox (and spam folder).';
    sucEl.classList.add('show');
    document.getElementById('forgot-email').value = '';
  } catch(e) {
    showAuthError('forgot', friendlyAuthError(e.code));
  } finally {
    btn.disabled = false;
    btn.textContent = 'Send Reset Link';
  }
};

window.changePassword = async function() {
  const { auth, updatePassword, reauthenticateWithCredential, EmailAuthProvider } = window._fb;
  const user        = window._currentUser;
  const currentPass = document.getElementById('current-password').value;
  const newPass     = document.getElementById('new-password').value;
  const confirmPass = document.getElementById('confirm-password').value;
  const msgEl       = document.getElementById('change-pass-msg');

  const showMsg = (text, isError) => {
    msgEl.textContent = text;
    msgEl.style.display  = 'block';
    msgEl.style.background = isError ? 'rgba(239,68,68,.12)' : 'rgba(34,197,94,.12)';
    msgEl.style.color      = isError ? '#f87171' : '#4ade80';
    msgEl.style.border     = isError ? '1px solid rgba(239,68,68,.25)' : '1px solid rgba(34,197,94,.25)';
    msgEl.style.borderRadius = '8px';
    msgEl.style.padding    = '8px 12px';
  };

  msgEl.style.display = 'none';
  if (!currentPass || !newPass || !confirmPass) { showMsg('Please fill in all fields.', true); return; }
  if (newPass.length < 6) { showMsg('New password must be at least 6 characters.', true); return; }
  if (newPass !== confirmPass) { showMsg('New passwords do not match.', true); return; }
  if (!user || !user.email) { showMsg('Please sign out and sign back in to change your password.', true); return; }

  const btn = document.getElementById('btn-change-pass');
  btn.disabled = true;
  btn.textContent = 'Updating‚Ä¶';

  try {
    const credential = EmailAuthProvider.credential(user.email, currentPass);
    await reauthenticateWithCredential(user, credential);
    await updatePassword(user, newPass);
    showMsg('Password updated successfully!', false);
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
  } catch(e) {
    if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
      showMsg('Current password is incorrect.', true);
    } else if (e.code === 'auth/requires-recent-login') {
      showMsg('Please sign out and sign back in, then try again.', true);
    } else {
      showMsg(friendlyAuthError(e.code), true);
    }
  } finally {
    btn.disabled = false;
    btn.textContent = 'Update Password';
  }
};

window.signOut = async function() {
  const { auth, fbSignOut } = window._fb;
  await fbSignOut(auth);
  // Reset state
  state.stores=[]; state.lists={}; state.corrections={};
  state.activeStoreId=null;
  closeModal('modal-profile');
  renderAll();
};

// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ
function showAuthError(panel, msg) {
  const el = document.getElementById('auth-error-' + panel);
  el.textContent = msg;
  el.classList.add('show');
}

function friendlyAuthError(code) {
  const map = {
    'auth/user-not-found':'No account found with that email.',
    'auth/wrong-password':'Incorrect password.',
    'auth/email-already-in-use':'An account with this email already exists.',
    'auth/invalid-email':'Please enter a valid email address.',
    'auth/weak-password':'Password is too weak ‚Äî use at least 6 characters.',
    'auth/invalid-credential':'Invalid email or password.',
    'auth/too-many-requests':'Too many attempts. Please wait and try again.',
    'auth/network-request-failed':'Network error. Check your connection.',
  };
  return map[code] || 'Something went wrong. Please try again.';
}

// ‚îÄ‚îÄ sync dot UI ‚îÄ‚îÄ
function setSyncDot(status) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (status === 'syncing' ? ' syncing' : status === 'error' ? ' error' : '');
  dot.title = status === 'syncing' ? 'Syncing‚Ä¶' : status === 'error' ? 'Sync error' : 'Synced';
}
window.setSyncDot = setSyncDot;

// Signal that the Firebase module is fully loaded
window._fbReady = true;

// ‚îÄ‚îÄ Browser back/forward navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ Browser back/forward navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Strategy: always keep a "floor" sentinel entry at the bottom of the stack.
// On load we push: [sentinel] [list]. When back is pressed and we reach
// sentinel, we handle it and immediately re-push [list] so there's always
// something below us. This prevents the browser from ever leaving the app.

function pushAppState(state) {
  history.pushState(state, '', '');
}

// Push sentinel + initial screen on page load
history.replaceState({ type: 'sentinel' }, '', '');
history.pushState({ type: 'screen', screen: 'list' }, '', '');

window.addEventListener('popstate', function(e) {
  const state = e.state;

  // ‚îÄ‚îÄ Close open modal first ‚îÄ‚îÄ
  const openOverlay = document.querySelector('.modal-overlay.open');
  if (openOverlay) {
    openOverlay.classList.remove('open');
    // Re-push current screen state so forward/back remain meaningful
    const screen = document.querySelector('.screen.active')?.id?.replace('screen-', '') || 'list';
    history.pushState({ type: 'screen', screen }, '', '');
    return;
  }

  // ‚îÄ‚îÄ Hit the sentinel ‚Äî re-push so we never fall out of the app ‚îÄ‚îÄ
  if (!state || state.type === 'sentinel') {
    history.pushState({ type: 'screen', screen: 'list' }, '', '');
    switchScreen('list', false);
    return;
  }

  // ‚îÄ‚îÄ Screen navigation ‚îÄ‚îÄ
  if (state.type === 'screen') {
    switchScreen(state.screen, false);
  }
});

</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTAISLE STORE LIBRARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//
// Each chain entry has:
//   id          ‚Äì stable identifier (never changes)
//   name        ‚Äì display name
//   type        ‚Äì 'grocery' | 'pharmacy' | 'hardware' | etc. (extensible)
//   color       ‚Äì suggested app color
//   searchNames ‚Äì strings used to fuzzy-match against Google Places results
//   dataSource  ‚Äì 'real' (from official docs) | 'curated' (researched typical layout)
//   aisles      ‚Äì array of {name, keywords[]}
//   stores      ‚Äì optional per-location overrides keyed by place_id or store #
//
// AISLE NUMBER NOTE:
//   Market Basket PDFs use actual numbered aisles. For other chains we use
//   logical department sections (Produce, Dairy, etc.) which is how those
//   stores actually sign their departments.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const STORE_LIBRARY = {

  // ‚îÄ‚îÄ CATEGORY: GROCERY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  grocery: [

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MARKET BASKET
    // Source: Official per-store Shopper's Guides (PDFs)
    // shopmarketbasket.com/market-basket-stores-shoppers-guide-by-state/
    //
    // Aisle assignments derived from 3 stores: #89 Warwick RI, #90 Johnston RI,
    // #24 Burlington MA. Aisle numbers vary by location; this uses the CATEGORY
    // groupings that are consistent across all stores, with typical aisle names.
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'market-basket',
      name: 'Market Basket',
      type: 'grocery',
      color: '#e63329',
      searchNames: ['market basket', 'demoulas', 'demoulas market basket'],
      dataSource: 'real',
      aisles: [
        {
          name: 'Aisle 1 ‚Äì Dairy & Deli',
          keywords: [
            'milk','butter','eggs','cottage cheese','sour cream','cream cheese',
            'cheese','cheddar','mozzarella','parmesan','brie','feta','ricotta',
            'grated parmesan','prepackaged cheese','swiss','american cheese',
            'half and half','heavy cream','whipped cream','kefir'
          ]
        },
        {
          name: 'Aisle 2 ‚Äì Soup, Canned Fish & Condiments',
          keywords: [
            'soup','chowder','clam chowder','corn chowder','potato chowder',
            'bouillon','bouillon cubes','noodles','egg noodles','ramen noodles',
            'canned fish','clams','canned clams','canned tuna','tuna','sardines',
            'canned meat','canned chicken','spam','canned salmon',
            'chinese food','asian canned','soy sauce',
            'mexican food','taco sauce','taco shells','barbecue sauce','bbq sauce',
            'ketchup','mustard','mayonnaise','mayo','salad dressing','ranch',
            'vinegar','hot sauce','tabasco','tartar sauce','steak sauce',
            'olives','pickles','capers','relish','croutons',
            'chili sauce','worcestershire','baked beans','canned beans'
          ]
        },
        {
          name: 'Aisle 3 ‚Äì Pasta, Rice & Sauce',
          keywords: [
            'pasta','spaghetti','penne','rigatoni','fettuccine','linguine',
            'noodles','macaroni','mac and cheese','mac & cheese','lasagna',
            'rice','white rice','brown rice','rice cakes','rice pilaf',
            'spaghetti sauce','pasta sauce','marinara','tomato sauce',
            'tomato paste','canned tomato','tomato',
            'bread crumbs','breadcrumbs','hamburger helper',
            'beans','kidney beans','black beans','chickpeas','lentils',
            'dry beans'
          ]
        },
        {
          name: 'Aisle 4 ‚Äì Breakfast & Cereal',
          keywords: [
            'cereal','granola','granola bars','oatmeal','oats',
            'pop tarts','toaster pastries','breakfast bars',
            'grits','cream of wheat','instant oatmeal',
            'rice cakes','wheat germ','muesli',
            'pancake mix','waffle mix','bisquick','baking mix',
            'maple syrup','syrup','honey','jam','jelly','peanut butter',
            'nutella','almond butter','nut butter'
          ]
        },
        {
          name: 'Aisle 5 ‚Äì Baking',
          keywords: [
            'flour','sugar','brown sugar','powdered sugar','confectioners sugar',
            'baking soda','baking powder','yeast','cornstarch',
            'vanilla extract','vanilla','food coloring',
            'cake mix','brownie mix','muffin mix','bread mix',
            'pie filling','pudding mix','jello','gelatin',
            'shortening','vegetable shortening','crisco',
            'chocolate chips','cocoa powder','baking chocolate',
            'spices','salt','pepper','cinnamon','nutmeg','garlic powder',
            'onion powder','paprika','cumin','oregano','basil','thyme',
            'coffee','ground coffee','instant coffee','tea','tea bags',
            'nuts baking','baking nuts','walnuts','pecans',
            'molasses','corn syrup','cooking oil','canola oil','vegetable oil',
            'olive oil','coconut oil'
          ]
        },
        {
          name: 'Aisle 6 ‚Äì Canned Vegetables & Fruit',
          keywords: [
            'canned vegetables','canned corn','canned green beans','canned peas',
            'canned carrots','canned beets','canned spinach','artichoke hearts',
            'canned fruit','canned peaches','canned pears','canned pineapple',
            'canned cherries','fruit cocktail','applesauce','apple sauce',
            'cranberry sauce','cranberry','pie filling cherry',
            'dried fruit','raisins','prunes','dried cranberries','dried apricots',
            'dates','currants','figs','dried figs',
            'snack nuts','mixed nuts','cashews','almonds','peanuts','trail mix',
            'popcorn','popping corn','potato chips','chips','pretzels',
            'candy','chocolate','m&ms','gummies','crackers snack','snacks',
            'molasses','honey','jam','jelly'
          ]
        },
        {
          name: 'Aisle 7 ‚Äì Gravy, Mushrooms & Juice',
          keywords: [
            'gravy','gravy mix','brown gravy','turkey gravy','chicken gravy',
            'mushrooms canned','canned mushrooms',
            'vegetables canned','mixed vegetables',
            'juice','apple juice','orange juice','cranberry juice','grape juice',
            'tomato juice','v8','lemonade','fruit punch',
            'canned potatoes','potato canned'
          ]
        },
        {
          name: 'Aisle 8 ‚Äì Coffee, Tea & Household Supplies',
          keywords: [
            'aluminum foil','foil','plastic wrap','saran wrap','wax paper',
            'freezer bags','sandwich bags','ziploc','storage bags','trash bags',
            'garbage bags','paper towels','napkins','plastic cups','paper plates',
            'straws','toothpicks','plasticware','plastic utensils',
            'kitchen utensils','kitchen tools','bakeware','cooking tools'
          ]
        },
        {
          name: 'Aisle 9 ‚Äì Soda & Water',
          keywords: [
            'soda','cola','pepsi','coke','sprite','ginger ale','root beer',
            'sparkling water','seltzer','tonic water',
            'water','spring water','distilled water','bottled water',
            'sports drinks','gatorade','powerade','vitamin water',
            'energy drinks','red bull','monster',
            'kool aid','drink mix','iced tea mix','lemonade mix'
          ]
        },
        {
          name: 'Aisle 10 ‚Äì Pet & Automotive',
          keywords: [
            'dog food','cat food','pet food','cat litter','dog treats','cat treats',
            'pet supplies','bird food','fish food','aquarium',
            'charcoal','lighter fluid','bug spray','insect repellent',
            'automotive','motor oil','windshield washer','car supplies',
            'bug killer','ant trap','mouse trap','pest control'
          ]
        },
        {
          name: 'Aisle 11 ‚Äì Health & Baby',
          keywords: [
            'baby food','baby formula','diapers','wipes','baby powder','baby lotion',
            'cold remedies','cough syrup','cold medicine','aspirin','ibuprofen',
            'tylenol','vitamins','supplements','eye care','eye drops',
            'bandages','first aid','band-aids','antiseptic','hydrogen peroxide',
            'rubbing alcohol','laxative','antacid','tums',
            'feminine hygiene','pads','tampons','feminine needs',
            'shaving cream','razors','razor blades','shaving needs',
            'shoe care','shoe polish'
          ]
        },
        {
          name: 'Aisle 12 ‚Äì Personal Care',
          keywords: [
            'shampoo','conditioner','hair care','hair spray','hair gel',
            'soap','body wash','hand soap','bar soap','liquid soap',
            'deodorant','antiperspirant',
            'toothpaste','toothbrush','floss','mouthwash','dental care',
            'lotion','moisturizer','body lotion','hand cream','sunscreen',
            'bath tissue','toilet paper','facial tissue','kleenex','tissues',
            'paper towels','napkins','paper plates','paper cups',
            'batteries','lightbulbs','electrical supplies','stationery'
          ]
        },
        {
          name: 'Aisle 13 ‚Äì Cleaning & Laundry',
          keywords: [
            'laundry detergent','tide','laundry soap','fabric softener','dryer sheets',
            'bleach','stain remover','oxygen cleaner',
            'dish soap','dishwasher detergent','cascade','dawn',
            'household cleaner','all-purpose cleaner','lysol','windex','409',
            'disinfectant','disinfecting wipes','clorox',
            'drain cleaner','drano','broom','mop','sponges','scrub brush',
            'rubber gloves','steel wool','vacuum bags',
            'air freshener','febreze','candles household',
            'ammonia','pine sol','floor cleaner'
          ]
        },
        {
          name: 'Aisle 14 ‚Äì Bread & Bakery',
          keywords: [
            'bread','white bread','wheat bread','sourdough','rye bread',
            'bagels','english muffins','pita','tortillas','wraps','flatbread',
            'rolls','dinner rolls','hamburger buns','hot dog buns',
            'muffins','donuts','croissants','pastries','danish',
            'cookies','crackers','graham crackers',
            'stuffing mix','breadcrumbs','croutons'
          ]
        },
        {
          name: 'Frozen Foods',
          keywords: [
            'frozen','frozen vegetables','frozen peas','frozen corn','frozen broccoli',
            'frozen fruit','frozen berries','frozen meals','tv dinner',
            'frozen pizza','frozen burritos','frozen entrees',
            'ice cream','ice cream bars','popsicles','sorbet','frozen yogurt',
            'frozen waffles','frozen pancakes','frozen breakfast',
            'frozen fish','frozen shrimp','frozen chicken','frozen meat',
            'edamame','frozen edamame','ice cubes'
          ]
        },
        {
          name: 'Produce',
          keywords: [
            'apple','apples','banana','bananas','orange','oranges','lemon','limes',
            'grapes','strawberries','blueberries','raspberries','blackberries',
            'peach','pear','mango','pineapple','watermelon','cantaloupe','melon',
            'avocado','tomato','tomatoes','cucumber','zucchini','squash',
            'broccoli','cauliflower','lettuce','spinach','kale','arugula','chard',
            'cabbage','brussels sprouts','asparagus','green beans','snap peas',
            'carrot','carrots','celery','bell pepper','peppers','jalape√±o',
            'onion','onions','garlic','shallots','leeks','scallions',
            'potato','potatoes','sweet potato','yam','corn on the cob',
            'mushrooms fresh','fresh mushrooms','herbs','cilantro','parsley','basil fresh',
            'ginger fresh','fresh ginger','lemongrass'
          ]
        },
        {
          name: 'Meat & Seafood',
          keywords: [
            'chicken','chicken breast','chicken thighs','whole chicken','rotisserie',
            'ground beef','hamburger','steak','beef','chuck','sirloin','ribeye',
            'pork','pork chops','pork loin','ribs','bacon','ham','sausage',
            'turkey','turkey breast','ground turkey',
            'lamb','lamb chops','veal',
            'salmon','tuna fresh','cod','tilapia','halibut','shrimp','scallops',
            'lobster','crab','clams fresh','oysters','mussels',
            'deli meat','sliced turkey','sliced ham','prosciutto','salami',
            'hot dogs','bratwurst','kielbasa'
          ]
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WHOLE FOODS MARKET
    // Source: Curated based on Whole Foods department structure
    // Whole Foods uses department labels rather than aisle numbers
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'whole-foods',
      name: 'Whole Foods Market',
      type: 'grocery',
      color: '#00674b',
      searchNames: ['whole foods','whole foods market','whole foods co'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','grape','berries','strawberry','blueberry','raspberry',
            'lettuce','spinach','kale','arugula','chard','cabbage','broccoli','cauliflower',
            'carrot','celery','cucumber','zucchini','squash','pepper','jalape√±o',
            'tomato','avocado','lemon','lime','mango','pineapple','watermelon','melon',
            'onion','garlic','shallot','scallion','ginger','herbs','cilantro','parsley','basil',
            'potato','sweet potato','yam','mushroom','corn','asparagus','green beans','peas snap']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','oat milk','almond milk','soy milk','coconut milk',
            'butter','ghee','eggs','egg','heavy cream','half and half','sour cream',
            'yogurt','greek yogurt','kefir','cottage cheese',
            'cheese','cheddar','mozzarella','parmesan','brie','feta','goat cheese',
            'cream cheese','ricotta','gouda','manchego','camembert']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','beef','pork','lamb','turkey','bison',
            'bacon','sausage','ham','prosciutto','pancetta','deli meat',
            'salmon','tuna','cod','halibut','tilapia','shrimp','scallops','crab','lobster',
            'hot dogs','bratwurst','chorizo']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','sourdough','baguette','multigrain','rye',
            'bagel','english muffin','pita','tortilla','wrap','flatbread',
            'croissant','muffin','scone','danish','pastry','cookie bakery',
            'rolls','buns','focaccia','naan','lavash']
        },
        {
          name: 'Pantry Staples',
          keywords: ['pasta','spaghetti','penne','fettuccine','linguine','orzo','lasagna',
            'rice','brown rice','white rice','wild rice','quinoa','farro','barley','bulgur',
            'flour','sugar','baking soda','baking powder','yeast','cornstarch','vanilla',
            'olive oil','avocado oil','coconut oil','canola oil','sesame oil',
            'vinegar','apple cider vinegar','balsamic','red wine vinegar',
            'soy sauce','tamari','fish sauce','oyster sauce','miso',
            'pasta sauce','marinara','tomato sauce','tomato paste','crushed tomato',
            'broth','chicken broth','vegetable broth','bone broth',
            'beans','lentils','chickpeas','black beans','kidney beans',
            'canned tomato','canned fish','canned salmon','canned tuna',
            'nut butter','peanut butter','almond butter','tahini',
            'honey','maple syrup','agave','jam','jelly','preserves']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','muesli','oatmeal','oats','overnight oats',
            'granola bars','protein bars','energy bars','trail mix',
            'pancake mix','waffle mix','syrup','maple syrup']
        },
        {
          name: 'Snacks & Chips',
          keywords: ['chips','tortilla chips','potato chips','pretzels','popcorn',
            'crackers','rice crackers','nut mix','almonds','cashews','walnuts','pecans',
            'dried fruit','raisins','dates','jerky','beef jerky',
            'chocolate','dark chocolate','candy','gummies']
        },
        {
          name: 'Beverages',
          keywords: ['water','sparkling water','kombucha','cold brew','juice','orange juice',
            'coffee','espresso','tea','green tea','herbal tea','matcha',
            'soda','sparkling juice','coconut water','sports drink',
            'wine','beer','cider','hard seltzer']
        },
        {
          name: 'Frozen',
          keywords: ['frozen vegetables','frozen fruit','frozen berries','frozen meals',
            'frozen pizza','frozen burritos','frozen fish','frozen shrimp',
            'ice cream','sorbet','frozen yogurt','popsicles',
            'frozen waffles','frozen breakfast','edamame']
        },
        {
          name: 'Health & Body Care',
          keywords: ['vitamins','supplements','protein powder','collagen','probiotics',
            'shampoo','conditioner','body wash','soap','lotion','sunscreen',
            'toothpaste','toothbrush','floss','deodorant','razor',
            'pain reliever','ibuprofen','aspirin','cold medicine']
        },
        {
          name: 'Cleaning & Household',
          keywords: ['dish soap','dishwasher','laundry detergent','fabric softener','dryer sheets',
            'all-purpose cleaner','bleach','disinfectant wipes','sponge','trash bags',
            'paper towels','toilet paper','facial tissue','aluminum foil','plastic wrap',
            'sandwich bags','ziploc','storage bags']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TRADER JOE'S
    // Source: Curated ‚Äî TJ's has no numbered aisles; uses open floor plan
    // with consistent section groupings. Products organized by section/zone.
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'trader-joes',
      name: "Trader Joe's",
      type: 'grocery',
      color: '#c8102e',
      searchNames: ["trader joe's","trader joes","tj's"],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Fresh Produce',
          keywords: ['apple','banana','orange','lemon','lime','avocado','mango',
            'lettuce','spinach','kale','arugula','bagged salad','salad kit',
            'broccoli','cauliflower','carrot','celery','cucumber','zucchini',
            'tomato','pepper','onion','garlic','ginger','herbs','cilantro','basil',
            'mushroom','potato','sweet potato','berries','grapes','melon']
        },
        {
          name: 'Fresh Meat & Seafood',
          keywords: ['chicken','ground beef','steak','pork','lamb','turkey',
            'salmon','cod','shrimp','scallops','tuna steak',
            'sausage','chicken sausage','bratwurst','merguez',
            'bacon','prosciutto','pancetta','deli']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','oat milk','almond milk','soy milk','eggs',
            'butter','cream cheese','sour cream','yogurt','greek yogurt',
            'cheese','cheddar','brie','goat cheese','feta','manchego',
            'cottage cheese','ricotta','heavy cream','half and half']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','sourdough','brioche','multigrain','baguette',
            'pita','naan','tortillas','flatbread','lavash',
            'bagel','english muffin','croissant','muffin','scone',
            'rolls','buns','challah','raisin bread']
        },
        {
          name: 'Refrigerated & Prepared',
          keywords: ['hummus','salsa','guacamole','tzatziki','dips',
            'pasta fresh','fresh pasta','gnocchi','pizza dough',
            'soup refrigerated','chilled soup','tofu','tempeh',
            'salad dressing refrigerated','pesto fresh',
            'orange juice fresh','lemonade fresh','cold brew']
        },
        {
          name: 'Frozen',
          keywords: ['frozen','mandarin chicken','orange chicken','palak paneer',
            'frozen burritos','frozen pizza','frozen meals','frozen entrees',
            'frozen vegetables','edamame','peas','corn','broccoli frozen',
            'frozen fish','frozen shrimp','frozen fruit','frozen berries',
            'ice cream','sorbet','frozen yogurt','mochi','popsicles',
            'frozen waffles','hash browns','tater tots','cauliflower gnocchi']
        },
        {
          name: 'Pantry & Dry Goods',
          keywords: ['pasta','spaghetti','penne','rice','quinoa','farro','lentils',
            'beans','canned tomato','tomato sauce','pasta sauce','olive oil','coconut oil',
            'soy sauce','coconut aminos','broth','chicken broth','vegetable broth',
            'flour','sugar','honey','maple syrup','jam','jelly','nut butter',
            'peanut butter','almond butter','sunflower butter','tahini']
        },
        {
          name: 'Cereal, Snacks & Nuts',
          keywords: ['granola','cereal','oatmeal','bars','granola bars','protein bars',
            'chips','kettle chips','tortilla chips','pretzels','popcorn','pita chips',
            'crackers','rice crackers','almond crackers',
            'nuts','almonds','cashews','walnuts','trail mix','dried fruit',
            'chocolate','dark chocolate','candy','gummies','cookies']
        },
        {
          name: 'Wine, Beer & Beverages',
          keywords: ['wine','red wine','white wine','prosecco','champagne',
            'beer','ipa','lager','cider','hard seltzer',
            'water','sparkling water','juice','kombucha','cold brew',
            'tea','coffee','coconut water']
        },
        {
          name: 'Health & Wellness',
          keywords: ['vitamins','supplements','protein powder','collagen','magnesium',
            'shampoo','conditioner','body wash','lotion','sunscreen',
            'toothpaste','deodorant','face wash','hand soap']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STOP & SHOP
    // Source: Curated based on published department structure
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'stop-and-shop',
      name: 'Stop & Shop',
      type: 'grocery',
      color: '#d4001a',
      searchNames: ['stop and shop','stop & shop','stop&shop'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','lemon','lime','avocado','tomato','cucumber',
            'lettuce','spinach','kale','broccoli','cauliflower','carrot','celery',
            'pepper','onion','garlic','mushroom','potato','sweet potato','corn',
            'grapes','berries','strawberry','blueberry','mango','pineapple','watermelon',
            'herbs','cilantro','parsley','ginger','zucchini','squash','asparagus']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','beef','pork','lamb','turkey',
            'bacon','sausage','ham','deli meat','hot dogs',
            'salmon','tuna','cod','shrimp','tilapia','scallops','lobster','crab']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','cheddar','american cheese','swiss',
            'sour cream','cream cheese','yogurt','greek yogurt','cottage cheese',
            'heavy cream','half and half','almond milk','oat milk','soy milk']
        },
        {
          name: 'Deli & Prepared Foods',
          keywords: ['deli turkey','deli ham','sliced cheese','prosciutto','salami',
            'rotisserie chicken','prepared meals','soup deli','prepared food',
            'olives deli','pickles deli','hummus refrigerated']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','sourdough','white bread','wheat bread','rye',
            'bagels','english muffins','rolls','buns','tortillas','pita','wraps',
            'croissant','muffin','danish','cake','pie bakery','cookies bakery']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','oatmeal','oats','granola bars','breakfast bars',
            'pop tarts','toaster pastries','syrup','maple syrup','pancake mix','waffle mix']
        },
        {
          name: 'Canned & Jarred Goods',
          keywords: ['soup','chicken broth','vegetable broth','beef broth',
            'canned tomato','tomato paste','tomato sauce','marinara','pasta sauce',
            'canned beans','black beans','kidney beans','chickpeas','baked beans',
            'canned corn','canned peas','canned green beans','canned carrots',
            'canned fruit','peaches','pears','pineapple','fruit cocktail',
            'canned tuna','canned salmon','canned clams','sardines',
            'olives','pickles','salsa','applesauce']
        },
        {
          name: 'Pasta, Rice & Grains',
          keywords: ['pasta','spaghetti','penne','rotini','fettuccine','lasagna',
            'mac and cheese','mac & cheese','noodles',
            'rice','brown rice','white rice','quinoa','couscous','barley',
            'stuffing mix','bread mix','polenta','grits']
        },
        {
          name: 'Baking',
          keywords: ['flour','sugar','brown sugar','baking soda','baking powder',
            'vanilla extract','yeast','cornstarch','shortening',
            'cake mix','brownie mix','muffin mix','cookie mix',
            'chocolate chips','cocoa','spices','salt','pepper','cinnamon',
            'honey','jam','jelly','peanut butter','almond butter','nutella']
        },
        {
          name: 'Condiments & Oils',
          keywords: ['ketchup','mustard','mayo','mayonnaise','ranch','salad dressing',
            'olive oil','vegetable oil','canola oil','cooking spray',
            'vinegar','balsamic','soy sauce','hot sauce','sriracha','bbq sauce',
            'worcestershire','fish sauce','teriyaki']
        },
        {
          name: 'Snacks & Chips',
          keywords: ['chips','potato chips','tortilla chips','pretzels','popcorn',
            'crackers','cheese crackers','graham crackers','rice cakes',
            'nuts','almonds','cashews','mixed nuts','trail mix',
            'dried fruit','raisins','fruit snacks','granola bars',
            'cookies','candy','chocolate','gummies']
        },
        {
          name: 'Beverages',
          keywords: ['water','sparkling water','soda','pepsi','coke','ginger ale',
            'juice','apple juice','orange juice','cranberry juice',
            'coffee','tea','green tea','iced tea',
            'sports drinks','gatorade','energy drinks',
            'wine','beer','hard seltzer','cider']
        },
        {
          name: 'Frozen',
          keywords: ['frozen vegetables','frozen fruit','frozen meals','frozen pizza',
            'frozen chicken','frozen fish','frozen shrimp','frozen burritos',
            'ice cream','frozen yogurt','sorbet','popsicles',
            'frozen waffles','frozen breakfast','edamame','frozen fries']
        },
        {
          name: 'Health & Beauty',
          keywords: ['vitamins','supplements','pain reliever','cold medicine','antacid',
            'shampoo','conditioner','body wash','soap','lotion','sunscreen',
            'toothpaste','toothbrush','deodorant','razor','feminine hygiene',
            'baby food','diapers','baby care']
        },
        {
          name: 'Cleaning & Laundry',
          keywords: ['laundry detergent','tide','fabric softener','dryer sheets','bleach',
            'dish soap','dishwasher detergent','all-purpose cleaner','disinfecting wipes',
            'paper towels','toilet paper','trash bags','aluminum foil','plastic wrap',
            'ziploc','storage bags','sponge','scrub']
        },
        {
          name: 'Pet & Household',
          keywords: ['dog food','cat food','cat litter','dog treats','pet supplies',
            'light bulbs','batteries','candles','air freshener','laundry bags']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SHAW'S / STAR MARKET
    // Source: Curated ‚Äî Shaw's uses standard New England supermarket layout
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'shaws',
      name: "Shaw's",
      type: 'grocery',
      color: '#005dab',
      searchNames: ["shaw's","shaws","star market"],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','lemon','lime','avocado','tomato',
            'lettuce','spinach','kale','broccoli','cauliflower','carrot','celery',
            'pepper','onion','garlic','mushroom','potato','sweet potato',
            'grapes','berries','strawberry','blueberry','mango','pineapple',
            'herbs','cilantro','parsley','ginger','zucchini','cucumber','corn']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','pork','lamb','turkey',
            'bacon','sausage','ham','deli','hot dogs',
            'salmon','tuna','cod','shrimp','tilapia','scallops']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','sour cream','cream cheese',
            'yogurt','greek yogurt','cottage cheese','heavy cream','half and half',
            'almond milk','oat milk','soy milk','kefir']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','sourdough','bagels','english muffins','rolls','buns',
            'tortillas','pita','wraps','croissant','muffin','danish','cake bakery']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','oatmeal','granola bars','pop tarts',
            'pancake mix','syrup','maple syrup','waffle mix']
        },
        {
          name: 'Canned Goods & Soups',
          keywords: ['soup','broth','canned tomato','tomato paste','tomato sauce',
            'canned beans','canned corn','canned peas','canned fruit','applesauce',
            'canned tuna','canned salmon','olives','pickles','salsa']
        },
        {
          name: 'Pasta, Rice & Grains',
          keywords: ['pasta','spaghetti','penne','mac and cheese','noodles',
            'rice','brown rice','quinoa','couscous','stuffing']
        },
        {
          name: 'Baking & Spices',
          keywords: ['flour','sugar','baking soda','baking powder','vanilla',
            'cake mix','brownie mix','chocolate chips','cocoa','spices',
            'salt','pepper','cinnamon','honey','jam','peanut butter']
        },
        {
          name: 'Condiments & Oils',
          keywords: ['ketchup','mustard','mayo','salad dressing','olive oil',
            'vegetable oil','vinegar','soy sauce','hot sauce','bbq sauce']
        },
        {
          name: 'Snacks',
          keywords: ['chips','tortilla chips','pretzels','popcorn','crackers',
            'nuts','almonds','cashews','trail mix','dried fruit','raisins',
            'cookies','candy','chocolate','granola bars']
        },
        {
          name: 'Beverages',
          keywords: ['water','soda','juice','coffee','tea','sports drinks',
            'energy drinks','wine','beer','cider','sparkling water']
        },
        {
          name: 'Frozen',
          keywords: ['frozen vegetables','frozen meals','frozen pizza','frozen chicken',
            'frozen fish','frozen fruit','ice cream','sorbet','frozen yogurt',
            'frozen waffles','edamame','frozen fries']
        },
        {
          name: 'Health & Beauty',
          keywords: ['vitamins','shampoo','conditioner','body wash','soap','lotion',
            'toothpaste','deodorant','razor','pain reliever','cold medicine',
            'baby food','diapers']
        },
        {
          name: 'Cleaning & Paper Products',
          keywords: ['laundry detergent','dish soap','all-purpose cleaner','bleach',
            'paper towels','toilet paper','trash bags','aluminum foil','plastic wrap',
            'ziploc','sponge','disinfecting wipes']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HANNAFORD
    // Source: Curated ‚Äî Hannaford typical New England layout
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'hannaford',
      name: 'Hannaford',
      type: 'grocery',
      color: '#008542',
      searchNames: ['hannaford','hannaford supermarket'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','lemon','lime','avocado','tomato',
            'lettuce','spinach','kale','broccoli','cauliflower','carrot','celery',
            'pepper','onion','garlic','mushroom','potato','sweet potato',
            'grapes','berries','strawberry','blueberry','mango','pineapple',
            'herbs','cilantro','parsley','ginger','zucchini','cucumber']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','pork','lamb','turkey',
            'bacon','sausage','ham','deli','hot dogs',
            'salmon','tuna','cod','shrimp','tilapia','scallops','crab']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','sour cream','cream cheese',
            'yogurt','greek yogurt','cottage cheese','heavy cream',
            'almond milk','oat milk','soy milk']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','sourdough','bagels','english muffins','rolls','buns',
            'tortillas','pita','croissant','muffin','cake bakery']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','oatmeal','granola bars','pop tarts',
            'pancake mix','syrup','maple syrup']
        },
        {
          name: 'Canned & Jarred',
          keywords: ['soup','broth','canned tomato','tomato paste','pasta sauce',
            'canned beans','canned vegetables','canned fruit','applesauce',
            'canned tuna','olives','pickles','salsa']
        },
        {
          name: 'Pasta, Rice & Grains',
          keywords: ['pasta','spaghetti','penne','mac and cheese',
            'rice','brown rice','quinoa','couscous','lentils','barley']
        },
        {
          name: 'Baking & Spices',
          keywords: ['flour','sugar','baking soda','baking powder','vanilla',
            'cake mix','chocolate chips','spices','salt','pepper',
            'honey','jam','peanut butter','nut butter']
        },
        {
          name: 'Condiments & Dressings',
          keywords: ['ketchup','mustard','mayo','salad dressing','olive oil',
            'vinegar','soy sauce','hot sauce','bbq sauce','worcestershire']
        },
        {
          name: 'Snacks & Nuts',
          keywords: ['chips','pretzels','popcorn','crackers',
            'nuts','almonds','cashews','trail mix','dried fruit',
            'cookies','candy','chocolate','granola bars','rice cakes']
        },
        {
          name: 'Beverages',
          keywords: ['water','soda','juice','coffee','tea',
            'sports drinks','energy drinks','wine','beer','sparkling water']
        },
        {
          name: 'Frozen',
          keywords: ['frozen vegetables','frozen meals','frozen pizza',
            'frozen chicken','frozen fish','frozen fruit',
            'ice cream','sorbet','frozen yogurt','edamame']
        },
        {
          name: 'Health, Beauty & Baby',
          keywords: ['vitamins','supplements','shampoo','conditioner','body wash',
            'toothpaste','deodorant','razor','pain reliever','cold medicine',
            'baby food','diapers','wipes','baby formula']
        },
        {
          name: 'Cleaning & Household',
          keywords: ['laundry detergent','dish soap','cleaner','bleach',
            'paper towels','toilet paper','trash bags','aluminum foil',
            'plastic wrap','ziploc','sponge','disinfecting wipes',
            'dog food','cat food','cat litter','pet food']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PRICE CHOPPER / MARKET 32
    // Source: Curated ‚Äî Price Chopper typical layout (NY/NE)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'price-chopper',
      name: 'Price Chopper',
      type: 'grocery',
      color: '#f26522',
      searchNames: ['price chopper','market 32','market32'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','lemon','avocado','tomato',
            'lettuce','spinach','broccoli','carrot','pepper','onion','garlic',
            'mushroom','potato','sweet potato','grapes','berries','mango','herbs']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','pork','turkey','bacon','sausage','ham',
            'salmon','tuna','shrimp','cod','deli']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','yogurt','sour cream',
            'cream cheese','cottage cheese','heavy cream','almond milk','oat milk']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','bagels','rolls','buns','tortillas','muffin','croissant','cake']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','oatmeal','granola bars','syrup','pancake mix']
        },
        {
          name: 'Canned Goods',
          keywords: ['soup','broth','canned tomato','pasta sauce','canned beans',
            'canned vegetables','canned fruit','tuna','olives','pickles']
        },
        {
          name: 'Pasta, Rice & Grains',
          keywords: ['pasta','spaghetti','rice','quinoa','mac and cheese','lentils']
        },
        {
          name: 'Baking & Spices',
          keywords: ['flour','sugar','baking soda','vanilla','spices','honey','jam','peanut butter']
        },
        {
          name: 'Condiments',
          keywords: ['ketchup','mustard','mayo','salad dressing','olive oil','vinegar','hot sauce','bbq sauce']
        },
        {
          name: 'Snacks',
          keywords: ['chips','pretzels','crackers','nuts','almonds','trail mix','cookies','candy']
        },
        {
          name: 'Beverages',
          keywords: ['water','soda','juice','coffee','tea','wine','beer','sports drinks']
        },
        {
          name: 'Frozen',
          keywords: ['frozen vegetables','frozen meals','frozen pizza','ice cream','sorbet','edamame']
        },
        {
          name: 'Health & Beauty',
          keywords: ['vitamins','shampoo','toothpaste','deodorant','pain reliever','baby food','diapers']
        },
        {
          name: 'Cleaning & Household',
          keywords: ['laundry detergent','dish soap','paper towels','toilet paper',
            'trash bags','aluminum foil','dog food','cat food']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BIG Y
    // Source: Curated ‚Äî Big Y (Western MA / CT) typical layout
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'big-y',
      name: 'Big Y',
      type: 'grocery',
      color: '#d4001a',
      searchNames: ['big y','big y foods','big y world class'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','lemon','avocado','tomato',
            'lettuce','spinach','broccoli','carrot','pepper','onion','garlic',
            'mushroom','potato','sweet potato','grapes','berries','herbs']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','pork','turkey','bacon','sausage',
            'salmon','tuna','shrimp','cod']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','yogurt','sour cream','cream cheese',
            'cottage cheese','heavy cream','almond milk','oat milk']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','bagels','rolls','buns','tortillas','muffin','cake']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','oatmeal','granola bars','syrup','pancake mix']
        },
        {
          name: 'Canned Goods & Soups',
          keywords: ['soup','broth','canned tomato','pasta sauce','canned beans',
            'canned vegetables','canned fruit','tuna','olives','pickles']
        },
        {
          name: 'Pasta, Rice & Dry Goods',
          keywords: ['pasta','spaghetti','rice','quinoa','mac and cheese','lentils','beans dry']
        },
        {
          name: 'Baking',
          keywords: ['flour','sugar','baking soda','vanilla','spices','cake mix','honey','jam','peanut butter']
        },
        {
          name: 'Condiments & Oils',
          keywords: ['ketchup','mustard','mayo','salad dressing','olive oil','vinegar','hot sauce']
        },
        {
          name: 'Snacks & Chips',
          keywords: ['chips','pretzels','crackers','nuts','trail mix','cookies','candy','popcorn']
        },
        {
          name: 'Beverages',
          keywords: ['water','soda','juice','coffee','tea','wine','beer']
        },
        {
          name: 'Frozen',
          keywords: ['frozen vegetables','frozen meals','frozen pizza','ice cream','edamame']
        },
        {
          name: 'Health & Beauty',
          keywords: ['vitamins','shampoo','toothpaste','deodorant','pain reliever']
        },
        {
          name: 'Cleaning & Household',
          keywords: ['laundry detergent','dish soap','paper towels','toilet paper',
            'trash bags','dog food','cat food']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // KROGER (and affiliates: Fred Meyer, Fry's, Harris Teeter, Ralphs, etc.)
    // Source: Curated ‚Äî standard Kroger department structure
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'kroger',
      name: 'Kroger',
      type: 'grocery',
      color: '#0073a8',
      searchNames: ['kroger','fred meyer','frys','fry\'s food','harris teeter',
        'ralphs','ralph\'s','king soopers','smiths','smith\'s','mariano\'s','marianos',
        'city market','dillons'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','lemon','lime','avocado','tomato','cucumber',
            'lettuce','spinach','kale','broccoli','cauliflower','carrot','celery',
            'pepper','onion','garlic','mushroom','potato','sweet potato',
            'grapes','berries','mango','pineapple','herbs','ginger','zucchini']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','pork','lamb','turkey',
            'bacon','sausage','ham','deli','hot dogs',
            'salmon','tuna','cod','shrimp','tilapia','crab']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','sour cream','cream cheese',
            'yogurt','greek yogurt','cottage cheese','heavy cream',
            'almond milk','oat milk','soy milk']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','bagels','english muffins','rolls','buns',
            'tortillas','pita','croissant','muffin','cake','cookies bakery']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','oatmeal','granola bars','pop tarts',
            'pancake mix','syrup','maple syrup','waffles mix']
        },
        {
          name: 'Canned & Packaged',
          keywords: ['soup','broth','canned tomato','tomato paste','pasta sauce',
            'canned beans','canned vegetables','canned fruit','tuna canned',
            'olives','pickles','salsa','applesauce']
        },
        {
          name: 'Pasta, Rice & Grains',
          keywords: ['pasta','spaghetti','penne','mac and cheese','noodles',
            'rice','quinoa','couscous','stuffing']
        },
        {
          name: 'Baking',
          keywords: ['flour','sugar','baking soda','baking powder','vanilla',
            'cake mix','brownie mix','chocolate chips','cocoa','spices',
            'honey','jam','peanut butter']
        },
        {
          name: 'Condiments & Oils',
          keywords: ['ketchup','mustard','mayo','salad dressing','olive oil',
            'vegetable oil','vinegar','soy sauce','hot sauce','bbq sauce']
        },
        {
          name: 'Snacks',
          keywords: ['chips','tortilla chips','pretzels','popcorn','crackers',
            'nuts','almonds','cashews','trail mix','cookies','candy','granola bars']
        },
        {
          name: 'Beverages',
          keywords: ['water','soda','juice','coffee','tea','sports drinks',
            'energy drinks','wine','beer','sparkling water']
        },
        {
          name: 'Frozen',
          keywords: ['frozen vegetables','frozen meals','frozen pizza',
            'frozen chicken','frozen fish','ice cream','sorbet','edamame']
        },
        {
          name: 'Health & Beauty',
          keywords: ['vitamins','shampoo','conditioner','body wash','lotion',
            'toothpaste','deodorant','razor','pain reliever','cold medicine',
            'baby food','diapers']
        },
        {
          name: 'Cleaning & Household',
          keywords: ['laundry detergent','dish soap','all-purpose cleaner','bleach',
            'paper towels','toilet paper','trash bags','aluminum foil',
            'dog food','cat food','cat litter']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WALMART SUPERCENTER / NEIGHBORHOOD MARKET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'walmart',
      name: 'Walmart',
      type: 'grocery',
      color: '#0071ce',
      searchNames: ['walmart','walmart supercenter','walmart neighborhood market','walmart grocery'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','lemon','avocado','tomato',
            'lettuce','spinach','broccoli','carrot','pepper','onion','garlic',
            'mushroom','potato','sweet potato','grapes','berries','herbs']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','pork','turkey','bacon','sausage',
            'salmon','shrimp','tilapia','cod']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','american cheese','sour cream',
            'cream cheese','yogurt','cottage cheese','heavy cream','almond milk']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','white bread','wheat bread','bagels','rolls','buns','tortillas']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','oatmeal','granola','syrup','pancake mix','pop tarts']
        },
        {
          name: 'Canned Goods',
          keywords: ['soup','broth','canned tomato','pasta sauce','canned beans',
            'canned vegetables','canned fruit','tuna','olives','pickles']
        },
        {
          name: 'Pasta & Rice',
          keywords: ['pasta','spaghetti','mac and cheese','rice','ramen','noodles']
        },
        {
          name: 'Baking',
          keywords: ['flour','sugar','baking soda','spices','cake mix','salt','pepper','vanilla']
        },
        {
          name: 'Condiments & Sauces',
          keywords: ['ketchup','mustard','mayo','salad dressing','oil','vinegar','hot sauce','bbq sauce']
        },
        {
          name: 'Snacks',
          keywords: ['chips','pretzels','crackers','nuts','cookies','candy','popcorn','granola bars']
        },
        {
          name: 'Beverages',
          keywords: ['water','soda','juice','coffee','tea','sports drinks','energy drinks']
        },
        {
          name: 'Frozen',
          keywords: ['frozen meals','frozen pizza','frozen vegetables','frozen chicken',
            'ice cream','frozen fish','frozen fries']
        },
        {
          name: 'Health & Beauty',
          keywords: ['vitamins','shampoo','toothpaste','deodorant','soap','lotion',
            'pain reliever','cold medicine','baby food','diapers']
        },
        {
          name: 'Cleaning',
          keywords: ['laundry detergent','dish soap','cleaner','bleach','paper towels',
            'toilet paper','trash bags','dog food','cat food']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TARGET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'target',
      name: 'Target',
      type: 'grocery',
      color: '#cc0000',
      searchNames: ['target','super target'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','avocado','tomato','lettuce','spinach',
            'broccoli','carrot','pepper','onion','garlic','potato','berries','herbs']
        },
        {
          name: 'Meat & Seafood',
          keywords: ['chicken','ground beef','steak','bacon','sausage','salmon','shrimp']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','yogurt','sour cream','cream cheese',
            'cottage cheese','heavy cream','almond milk','oat milk']
        },
        {
          name: 'Bakery & Bread',
          keywords: ['bread','bagels','tortillas','rolls','muffin']
        },
        {
          name: 'Cereal & Breakfast',
          keywords: ['cereal','granola','oatmeal','syrup','pancake mix','granola bars']
        },
        {
          name: 'Canned & Packaged',
          keywords: ['soup','canned tomato','pasta sauce','canned beans','tuna',
            'olives','pickles','broth']
        },
        {
          name: 'Pasta, Rice & Grains',
          keywords: ['pasta','rice','mac and cheese','quinoa','lentils']
        },
        {
          name: 'Baking & Spices',
          keywords: ['flour','sugar','baking soda','spices','vanilla','honey','jam','peanut butter']
        },
        {
          name: 'Condiments & Oils',
          keywords: ['ketchup','mustard','mayo','olive oil','salad dressing','vinegar','hot sauce']
        },
        {
          name: 'Snacks',
          keywords: ['chips','crackers','nuts','cookies','candy','popcorn','trail mix']
        },
        {
          name: 'Beverages',
          keywords: ['water','soda','juice','coffee','tea','wine','beer','sparkling water']
        },
        {
          name: 'Frozen',
          keywords: ['frozen meals','frozen pizza','frozen vegetables','ice cream','frozen chicken']
        },
        {
          name: 'Health & Beauty',
          keywords: ['vitamins','shampoo','toothpaste','deodorant','lotion','sunscreen',
            'pain reliever','baby food','diapers']
        },
        {
          name: 'Cleaning & Household',
          keywords: ['laundry detergent','dish soap','paper towels','toilet paper',
            'trash bags','cleaning spray','dog food','cat food']
        }
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ALDI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'aldi',
      name: 'ALDI',
      type: 'grocery',
      color: '#00529b',
      searchNames: ['aldi','aldi market','aldi grocery'],
      dataSource: 'curated',
      aisles: [
        {
          name: 'Produce',
          keywords: ['apple','banana','orange','avocado','tomato','lettuce','spinach',
            'broccoli','carrot','pepper','onion','garlic','potato','berries']
        },
        {
          name: 'Meat & Deli',
          keywords: ['chicken','ground beef','steak','pork','bacon','sausage','ham',
            'deli meat','salmon','shrimp']
        },
        {
          name: 'Dairy & Eggs',
          keywords: ['milk','butter','eggs','cheese','cheddar','yogurt','sour cream',
            'cream cheese','cottage cheese','heavy cream']
        },
        {
          name: 'Bread & Bakery',
          keywords: ['bread','rolls','tortillas','bagels','muffin','cake']
        },
        {
          name: 'Dry Goods & Pasta',
          keywords: ['pasta','rice','oatmeal','cereal','flour','sugar','mac and cheese',
            'quinoa','lentils','beans']
        },
        {
          name: 'Canned & Jarred',
          keywords: ['soup','canned tomato','pasta sauce','canned beans','tuna',
            'olives','pickles','broth']
        },
        {
          name: 'Baking & Condiments',
          keywords: ['baking soda','vanilla','spices','ketchup','mustard','mayo',
            'olive oil','vinegar','hot sauce','jam','peanut butter','honey']
        },
        {
          name: 'Snacks',
          keywords: ['chips','pretzels','crackers','nuts','almonds','cookies','candy','granola bars']
        },
        {
          name: 'Beverages',
          keywords: ['water','juice','coffee','tea','soda','sparkling water']
        },
        {
          name: 'Frozen',
          keywords: ['frozen meals','frozen pizza','frozen vegetables','ice cream','frozen fish']
        },
        {
          name: 'Household & Health',
          keywords: ['laundry detergent','dish soap','paper towels','toilet paper',
            'trash bags','vitamins','shampoo','toothpaste']
        }
      ]
    }

  ] // end grocery array


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PUBLIX
    // Source: Curated based on typical Publix department layout
    // Southeast US chain; departments consistent across locations
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'publix',
      name: 'Publix',
      type: 'grocery',
      color: '#009f4d',
      searchNames: ['publix','publix super market','publix supermarket'],
      dataSource: 'curated',
      aisles: [
        { name: 'Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','raspberry','lemon','lime','avocado','tomato','lettuce','spinach','kale','broccoli','carrot','celery','cucumber','pepper','onion','garlic','mushroom','zucchini','corn','potato','sweet potato','ginger','herbs','cilantro','parsley','basil','arugula','beet','radish','cabbage','cauliflower'] },
        { name: 'Deli', keywords: ['deli','ham','turkey','roast beef','salami','pepperoni','prosciutto','pastrami','sliced cheese','american cheese','swiss','provolone','deli meat','sandwich','sub','wrap','prepared food','rotisserie','fried chicken','hot bar','olive','pickle','hummus'] },
        { name: 'Bakery', keywords: ['bread','bagel','muffin','croissant','roll','bun','loaf','sourdough','baguette','pita','naan','tortilla','english muffin','brioche','cake','pie','cookie','donut','pastry','danish','brownie'] },
        { name: 'Meat & Seafood', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','salmon','tilapia','shrimp','tuna','cod','halibut','sausage','bacon','lamb','veal','crab','lobster','scallop','clam','fish','turkey breast','pork chop','ribs'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','half and half','sour cream','cream cheese','cottage cheese','ricotta','yogurt','kefir','cheese','cheddar','mozzarella','parmesan','brie','feta','gouda','whipped cream','almond milk','oat milk','soy milk'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','sorbet','gelato','frozen pizza','frozen meal','frozen vegetable','edamame','peas','corn','french fries','tater tots','waffle','pancake','burrito','pot pie','fish sticks','ice','frozen fruit','frozen shrimp'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','wine','beer','sparkling water','kombucha','sports drink','energy drink','lemonade','cider','coconut water','almond milk','oat milk','soy milk','creamer','espresso','matcha','hot chocolate','punch'] },
        { name: 'Pantry', keywords: ['pasta','rice','flour','sugar','salt','pepper','olive oil','vegetable oil','vinegar','sauce','pasta sauce','salsa','soy sauce','hot sauce','mustard','ketchup','mayonnaise','ranch','soup','broth','stock','beans','lentils','quinoa','oats','cereal','granola','honey','jam','jelly','peanut butter','almond butter','crackers','chips','nuts','almonds','cashews','popcorn','pretzels','baking soda','baking powder','vanilla','cocoa','canned tomato','canned tuna','canned beans','breadcrumbs'] },
        { name: 'Snacks & Candy', keywords: ['chips','crackers','pretzels','popcorn','nuts','trail mix','granola bar','protein bar','candy','chocolate','gummies','licorice','cookies','snack','fruit snacks','jerky','rice cake'] },
        { name: 'Health & Beauty', keywords: ['shampoo','conditioner','soap','body wash','lotion','moisturizer','sunscreen','toothpaste','toothbrush','floss','mouthwash','deodorant','razors','shaving cream','vitamins','supplements','medicine','pain reliever','allergy','bandage','first aid','feminine care','diapers','baby','makeup','skincare','hair care'] },
        { name: 'Household & Cleaning', keywords: ['laundry','detergent','dish soap','dishwasher','sponge','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','fabric softener','air freshener','candle','batteries','light bulbs','aluminum foil','plastic wrap','zip bags'] },
        { name: 'Beer, Wine & Spirits', keywords: ['wine','beer','beer','ale','lager','ipa','white wine','red wine','ros√©','champagne','sparkling wine','spirits','liquor','vodka','whiskey','bourbon','rum','tequila','gin','cider','hard seltzer','mead'] },
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // H-E-B
    // Source: Curated based on typical HEB department layout
    // Texas-focused chain with strong fresh department presence
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'heb',
      name: 'H-E-B',
      type: 'grocery',
      color: '#e31837',
      searchNames: ['h-e-b','heb','h e b','central market','heb plus'],
      dataSource: 'curated',
      aisles: [
        { name: 'Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','lemon','lime','avocado','tomato','lettuce','spinach','kale','broccoli','carrot','celery','cucumber','pepper','onion','garlic','jalape√±o','tomatillo','cilantro','lime','mango','papaya','pineapple','guava','mushroom','zucchini','corn','potato','sweet potato','cabbage','cauliflower','beet','herbs'] },
        { name: 'Meat & Seafood', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','carne asada','fajita meat','chorizo','carnitas','barbacoa','brisket','ribs','salmon','tilapia','shrimp','catfish','tuna','sausage','bacon','lamb','turkey','pork chop','ham','deli meat'] },
        { name: 'Bakery & Tortilleria', keywords: ['bread','bagel','muffin','roll','bun','sourdough','baguette','tortilla','flour tortilla','corn tortilla','pita','pan dulce','bolillo','conchas','cookies','cake','pie','donut','pastry','brownie'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','half and half','sour cream','cream cheese','cottage cheese','ricotta','yogurt','cheese','cheddar','mozzarella','parmesan','queso fresco','cotija','oaxaca cheese','jack cheese','whipped cream','almond milk','oat milk'] },
        { name: 'Deli & Prepared Foods', keywords: ['deli','ham','turkey','salami','sliced cheese','sandwich','prepared food','rotisserie','fried chicken','hot bar','guacamole','pico de gallo','salsa','hummus','olive','pickle'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','frozen pizza','frozen meal','frozen vegetable','edamame','french fries','tamales','frozen burrito','enchiladas','frozen shrimp','ice','frozen fruit','frozen waffle'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','sparkling water','sports drink','energy drink','lemonade','horchata','agua fresca','coconut water','almond milk','oat milk','creamer','beer','wine'] },
        { name: 'Pantry & Dry Goods', keywords: ['pasta','rice','flour','masa','cornmeal','sugar','salt','olive oil','vegetable oil','lard','vinegar','sauce','pasta sauce','salsa','enchilada sauce','mole','soy sauce','hot sauce','sriracha','tamarind','adobo','soup','broth','beans','pinto beans','black beans','lentils','quinoa','oats','cereal','honey','jam','peanut butter','crackers','chips','tortilla chips','nuts','popcorn','baking soda','baking powder','canned tomato','canned chile','canned beans','spices','cumin','chili powder'] },
        { name: 'International & Hispanic Foods', keywords: ['tortilla','tamales','mole','adobo','chipotle','chile','ancho','pasilla','guajillo','jamaica','piloncillo','mexican chocolate','tomatillo','nopales','chayote','jicama','plantain','yuca','masa harina','menudo','pozole','sofrito'] },
        { name: 'Snacks', keywords: ['chips','tortilla chips','crackers','pretzels','popcorn','nuts','trail mix','granola bar','candy','chocolate','cookies','jerky','fruit snacks','rice cake','sunflower seeds'] },
        { name: 'Health & Beauty', keywords: ['shampoo','conditioner','soap','lotion','sunscreen','toothpaste','toothbrush','deodorant','razors','vitamins','supplements','medicine','pain reliever','allergy','bandage','diapers','baby'] },
        { name: 'Household', keywords: ['laundry','detergent','dish soap','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','aluminum foil','plastic wrap','zip bags'] },
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MEIJER
    // Source: Curated based on typical Meijer supercenter layout
    // Midwest supercenter with full grocery + general merchandise
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'meijer',
      name: 'Meijer',
      type: 'grocery',
      color: '#e31837',
      searchNames: ['meijer','meijer superstore','meijer supercenter'],
      dataSource: 'curated',
      aisles: [
        { name: 'Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','lemon','lime','avocado','tomato','lettuce','spinach','kale','broccoli','carrot','celery','cucumber','pepper','onion','garlic','mushroom','zucchini','corn','potato','sweet potato','ginger','herbs','cilantro','parsley','cabbage','cauliflower','beet','arugula'] },
        { name: 'Meat & Seafood', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','salmon','tilapia','shrimp','tuna','cod','sausage','bacon','lamb','turkey','pork chop','ham','ribs','fish','deli meat','hot dogs','brats','bratwurst'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','half and half','sour cream','cream cheese','cottage cheese','ricotta','yogurt','cheese','cheddar','mozzarella','parmesan','brie','feta','gouda','whipped cream','almond milk','oat milk','soy milk'] },
        { name: 'Bakery', keywords: ['bread','bagel','muffin','croissant','roll','bun','loaf','sourdough','tortilla','english muffin','pita','cookies','cake','pie','donut','pastry','brownie'] },
        { name: 'Deli', keywords: ['deli','ham','turkey','roast beef','salami','sliced cheese','american cheese','swiss','provolone','sandwich','prepared food','rotisserie','fried chicken','hot bar','olive','pickle','hummus'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','sorbet','frozen pizza','frozen meal','frozen vegetable','edamame','peas','corn','french fries','tater tots','waffle','burrito','pot pie','fish sticks','ice','frozen fruit','frozen shrimp'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','wine','beer','sparkling water','kombucha','sports drink','energy drink','lemonade','cider','coconut water','almond milk','oat milk','creamer'] },
        { name: 'Pantry', keywords: ['pasta','rice','flour','sugar','salt','olive oil','vegetable oil','vinegar','pasta sauce','salsa','soy sauce','hot sauce','mustard','ketchup','mayonnaise','soup','broth','beans','lentils','quinoa','oats','cereal','granola','honey','jam','peanut butter','crackers','chips','nuts','popcorn','baking soda','baking powder','canned tomato','canned tuna','canned beans','spices'] },
        { name: 'Snacks & Candy', keywords: ['chips','crackers','pretzels','popcorn','nuts','trail mix','granola bar','protein bar','candy','chocolate','gummies','cookies','snack','jerky','rice cake'] },
        { name: 'Health & Beauty', keywords: ['shampoo','conditioner','soap','body wash','lotion','sunscreen','toothpaste','toothbrush','deodorant','razors','vitamins','supplements','medicine','pain reliever','allergy','bandage','feminine care','diapers','baby'] },
        { name: 'Household & Cleaning', keywords: ['laundry','detergent','dish soap','dishwasher','sponge','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','aluminum foil','plastic wrap'] },
        { name: 'General Merchandise', keywords: ['electronics','clothing','shoes','toys','bedding','towels','kitchen','tools','auto','seasonal','garden','sporting goods','books','office','school supplies','storage','luggage'] },
        { name: 'Pharmacy', keywords: ['prescription','pharmacy','vitamins','supplements','first aid','bandage','cold','flu','allergy medicine','pain reliever','antacid','eye drops','ear drops','cough syrup'] },
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WEGMANS
    // Source: Curated based on typical Wegmans department layout
    // Northeast/Mid-Atlantic upscale chain with large prepared foods section
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'wegmans',
      name: 'Wegmans',
      type: 'grocery',
      color: '#004b87',
      searchNames: ['wegmans','wegmans food markets','wegman\'s'],
      dataSource: 'curated',
      aisles: [
        { name: 'Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','raspberry','lemon','lime','avocado','tomato','lettuce','spinach','kale','broccoli','carrot','celery','cucumber','pepper','onion','garlic','mushroom','zucchini','corn','potato','sweet potato','ginger','herbs','cilantro','parsley','basil','arugula','beet','radish','cabbage','cauliflower','leek','fennel'] },
        { name: 'Organic & Natural', keywords: ['organic','natural','gluten free','vegan','plant based','non-gmo','whole grain','sprouted','raw','superfood','chia','flaxseed','hemp','nutritional yeast','kombucha','kefir'] },
        { name: 'Meat & Seafood', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','salmon','tilapia','shrimp','tuna','cod','halibut','lobster','crab','scallop','oyster','sausage','bacon','lamb','veal','turkey','pork chop','ribs','duck','bison'] },
        { name: 'Prepared Foods & Deli', keywords: ['deli','ham','turkey','roast beef','salami','sliced cheese','sandwich','sushi','prepared food','rotisserie','fried chicken','hot bar','pizza','soup','salad bar','olive','pickle','hummus','charcuterie','p√¢t√©'] },
        { name: 'Bakery', keywords: ['bread','bagel','muffin','croissant','roll','bun','loaf','sourdough','baguette','pita','ciabatta','focaccia','english muffin','brioche','cake','pie','cookie','donut','pastry','danish','brownie','eclair','macaron','tart'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','half and half','sour cream','cream cheese','cottage cheese','ricotta','yogurt','kefir','cheese','cheddar','mozzarella','parmesan','brie','camembert','feta','gouda','gruy√®re','manchego','aged cheddar','whipped cream','almond milk','oat milk','soy milk'] },
        { name: 'Cheese Shop', keywords: ['cheese','brie','camembert','manchego','gruy√®re','gouda','aged cheddar','blue cheese','gorgonzola','stilton','fontina','havarti','goat cheese','chevre','wensleydale','pecorino'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','sorbet','gelato','frozen pizza','frozen meal','frozen vegetable','edamame','peas','french fries','waffle','burrito','pot pie','fish sticks','ice','frozen fruit','frozen shrimp','frozen appetizer'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','wine','beer','sparkling water','kombucha','sports drink','energy drink','lemonade','cider','coconut water','almond milk','oat milk','creamer','espresso','matcha'] },
        { name: 'Pantry & World Foods', keywords: ['pasta','rice','flour','sugar','salt','olive oil','vinegar','pasta sauce','salsa','soy sauce','fish sauce','sriracha','miso','tahini','soup','broth','beans','lentils','quinoa','farro','oats','cereal','honey','jam','peanut butter','almond butter','crackers','chips','nuts','popcorn','baking soda','baking powder','canned tomato','canned tuna','spices','curry paste','coconut milk'] },
        { name: 'Health & Beauty', keywords: ['shampoo','conditioner','soap','lotion','sunscreen','toothpaste','toothbrush','deodorant','razors','vitamins','supplements','medicine','pain reliever','allergy','bandage','diapers','baby'] },
        { name: 'Household', keywords: ['laundry','detergent','dish soap','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','aluminum foil','plastic wrap','zip bags'] },
        { name: 'Floral', keywords: ['flowers','bouquet','plant','succulent','potted plant','floral','roses','tulips','orchid','lily','arrangement','vase'] },
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SAFEWAY / ALBERTSONS
    // Source: Curated based on typical Safeway/Albertsons layout
    // Covers both banners as they share near-identical layouts
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'safeway',
      name: 'Safeway',
      type: 'grocery',
      color: '#e31837',
      searchNames: ['safeway','albertsons','vons','pavilions','randalls','tom thumb','acme','jewel','jewel-osco','star market','united supermarkets','market street'],
      dataSource: 'curated',
      aisles: [
        { name: 'Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','lemon','lime','avocado','tomato','lettuce','spinach','kale','broccoli','carrot','celery','cucumber','pepper','onion','garlic','mushroom','zucchini','corn','potato','sweet potato','ginger','herbs','cilantro','parsley','cabbage','cauliflower'] },
        { name: 'Meat & Seafood', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','salmon','tilapia','shrimp','tuna','cod','sausage','bacon','lamb','turkey','pork chop','ham','fish','deli meat','hot dogs'] },
        { name: 'Deli', keywords: ['deli','ham','turkey','roast beef','salami','sliced cheese','american cheese','swiss','sandwich','prepared food','rotisserie','fried chicken','olive','pickle','hummus'] },
        { name: 'Bakery', keywords: ['bread','bagel','muffin','croissant','roll','bun','loaf','sourdough','tortilla','english muffin','cookies','cake','pie','donut','pastry','brownie'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','half and half','sour cream','cream cheese','cottage cheese','ricotta','yogurt','cheese','cheddar','mozzarella','parmesan','brie','feta','gouda','whipped cream','almond milk','oat milk','soy milk'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','sorbet','frozen pizza','frozen meal','frozen vegetable','edamame','peas','french fries','tater tots','waffle','burrito','pot pie','ice','frozen fruit','frozen shrimp'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','wine','beer','sparkling water','kombucha','sports drink','energy drink','lemonade','cider','coconut water','almond milk','oat milk','creamer'] },
        { name: 'Pantry', keywords: ['pasta','rice','flour','sugar','salt','olive oil','vegetable oil','vinegar','pasta sauce','salsa','soy sauce','hot sauce','mustard','ketchup','mayonnaise','soup','broth','beans','lentils','quinoa','oats','cereal','granola','honey','jam','peanut butter','crackers','chips','nuts','popcorn','baking soda','baking powder','canned tomato','canned tuna','canned beans','spices'] },
        { name: 'Snacks & Candy', keywords: ['chips','crackers','pretzels','popcorn','nuts','trail mix','granola bar','protein bar','candy','chocolate','gummies','cookies','snack','jerky','rice cake'] },
        { name: 'Health & Beauty', keywords: ['shampoo','conditioner','soap','body wash','lotion','sunscreen','toothpaste','toothbrush','deodorant','razors','vitamins','supplements','medicine','pain reliever','allergy','bandage','feminine care','diapers','baby'] },
        { name: 'Household & Cleaning', keywords: ['laundry','detergent','dish soap','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','aluminum foil','plastic wrap','zip bags'] },
        { name: 'Beer & Wine', keywords: ['wine','beer','ale','lager','ipa','white wine','red wine','ros√©','champagne','hard seltzer','cider','mead','spirits','vodka','whiskey','bourbon','rum','tequila'] },
        { name: 'Pharmacy', keywords: ['prescription','pharmacy','vitamins','supplements','first aid','bandage','cold','flu','allergy medicine','pain reliever','antacid','eye drops','cough syrup'] },
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FOOD LION
    // Source: Curated based on typical Food Lion layout
    // Southeast/Mid-Atlantic value-focused chain
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'food-lion',
      name: 'Food Lion',
      type: 'grocery',
      color: '#0066cc',
      searchNames: ['food lion','food lion llc'],
      dataSource: 'curated',
      aisles: [
        { name: 'Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','lemon','lime','avocado','tomato','lettuce','spinach','broccoli','carrot','celery','cucumber','pepper','onion','garlic','mushroom','potato','sweet potato','cabbage','corn','herbs'] },
        { name: 'Meat & Seafood', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','salmon','tilapia','shrimp','tuna','catfish','sausage','bacon','ham','turkey','hot dogs','deli meat','fish'] },
        { name: 'Deli & Bakery', keywords: ['deli','ham','turkey','salami','sliced cheese','american cheese','swiss','bread','bagel','roll','bun','loaf','tortilla','cookies','cake','donut','rotisserie','fried chicken','sandwich','pickle'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','sour cream','cream cheese','cottage cheese','yogurt','cheese','cheddar','mozzarella','parmesan','whipped cream','almond milk','oat milk'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','frozen pizza','frozen meal','frozen vegetable','peas','corn','french fries','tater tots','waffle','burrito','pot pie','ice','frozen fruit'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','wine','beer','sports drink','energy drink','lemonade','cider','almond milk','oat milk','creamer'] },
        { name: 'Pantry', keywords: ['pasta','rice','flour','sugar','salt','oil','vinegar','pasta sauce','salsa','soy sauce','hot sauce','mustard','ketchup','mayonnaise','soup','broth','beans','oats','cereal','honey','jam','peanut butter','crackers','chips','nuts','popcorn','baking soda','canned tomato','canned tuna','canned beans','spices'] },
        { name: 'Snacks & Candy', keywords: ['chips','crackers','pretzels','popcorn','nuts','trail mix','granola bar','candy','chocolate','gummies','cookies','jerky'] },
        { name: 'Health & Beauty', keywords: ['shampoo','conditioner','soap','lotion','toothpaste','toothbrush','deodorant','razors','vitamins','medicine','pain reliever','allergy','bandage','diapers','baby'] },
        { name: 'Household', keywords: ['laundry','detergent','dish soap','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','aluminum foil','plastic wrap'] },
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GIANT / MARTIN'S
    // Source: Curated based on typical Giant Food layout
    // Mid-Atlantic chain (covers Giant Food and Giant Food Stores banners)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'giant',
      name: 'Giant Food',
      type: 'grocery',
      color: '#e31837',
      searchNames: ['giant','giant food','giant food stores','martins','martin\'s food','martin\'s'],
      dataSource: 'curated',
      aisles: [
        { name: 'Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','lemon','lime','avocado','tomato','lettuce','spinach','kale','broccoli','carrot','celery','cucumber','pepper','onion','garlic','mushroom','zucchini','corn','potato','sweet potato','ginger','herbs','cilantro','cabbage','cauliflower'] },
        { name: 'Meat & Seafood', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','salmon','tilapia','shrimp','tuna','cod','sausage','bacon','lamb','turkey','pork chop','ham','fish','deli meat','hot dogs','crab','lobster'] },
        { name: 'Deli', keywords: ['deli','ham','turkey','roast beef','salami','sliced cheese','american cheese','swiss','provolone','sandwich','prepared food','rotisserie','fried chicken','olive','pickle','hummus'] },
        { name: 'Bakery', keywords: ['bread','bagel','muffin','croissant','roll','bun','loaf','sourdough','baguette','tortilla','english muffin','cookies','cake','pie','donut','pastry','brownie'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','half and half','sour cream','cream cheese','cottage cheese','ricotta','yogurt','cheese','cheddar','mozzarella','parmesan','brie','feta','whipped cream','almond milk','oat milk','soy milk'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','sorbet','frozen pizza','frozen meal','frozen vegetable','edamame','peas','french fries','tater tots','waffle','burrito','pot pie','ice','frozen fruit','frozen shrimp'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','wine','beer','sparkling water','kombucha','sports drink','energy drink','lemonade','cider','coconut water','almond milk','oat milk','creamer'] },
        { name: 'Pantry', keywords: ['pasta','rice','flour','sugar','salt','olive oil','vegetable oil','vinegar','pasta sauce','salsa','soy sauce','hot sauce','mustard','ketchup','mayonnaise','soup','broth','beans','lentils','quinoa','oats','cereal','granola','honey','jam','peanut butter','crackers','chips','nuts','popcorn','baking soda','baking powder','canned tomato','canned tuna','canned beans','spices'] },
        { name: 'Snacks & Candy', keywords: ['chips','crackers','pretzels','popcorn','nuts','trail mix','granola bar','protein bar','candy','chocolate','gummies','cookies','jerky','rice cake'] },
        { name: 'Health & Beauty', keywords: ['shampoo','conditioner','soap','body wash','lotion','sunscreen','toothpaste','toothbrush','deodorant','razors','vitamins','supplements','medicine','pain reliever','allergy','bandage','diapers','baby'] },
        { name: 'Household & Cleaning', keywords: ['laundry','detergent','dish soap','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','aluminum foil','plastic wrap','zip bags'] },
        { name: 'Beer & Wine', keywords: ['wine','beer','ale','lager','ipa','white wine','red wine','ros√©','champagne','hard seltzer','cider','spirits','vodka','whiskey','bourbon','rum','tequila'] },
      ]
    },

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // COSTCO
    // Source: Curated based on typical Costco warehouse layout
    // Warehouse club ‚Äî departments rather than numbered aisles
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    {
      id: 'costco',
      name: 'Costco',
      type: 'grocery',
      color: '#005daa',
      searchNames: ['costco','costco wholesale','costco warehouse'],
      dataSource: 'curated',
      aisles: [
        { name: 'Fresh Produce', keywords: ['apple','banana','orange','grape','strawberry','blueberry','lemon','lime','avocado','tomato','lettuce','spinach','kale','broccoli','carrot','celery','cucumber','pepper','onion','garlic','mushroom','potato','sweet potato','herbs','salad mix','coleslaw','fruit'] },
        { name: 'Fresh Meat & Poultry', keywords: ['chicken','beef','pork','steak','ground beef','ground turkey','lamb','bison','turkey','pork chop','ribs','prime rib','tenderloin','rotisserie chicken','hot dogs','sausage','bacon','ham'] },
        { name: 'Fresh Seafood', keywords: ['salmon','tilapia','shrimp','tuna','cod','halibut','lobster','crab','scallop','clam','oyster','fish','mahi mahi','swordfish','sea bass','calamari'] },
        { name: 'Deli & Prepared Foods', keywords: ['deli','sandwich','prepared food','soup','salad','lasagna','chicken pot pie','quiche','pizza','sushi','spanakopita','charcuterie','cheese board','guacamole','hummus','salsa'] },
        { name: 'Bakery', keywords: ['bread','muffin','croissant','bagel','roll','bun','sourdough','tortilla','pita','cookies','cake','pie','donut','danish','brownie','madeleine','cheesecake','tart'] },
        { name: 'Dairy & Eggs', keywords: ['milk','butter','eggs','egg','cream','half and half','sour cream','cream cheese','cottage cheese','ricotta','yogurt','greek yogurt','cheese','cheddar','mozzarella','parmesan','brie','feta','gouda','manchego','whipped cream','almond milk','oat milk'] },
        { name: 'Frozen', keywords: ['frozen','ice cream','sorbet','frozen pizza','frozen meal','frozen vegetable','edamame','peas','french fries','tater tots','waffle','burrito','pot pie','dumplings','spring rolls','wontons','ice','frozen fruit','frozen shrimp','frozen fish'] },
        { name: 'Beverages', keywords: ['water','juice','soda','coffee','tea','wine','beer','sparkling water','sports drink','energy drink','lemonade','almond milk','oat milk','creamer','espresso','k-cup','coffee pods'] },
        { name: 'Pantry & Dry Goods', keywords: ['pasta','rice','flour','sugar','salt','olive oil','vegetable oil','vinegar','pasta sauce','salsa','soy sauce','hot sauce','mustard','ketchup','mayonnaise','soup','broth','beans','lentils','quinoa','oats','cereal','granola','honey','jam','peanut butter','almond butter','crackers','chips','nuts','almonds','cashews','mixed nuts','popcorn','pretzels','baking soda','baking powder','canned tomato','canned tuna','canned beans','spices','protein powder','protein bar','granola bar'] },
        { name: 'Snacks & Candy', keywords: ['chips','crackers','pretzels','popcorn','nuts','trail mix','granola bar','protein bar','candy','chocolate','gummies','cookies','snack','jerky','fruit snacks','dried mango','dried cranberry'] },
        { name: 'Alcohol', keywords: ['wine','beer','ale','lager','ipa','white wine','red wine','ros√©','champagne','sparkling wine','spirits','vodka','whiskey','bourbon','rum','tequila','gin','cider','hard seltzer','prosecco','sake'] },
        { name: 'Health & Pharmacy', keywords: ['vitamins','supplements','protein powder','fish oil','probiotic','multivitamin','medicine','pain reliever','allergy','first aid','bandage','cold','flu','eye drops','sunscreen','dental','toothbrush','floss','shampoo','conditioner','soap','lotion','deodorant','razors','diapers','baby wipes'] },
        { name: 'Household & Cleaning', keywords: ['laundry','detergent','dish soap','dishwasher pods','sponge','paper towels','toilet paper','tissues','garbage bags','cleaning spray','bleach','dryer sheets','fabric softener','air freshener','batteries','light bulbs','aluminum foil','plastic wrap','zip bags','storage'] },
        { name: 'Electronics & Home', keywords: ['tv','television','laptop','tablet','phone','headphones','speaker','camera','printer','computer','appliance','toaster','blender','air fryer','vacuum','coffee maker','mattress','furniture','bedding','towels','kitchen'] },
        { name: 'Clothing & Apparel', keywords: ['shirt','pants','jeans','jacket','coat','shoes','socks','underwear','activewear','pajamas','dress','sweater','shorts','hat','gloves','scarf'] },
      ]
    },
  // Future categories can be added here:
  // pharmacy: [...],
  // hardware: [...],
};

// Helper: find a chain template by matching a Google Places store name
function matchStoreToLibrary(placeName) {
  if (!placeName) return null;
  const lower = placeName.toLowerCase();
  for (const category of Object.keys(STORE_LIBRARY)) {
    for (const chain of STORE_LIBRARY[category]) {
      for (const searchName of chain.searchNames) {
        if (lower.includes(searchName)) return chain;
      }
    }
  }
  return null;
}

// Helper: get all chains in a flat list
function getAllLibraryStores() {
  return Object.values(STORE_LIBRARY).flat();
}


const AISLE_COLORS = ['#4ade80','#60a5fa','#f472b6','#fb923c','#a78bfa','#34d399','#e879f9','#facc15','#f87171','#22d3ee'];
const STORE_COLORS = ['#4ade80','#60a5fa','#f472b6','#fb923c','#a78bfa','#34d399','#facc15','#f87171'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  stores: [], activeStoreId: null,
  lists: {},
  corrections: {},
  editingStoreId: null,
};
let tempAisles = [];
let tempColor = STORE_COLORS[0];
let moveItemIndex = null;

// drag state
let dragSrcIdx = null, dragSrcAisle = null;
let touchClone = null, touchSrcIdx = null, touchSrcAisle = null;
let touchOffX = 0, touchOffY = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  // Hide forgot panel if returning to tabs
  document.getElementById('auth-panel-forgot')?.classList.remove('active');
  ['signin','signup'].forEach(t => {
    document.getElementById('auth-panel-'+t)?.classList.toggle('active', t===tab);
  });
  document.querySelectorAll('.auth-tab').forEach((b,i)=>{
    b.classList.toggle('active', (i===0&&tab==='signin')||(i===1&&tab==='signup'));
  });
}

// Safe callers ‚Äî wait for Firebase module to be ready before delegating
function signInEmail()      { if(window._fbReady) window.signInEmail();      else showToast('Loading‚Ä¶ please try again'); }
function signUpEmail()      { if(window._fbReady) window.signUpEmail();      else showToast('Loading‚Ä¶ please try again'); }
function signInGoogle()     { if(window._fbReady) window.signInGoogle();     else showToast('Loading‚Ä¶ please try again'); }
function signOut()          { if(window._fbReady) window.signOut();          else showToast('Loading‚Ä¶ please try again'); }
function sendResetEmail()   { if(window._fbReady) window.sendResetEmail();   else showToast('Loading‚Ä¶ please try again'); }
function showForgotPassword(){ if(window._fbReady) window.showForgotPassword(); else showToast('Loading‚Ä¶ please try again'); }
function changePassword()   { if(window._fbReady) window.changePassword();   else showToast('Loading‚Ä¶ please try again'); }
function joinStoreByCode()          { if(window._fbReady) window.joinStoreByCode();          else showToast('Loading‚Ä¶'); }
function openShareStoreModal(id)    { if(window._fbReady) window.openShareStoreModal(id);    else showToast('Loading‚Ä¶'); }
function copyShareCode()            { if(window._fbReady) window.copyShareCode();            else showToast('Loading‚Ä¶'); }

function openProfileModal() {
  openModal('modal-profile');
}

function boot() {
  renderAll();
}

// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchScreen(name, pushHistory=true) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if (pushHistory) history.pushState({ type: 'screen', screen: name }, '', '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){ renderTopbar(); renderListScreen(); renderStoresScreen(); }

function renderTopbar(){
  const s=getActiveStore();
  document.getElementById('active-store-name').textContent = s?s.name:'No store';
  document.getElementById('active-store-dot').style.background = s?s.color:'#555';
}

function renderListScreen(){
  const cont=document.getElementById('list-content');
  const store=getActiveStore();
  if(!store){ cont.innerHTML=`<div class="empty"><div class="empty-icon"><svg width="2.5rem" height="2.5rem" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
  <path d="M3 9l1-5h16l1 5"/>
  <path d="M3 9a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2"/>
  <path d="M5 11v9h14v-9"/>
  <rect x="8" y="13" width="8" height="5" rx="1"/>
  <path d="M9.5 15 Q11 14.4 12.5 15.2 Q14 15.8 14.5 15" stroke-width="1.1"/>
  <path d="M9.5 17 Q11 16.5 13 17" stroke-width="1.1"/>
</svg></div><div class="empty-title">No store selected</div><div class="empty-sub">Go to Stores and add your first store.</div></div>`; return; }
  const items=state.lists[store.id]||[];
  if(!items.length){ cont.innerHTML=`<div class="empty"><div class="empty-icon"><svg width="2.5rem" height="2.5rem" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
  <rect x="4" y="2" width="16" height="20" rx="2"/>
  <line x1="8" y1="6" x2="8" y2="6"/>
  <line x1="10" y1="6" x2="17" y2="6"/>
  <line x1="8" y1="10" x2="8" y2="10"/>
  <line x1="10" y1="10" x2="16" y2="10"/>
  <line x1="8" y1="14" x2="8" y2="14"/>
  <line x1="10" y1="14" x2="15" y2="14"/>
  <circle cx="8" cy="6" r="1" fill="currentColor" stroke="none"/>
  <circle cx="8" cy="10" r="1" fill="currentColor" stroke="none"/>
  <circle cx="8" cy="14" r="1" fill="currentColor" stroke="none"/>
  <path d="M10 6 Q12 5.5 14 6.2 Q16 6.8 17 6" stroke-width="1.2"/>
  <path d="M10 10 Q12 9.4 14 10.1 Q15.5 10.6 16 10" stroke-width="1.2"/>
  <path d="M10 14 Q11.5 13.5 13 14 Q14 14.4 15 14" stroke-width="1.2"/>
</svg></div><div class="empty-title">Your list is empty</div><div class="empty-sub">Tap <strong>Ôºã</strong> to add items or paste a shopping list.</div></div>`; return; }

  // group
  const groups={};
  items.forEach((item,idx)=>{
    const key=(item.aisleIndex!==null&&item.aisleIndex!==undefined)?item.aisleIndex:'unmatched';
    if(!groups[key]) groups[key]=[];
    groups[key].push({...item,idx});
  });
  const keys=Object.keys(groups).filter(k=>k!=='unmatched').sort((a,b)=>+a-+b);
  if(groups['unmatched']) keys.push('unmatched');

  const total=items.length, done=items.filter(i=>i.checked).length;
  let html=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
    <div style="font-size:.75rem;color:var(--muted)">${done}/${total} items ‚úì</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-sm btn-ghost" onclick="openEditList()">Edit</button>
      <button class="btn btn-sm btn-ghost" onclick="clearChecked()">Clear checked</button>
      <button class="btn btn-sm btn-danger" onclick="clearList()">Clear all</button>
    </div>
  </div>`;

  keys.forEach(key=>{
    const gItems=groups[key];
    const isUM=key==='unmatched';
    const color=isUM?'#fbbf24':AISLE_COLORS[+key%AISLE_COLORS.length];
    const aisle=!isUM?store.aisles[+key]:null;
    const aisleName=isUM?'? Unmatched Items':(aisle?aisle.name:`Aisle ${+key+1}`);
    const unchecked=gItems.filter(i=>!i.checked).length;

    html+=`<div class="aisle-group">
      <div class="aisle-group-header" style="background:${hexRgba(color,.12)};color:${color}">
        ${isUM?'‚ö†':'üõí'} ${esc(aisleName)}
        <span class="aisle-count">${unchecked} left</span>
      </div>
      <div class="items-container" data-aisle-key="${key}">`;

    gItems.forEach(item=>{
      const bgBadge=hexRgba(color,.18);
      const aiDot=item.aiClassified?`<span class="ai-dot" title="AI classified">‚ú¶</span>`:'';
      html+=`<div class="list-item ${item.checked?'checked':''}"
          data-item-idx="${item.idx}" data-aisle-key="${key}"
          draggable="true"
          ondragstart="dStart(event,${item.idx},'${key}')"
          ondragend="dEnd(event)"
          ondragover="dOver(event)"
          ondrop="dDrop(event,${item.idx},'${key}')"
          ontouchstart="tStart(event,${item.idx},'${key}')"
          ontouchmove="tMove(event)"
          ontouchend="tEnd(event)">
        <div class="drag-handle" title="Drag to reorder">‚†ø</div>
        <div class="item-check ${item.checked?'done':''}" onclick="toggleCheck(${item.idx})">
          ${item.checked?'<span style="font-size:.7rem;color:#0a1a12">‚úì</span>':''}
        </div>
        <div class="item-name">${esc(item.name)} ${aiDot}</div>
        <div class="item-aisle-badge" style="background:${bgBadge};color:${color}" onclick="openMoveItem(${item.idx})">
          ${isUM?'?':`A${+key+1}`}
        </div>
      </div>`;
    });

    // Drop zone at bottom of each aisle group
    html+=`<div class="drop-zone" data-aisle-key="${key}"
        ondragover="dzOver(event)" ondragleave="dzLeave(event)" ondrop="dzDrop(event,'${key}')"></div>`;
    html+=`</div></div>`;
  });

  cont.innerHTML=html;
}

function renderStoresScreen(){
  const cont=document.getElementById('stores-list');
  if(!state.stores.length){ cont.innerHTML=`<div class="empty"><div class="empty-icon"><svg width="2.5rem" height="2.5rem" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
  <path d="M3 9l1-5h16l1 5"/>
  <path d="M3 9a2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2 2 2 0 0 0 2 2 2 2 0 0 0 2-2"/>
  <path d="M5 11v9h14v-9"/>
  <rect x="8" y="13" width="8" height="5" rx="1"/>
  <path d="M9.5 15 Q11 14.4 12.5 15.2 Q14 15.8 14.5 15" stroke-width="1.1"/>
  <path d="M9.5 17 Q11 16.5 13 17" stroke-width="1.1"/>
</svg></div><div class="empty-title">No stores yet</div><div class="empty-sub">Add your first store to get started.</div></div>`; return; }
  cont.innerHTML=state.stores.map(store=>{
    const ll=(state.lists[store.id]||[]).length;
    const cc=Object.keys(state.corrections[store.id]||{}).length;
    const isOwner=!window._currentUser||store.ownerUid===window._currentUser?.uid;
    const sharedBadge=store.isShared||store.shareCode?`<span class="shared-badge">üîó Shared</span>`:'';
    return `<div class="card">
      <div class="card-header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:12px;height:12px;border-radius:50%;background:${store.color};flex-shrink:0"></div>
          <div>
            <div style="font-weight:600;font-size:.95rem;display:flex;align-items:center;gap:8px">${esc(store.name)} ${sharedBadge}</div>
            <div class="text-muted">${store.aisles.length} aisles ¬∑ ${ll} items ¬∑ ${cc} corrections</div>
          </div>
        </div>
        <div style="display:flex;gap:6px">
          ${isOwner?`<button class="btn btn-sm btn-ghost" onclick="window.openShareStoreModal('${store.id}')">üîó Share</button>`:''}
          ${isOwner?`<button class="btn btn-sm btn-ghost" onclick="editStore('${store.id}')">Edit</button>`:''}
          <button class="btn btn-sm btn-danger" onclick="deleteStore('${store.id}')">‚úï</button>
        </div>
      </div>
      ${state.activeStoreId===store.id
        ?'<div style="margin-top:10px;font-size:.65rem;color:var(--green);font-weight:600;letter-spacing:.08em;text-transform:uppercase">‚óè Active</div>'
        :`<button class="btn btn-sm btn-ghost" style="margin-top:10px" onclick="setActiveStore('${store.id}')">Set Active</button>`}
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openStoreSwitch(){
  document.getElementById('store-switch-list').innerHTML=state.stores.map(s=>`
    <div class="card" style="cursor:pointer;border-color:${state.activeStoreId===s.id?s.color:'var(--border)'};margin-bottom:8px;display:flex;align-items:center;gap:10px" onclick="setActiveStore('${s.id}')">
      <div style="width:10px;height:10px;border-radius:50%;background:${s.color};flex-shrink:0"></div>
      <span style="font-weight:${state.activeStoreId===s.id?'600':'400'};flex:1">${esc(s.name)}</span>
      ${state.activeStoreId===s.id?'<span style="color:var(--green);font-size:.75rem">Active</span>':''}
      <button class="btn btn-sm btn-danger" style="flex-shrink:0;margin-left:8px"
        onclick="event.stopPropagation();deleteStore('${s.id}')">‚úï</button>
    </div>`).join('')||'<p class="text-muted" style="text-align:center;padding:12px 0">No stores yet.</p>';
  openModal('modal-store-switch');
}

function setActiveStore(id){ state.activeStoreId=id; closeModal('modal-store-switch'); renderAll(); }


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORE LIBRARY ‚Äî UI LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _libSelectedChain = null;    // currently highlighted chain in library modal
let _libNearbyResult  = [];      // cached nearby search results
let _libNearbyLoaded  = false;

function openLibraryModal() {
  _libSelectedChain = null;
  document.getElementById('lib-selected-preview').style.display = 'none';
  openModal('modal-library');
  // Auto-trigger nearby if we haven't yet this session
  if (!_libNearbyLoaded) {
    switchLibTab('nearby');
  } else {
    renderNearbyList();
  }
  renderLibraryBrowse();
}

function switchLibTab(tab) {
  ['nearby','browse'].forEach(t => {
    document.getElementById('libtab-' + t).classList.toggle('active', t === tab);
    document.getElementById('libpanel-' + t).classList.toggle('active', t === tab);
  });
}

// ‚îÄ‚îÄ Browse tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLibraryBrowse() {
  const q = (document.getElementById('lib-search-input')?.value || '').toLowerCase();
  const all = getAllLibraryStores();
  const filtered = q
    ? all.filter(c => c.name.toLowerCase().includes(q) ||
        c.searchNames.some(s => s.includes(q)))
    : all;

  const grid = document.getElementById('lib-browse-grid');
  if (!filtered.length) {
    grid.innerHTML = '<div class="loc-status">No chains match your search</div>';
    return;
  }
  grid.innerHTML = filtered.map(chain => {
    const isSelected = _libSelectedChain?.id === chain.id;
    const badge = chain.dataSource === 'real'
      ? '<span class="source-badge real">Official data</span>'
      : '<span class="source-badge">Curated</span>';
    return `<button class="lib-chain-card ${isSelected ? 'selected' : ''}"
        onclick="selectLibChain('${chain.id}', 'browse')">
      <div class="lib-chain-row">
        <div class="lib-chain-dot" style="background:${chain.color}"></div>
        <div>
          <div class="lib-chain-name">${esc(chain.name)}</div>
          <div class="lib-chain-meta">${chain.aisles.length} aisles${badge}</div>
        </div>
      </div>
    </button>`;
  }).join('');
}

// ‚îÄ‚îÄ Nearby tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Session cache ‚Äî loaded once from Firestore, reused for the life of the page
let _storeLocationCache   = null;
let _storeLocationLoading = false;

// Infinite scroll state
const NEARBY_PAGE_SIZE = 15;
let   _nearbyPage      = 0;       // how many pages rendered so far
let   _nearbyObserver  = null;    // IntersectionObserver for load-more trigger

// Haversine distance in meters between two lat/lng points
function haversineMeters(lat1, lng1, lat2, lng2) {
  const R    = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a    = Math.sin(dLat / 2) ** 2 +
               Math.cos(lat1 * Math.PI / 180) *
               Math.cos(lat2 * Math.PI / 180) *
               Math.sin(dLng / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Load all store locations from static JSON (once per session, then cached)
// Source: /stores.json served from GitHub Pages ‚Äî no Firestore reads needed.
// To update: run export-store-locations.js and commit the new stores.json.
async function loadStoreLocations() {
  if (_storeLocationCache) return _storeLocationCache;
  if (_storeLocationLoading) {
    await new Promise(resolve => {
      const t = setInterval(() => { if (!_storeLocationLoading) { clearInterval(t); resolve(); } }, 100);
    });
    return _storeLocationCache;
  }
  _storeLocationLoading = true;
  try {
    const resp = await fetch('/stores.json');
    if (!resp.ok) throw new Error('stores.json not found (' + resp.status + ')');
    _storeLocationCache = await resp.json();
    return _storeLocationCache;
  } finally {
    _storeLocationLoading = false;
  }
}

// Shared helper: sort stores by distance from a given lat/lng and populate _libNearbyResult
async function computeNearbyFromCoords(lat, lng) {
  const allStores = await loadStoreLocations();
  if (!allStores.length) return false;

  const withDistance = allStores
    .filter(s => s.lat && s.lng)
    .map(s => ({ ...s, distance: haversineMeters(lat, lng, s.lat, s.lng) }))
    .sort((a, b) => a.distance - b.distance);

  const seen = new Set();
  const deduped = withDistance.filter(s => {
    if (seen.has(s.osm_id)) return false;
    seen.add(s.osm_id);
    return true;
  });

  _libNearbyResult = deduped.map(s => ({
    place_id: s.osm_id,
    name:     s.name,
    address:  s.address,
    lat:      s.lat,
    lng:      s.lng,
    distance: s.distance,
    chain_id: s.chain_id,
  }));
  return true;
}

async function findNearbyStores() {
  const statusEl = document.getElementById('nearby-status');
  const btnEl    = document.getElementById('btn-find-nearby');

  statusEl.style.display = 'block';
  statusEl.textContent   = 'Requesting your location‚Ä¶';
  btnEl.disabled         = true;

  try {
    const pos = await new Promise((resolve, reject) =>
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        timeout: 10000, maximumAge: 300000, enableHighAccuracy: false
      })
    );
    const { latitude: userLat, longitude: userLng } = pos.coords;
    statusEl.textContent = 'Loading store locations‚Ä¶';

    const ok = await computeNearbyFromCoords(userLat, userLng);
    if (!ok) { statusEl.textContent = 'No store data found.'; return; }

    _libNearbyLoaded = true;
    statusEl.style.display = 'none';
    document.getElementById('nearby-location-input').value = '';
    initNearbyScroll();

  } catch (err) {
    statusEl.style.display = 'block';
    if (err.code === 1) {
      statusEl.innerHTML =
        'Location permission denied.<br>' +
        '<span style="font-size:.65rem">Enable location access in your browser ' +
        'settings, or search a location above.</span>';
    } else {
      statusEl.textContent = 'Could not get location: ' + (err.message || 'unknown error');
    }
  } finally {
    btnEl.disabled    = false;
    btnEl.textContent = '‚Üª Use My Location';
  }
}

async function searchNearbyLocation() {
  const input    = document.getElementById('nearby-location-input');
  const query    = input.value.trim();
  if (!query) return;

  const statusEl = document.getElementById('nearby-status');
  statusEl.style.display = 'block';
  statusEl.textContent   = 'Searching for "' + query + '"‚Ä¶';

  try {
    const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' +
      encodeURIComponent(query);
    const resp = await fetch(url, {
      headers: { 'Accept-Language': 'en', 'User-Agent': 'InstAisle/1.0' }
    });
    const results = await resp.json();

    if (!results.length) {
      statusEl.textContent = 'Location not found. Try a city name or zip code.';
      return;
    }

    const { lat, lon, display_name } = results[0];
    statusEl.textContent = 'Loading stores near ' + display_name.split(',').slice(0, 2).join(',') + '‚Ä¶';

    const ok = await computeNearbyFromCoords(parseFloat(lat), parseFloat(lon));
    if (!ok) { statusEl.textContent = 'No store data found.'; return; }

    _libNearbyLoaded = true;
    statusEl.style.display = 'none';
    initNearbyScroll();

  } catch (err) {
    statusEl.textContent = 'Search failed. Check your connection and try again.';
    console.error('searchNearbyLocation:', err);
  }
}

// ‚îÄ‚îÄ Infinite scroll rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function initNearbyScroll() {
  // Disconnect old observer if any
  if (_nearbyObserver) { _nearbyObserver.disconnect(); _nearbyObserver = null; }

  _nearbyPage = 0;
  const container = document.getElementById('nearby-list-container');
  container.innerHTML = '<div class="nearby-list" id="nearby-list-inner"></div>';

  renderNearbyPage();   // render first page immediately

  // Set up IntersectionObserver on the trigger div
  const trigger = document.getElementById('nearby-load-more-trigger');
  _nearbyObserver = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) renderNearbyPage();
  }, { rootMargin: '120px' });
  _nearbyObserver.observe(trigger);
}

function renderNearbyPage() {
  const start = _nearbyPage * NEARBY_PAGE_SIZE;
  const slice = _libNearbyResult.slice(start, start + NEARBY_PAGE_SIZE);
  if (!slice.length) {
    if (_nearbyObserver) { _nearbyObserver.disconnect(); _nearbyObserver = null; }
    return;
  }

  const inner = document.getElementById('nearby-list-inner');
  if (!inner) return;

  slice.forEach(store => {
    const chain      = store.chain_id
      ? getAllLibraryStores().find(c => c.id === store.chain_id)
      : matchStoreToLibrary(store.name);
    const isSelected = _libSelectedChain?._placeId === store.place_id;

    const matchPill = chain
      ? '<span class="nearby-match-pill">‚úì ' + esc(chain.name) + ' data</span>'
      : '<span class="nearby-no-match-pill">No template</span>';

    const card = document.createElement('div');
    card.className = 'nearby-card' + (isSelected ? ' selected' : '');
    card.setAttribute('data-place-id', store.place_id);
    card.onclick = () => selectNearbyStore(store.place_id);
    card.innerHTML =
      '<div class="nearby-card-info">' +
        '<div class="nearby-name">' + esc(store.name) + '</div>' +
        '<div class="nearby-address">' + esc(store.address) + '</div>' +
        '<div class="nearby-meta"><span class="nearby-dist">' + formatDistance(store.distance) + '</span></div>' +
      '</div>' + matchPill;
    inner.appendChild(card);
  });

  _nearbyPage++;

  // Stop observing if we've rendered everything
  if (_nearbyPage * NEARBY_PAGE_SIZE >= _libNearbyResult.length) {
    if (_nearbyObserver) { _nearbyObserver.disconnect(); _nearbyObserver = null; }
  }
}

// Legacy renderNearbyList ‚Äî now delegates to initNearbyScroll when results exist
function renderNearbyList() {
  if (_libNearbyResult.length) initNearbyScroll();
}

function formatDistance(meters) {
  if (meters < 1000) return Math.round(meters) + ' m';
  return (meters / 1609.34).toFixed(1) + ' mi';
}

function selectNearbyStore(placeId) {
  const store = _libNearbyResult.find(s => s.place_id === placeId);
  if (!store) return;
  // Use chain_id directly if available, otherwise fall back to name matching
  const chain = store.chain_id
    ? getAllLibraryStores().find(c => c.id === store.chain_id)
    : matchStoreToLibrary(store.name);
  _libSelectedChain = chain
    ? { ...chain, _placeId: placeId, _placeName: store.name, _placeAddress: store.address }
    : { _placeId: placeId, _placeName: store.name, _placeAddress: store.address,
        id: null, name: store.name, color: STORE_COLORS[0], aisles: [] };
  renderNearbyList();
  showLibraryPreview(store.name, store.address, chain);
}

function selectLibChain(chainId, source) {
  const chain = getAllLibraryStores().find(c => c.id === chainId);
  if (!chain) return;
  _libSelectedChain = { ...chain, _placeId: null, _placeName: null, _placeAddress: null };
  if (source === 'browse') renderLibraryBrowse();
  showLibraryPreview(chain.name, chain.aisles.length + ' aisles pre-loaded', chain);
}

function showLibraryPreview(name, meta, chain) {
  const preview = document.getElementById('lib-selected-preview');
  document.getElementById('lib-selected-name').textContent = name;
  const aisleCnt = chain ? chain.aisles?.length : 0;
  const srcLabel = chain?.dataSource === 'real' ? '‚úÖ Official store data' : 'üìã Curated typical layout';
  document.getElementById('lib-selected-meta').textContent =
    meta + (chain && aisleCnt ? ' ¬∑ ' + aisleCnt + ' aisles ¬∑ ' + srcLabel : '');
  preview.style.display = 'block';
}

async function addStoreFromLibrary() {
  if (!_libSelectedChain) return;
  const chain = _libSelectedChain;

  const storeName  = chain._placeName || chain.name;
  const storeColor = chain.color || STORE_COLORS[state.stores.length % STORE_COLORS.length];
  const aisles = chain.aisles?.length
    ? chain.aisles.map(a => ({ name: a.name, keywords: [...a.keywords] }))
    : [
        { name: 'Produce', keywords: ['apple','banana','vegetable','fruit'] },
        { name: 'Dairy',   keywords: ['milk','cheese','yogurt','eggs'] }
      ];

  // Close library overlay directly (bypass history.back() to avoid popstate race)
  document.getElementById('modal-library').classList.remove('open');

  // Open the store editor pre-filled with library data
  state.editingStoreId = null;
  pendingScannedKws = {}; aisleImgTargetIdx = null;
  document.getElementById('store-modal-title').textContent = 'New Store';
  document.getElementById('store-name-input').value = storeName;
  tempColor  = storeColor;
  tempAisles = aisles;
  renderStoreModal();
  openModal('modal-store');
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openNewStore(){
  state.editingStoreId=null;
  pendingScannedKws={}; aisleImgTargetIdx=null;
  document.getElementById('store-modal-title').textContent='New Store';
  document.getElementById('store-name-input').value='';
  tempColor=STORE_COLORS[state.stores.length%STORE_COLORS.length];
  tempAisles=[
    {name:'Aisle 1 ‚Äì Produce', keywords:['apple','banana','vegetable','fruit']},
    {name:'Aisle 2 ‚Äì Dairy',   keywords:['milk','cheese','yogurt','eggs']},
  ];
  renderStoreModal();
  openModal('modal-store');
}

function editStore(id){
  const store=state.stores.find(s=>s.id===id);
  pendingScannedKws={}; aisleImgTargetIdx=null;
  state.editingStoreId=id;
  document.getElementById('store-modal-title').textContent='Edit Store';
  document.getElementById('store-name-input').value=store.name;
  tempColor=store.color;
  tempAisles=store.aisles.map(a=>({name:a.name,keywords:[...a.keywords]}));
  renderStoreModal();
  openModal('modal-store');
}

function renderStoreModal(){
  document.getElementById('store-color-picker').innerHTML=STORE_COLORS.map(c=>
    `<div class="color-opt ${c===tempColor?'selected':''}" style="background:${c}" onclick="pickColor('${c}')"></div>`
  ).join('');
  renderAisleRows();
}

function pickColor(c){
  tempColor=c;
  document.getElementById('store-color-picker').innerHTML=STORE_COLORS.map(col=>
    `<div class="color-opt ${col===c?'selected':''}" style="background:${col}" onclick="pickColor('${col}')"></div>`
  ).join('');
}

// ‚îÄ‚îÄ AISLE ROWS with fixed chip deletion + bulk keyword upload + image scan ‚îÄ‚îÄ
let aisleImgTargetIdx = null; // which aisle is currently being scanned
let pendingScannedKws = {};   // aisleIdx -> [keywords] from scan, awaiting accept

function renderAisleRows(){
  document.getElementById('aisle-rows').innerHTML=tempAisles.map((aisle,i)=>{
    const color=AISLE_COLORS[i%AISLE_COLORS.length];
    const pending=pendingScannedKws[i];
    return `<div class="card" id="aisle-card-${i}" data-aisle-idx="${i}" style="border-left:3px solid ${color};padding:14px;margin-bottom:10px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <div class="aisle-drag-handle" data-aisle-idx="${i}" title="Drag to reorder">‚†ø</div>
        <span style="font-size:.63rem;font-weight:700;color:${color};letter-spacing:.1em;text-transform:uppercase">AISLE ${i+1}</span>
        <div style="flex:1"></div>
        ${tempAisles.length>1?`<button class="btn btn-sm btn-danger" onclick="removeAisle(${i})">‚úï</button>`:''}
      </div>
      <input class="input" id="aisle-name-${i}" value="${esc(aisle.name)}"
        placeholder="e.g. Produce" style="font-size:.82rem;padding:8px 12px;margin-bottom:12px">
      <div style="font-size:.63rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;font-weight:600">Keywords</div>
      <div class="chips" id="chips-${i}" data-aisle="${i}">${renderChips(i)}</div>
      <div class="kw-section">
        <div class="kw-tabs">
          <button class="kw-tab active" id="tab-one-${i}" onclick="switchKwTab(${i},'one')">Add one</button>
          <button class="kw-tab" id="tab-bulk-${i}" onclick="switchKwTab(${i},'bulk')">Paste list</button>
          <button class="kw-tab" id="tab-scan-${i}" onclick="switchKwTab(${i},'scan')">üì∑ Scan photo</button>
        </div>
        <div class="kw-panel active" id="panel-one-${i}">
          <div class="kw-add-row">
            <input class="kw-input" id="kw-${i}" placeholder="e.g. frozen peas‚Ä¶"
              onkeydown="if(event.key==='Enter'){event.preventDefault();addKw(${i});}">
            <button class="kw-add-btn" onclick="addKw(${i})">Add</button>
          </div>
        </div>
        <div class="kw-panel" id="panel-bulk-${i}">
          <textarea class="kw-bulk" id="kw-bulk-${i}"
            placeholder="Paste keywords separated by commas or line breaks:&#10;brown eggs, 2% milk&#10;instant ramen"></textarea>
          <button class="kw-bulk-btn" onclick="addBulkKw(${i})">+ Add all keywords</button>
        </div>
        <div class="kw-panel" id="panel-scan-${i}">
          <div class="aisle-img-zone" id="scan-zone-${i}" onclick="triggerAisleScan(${i})">
            <div style="font-size:1.4rem;margin-bottom:6px">üì∏</div>
            <div style="font-size:.75rem;font-weight:600;margin-bottom:3px">Take or upload an aisle photo</div>
            <div style="font-size:.68rem">AI will identify what's on the shelves and add keywords automatically</div>
          </div>
          ${pending ? renderScanResult(i, pending) : ''}
        </div>
      </div>
    </div>`;
  }).join('');

  // Event-delegated chip deletion
  document.querySelectorAll('.chips[data-aisle]').forEach(container=>{
    container.addEventListener('click', e=>{
      const x=e.target.closest('.chip-x');
      if(!x) return;
      const chip=x.closest('.chip');
      const kw=chip?.dataset.kw;
      const ai=parseInt(container.dataset.aisle,10);
      if(kw!==undefined && !isNaN(ai)) removeKw(ai,kw);
    });
  });

  // Wire up aisle drag-to-reorder
  initAisleDrag();
}

function renderChips(i){
  return tempAisles[i].keywords.map(k=>
    `<div class="chip" data-kw="${esc(k)}">${esc(k)}<span class="chip-x" title="Remove">√ó</span></div>`
  ).join('');
}

function refreshChips(i){
  const el=document.getElementById('chips-'+i);
  if(!el) return;
  el.innerHTML=renderChips(i);
}

function switchKwTab(i, tab){
  ['one','bulk','scan'].forEach(t=>{
    document.getElementById('tab-'+t+'-'+i)?.classList.toggle('active', t===tab);
    document.getElementById('panel-'+t+'-'+i)?.classList.toggle('active', t===tab);
  });
  if(tab==='one') document.getElementById('kw-'+i)?.focus();
  else if(tab==='bulk') document.getElementById('kw-bulk-'+i)?.focus();
}

function addKw(i){
  const inp=document.getElementById('kw-'+i);
  if(!inp) return;
  const val=inp.value.trim().toLowerCase();
  if(!val){ inp.focus(); return; }
  if(!tempAisles[i].keywords.includes(val)) tempAisles[i].keywords.push(val);
  inp.value='';
  refreshChips(i);
  inp.focus();
}

function addBulkKw(i){
  const ta=document.getElementById('kw-bulk-'+i);
  if(!ta) return;
  // Split on commas OR newlines only ‚Äî preserves spaces within keywords
  const vals=ta.value.split(/[,\n]+/).map(v=>v.trim().toLowerCase()).filter(Boolean);
  let added=0;
  vals.forEach(v=>{ if(v && !tempAisles[i].keywords.includes(v)){ tempAisles[i].keywords.push(v); added++; } });
  ta.value='';
  refreshChips(i);
  showToast(`${added} keyword${added!==1?'s':''} added`);
}

function removeKw(i,kw){
  tempAisles[i].keywords=tempAisles[i].keywords.filter(k=>k!==kw);
  refreshChips(i);
}

// ‚îÄ‚îÄ AISLE IMAGE SCANNING ‚îÄ‚îÄ

function triggerAisleScan(i){
  syncNames();
  aisleImgTargetIdx=i;
  const inp=document.getElementById('aisle-img-input');
  inp.value='';
  inp.click();
}

async function handleAisleImageUpload(e){
  const f=e.target.files[0]; if(!f) return;
  e.target.value='';
  const i=aisleImgTargetIdx;
  if(i===null||i===undefined) return;

  // Show image preview + spinner in scan zone
  const zone=document.getElementById('scan-zone-'+i);
  if(!zone) return;

  const dataUrl=await fileToDataUrl(f);
  const b64=dataUrl.split(',')[1];
  const mime=f.type||'image/jpeg';

  zone.classList.add('scanning');
  zone.innerHTML=`
    <img class="aisle-img-thumb" src="${dataUrl}" alt="Aisle photo">
    <div class="aisle-img-spinner"></div>
    <div style="font-size:.7rem;color:var(--blue)">Scanning shelves‚Ä¶</div>`;

  try {
    const keywords=await scanAisleImage(b64, mime);
    pendingScannedKws[i]=keywords;
    zone.classList.remove('scanning');
    zone.classList.add('has-preview');
    zone.onclick=null; // disable re-trigger while result showing

    // Show preview + result row below zone
    zone.innerHTML=`<img class="aisle-img-thumb" src="${dataUrl}" alt="Aisle photo">
      <div style="font-size:.68rem;color:var(--muted);margin-top:4px">
        Found <strong style="color:var(--green)">${keywords.length}</strong> items ‚Äî review below before adding
      </div>`;

    // Re-render result row in panel
    const panel=document.getElementById('panel-scan-'+i);
    if(panel){
      // Remove old result row if present, then append new one
      panel.querySelector('.scan-result-row')?.remove();
      panel.insertAdjacentHTML('beforeend', renderScanResult(i, keywords));
    }
  } catch(err){
    console.error(err);
    zone.classList.remove('scanning');
    zone.innerHTML=`<div style="font-size:1.4rem;margin-bottom:6px">‚ö†Ô∏è</div>
      <div style="font-size:.75rem;color:var(--red)">Scan failed ‚Äî tap to try again</div>`;
    zone.onclick=()=>triggerAisleScan(i);
    showToast('Could not read image');
  }
}

function renderScanResult(i, keywords){
  if(!keywords||!keywords.length) return `<div style="font-size:.7rem;color:var(--muted);text-align:center;margin-top:8px">No items detected ‚Äî try a clearer photo</div>`;
  // Show first few as a preview list, then accept/discard buttons
  const preview=keywords.slice(0,8).map(k=>`<span style="font-size:.68rem;color:var(--text)">${esc(k)}</span>`).join(', ')
    +(keywords.length>8?` <span style="color:var(--muted)">+${keywords.length-8} more</span>`:'');
  return `<div class="scan-result-row">
    <div>
      <div class="scan-result-label" style="margin-bottom:4px">‚ú¶ Detected: ${preview}</div>
    </div>
  </div>
  <div style="display:flex;gap:6px;margin-top:8px">
    <button class="scan-accept-btn" style="flex:1" onclick="acceptScanKws(${i})">‚úì Add ${keywords.length} keyword${keywords.length!==1?'s':''}</button>
    <button class="scan-discard-btn" onclick="discardScan(${i})">Discard</button>
  </div>`;
}

function acceptScanKws(i){
  const kws=pendingScannedKws[i]||[];
  let added=0;
  kws.forEach(k=>{ if(!tempAisles[i].keywords.includes(k)){ tempAisles[i].keywords.push(k); added++; } });
  delete pendingScannedKws[i];
  // Reset scan zone, re-render chips, switch to 'one' tab
  refreshChips(i);
  const panel=document.getElementById('panel-scan-'+i);
  const zone=document.getElementById('scan-zone-'+i);
  if(zone){
    zone.classList.remove('has-preview','scanning');
    zone.onclick=()=>triggerAisleScan(i);
    zone.innerHTML=`<div style="font-size:1.4rem;margin-bottom:6px">üì∏</div>
      <div style="font-size:.75rem;font-weight:600;margin-bottom:3px">Take or upload an aisle photo</div>
      <div style="font-size:.68rem">AI will identify what's on the shelves and add keywords automatically</div>`;
  }
  if(panel) panel.querySelectorAll('.scan-result-row,.scan-accept-btn,.scan-discard-btn').forEach(el=>el.remove());
  showToast(`${added} keyword${added!==1?'s':''} added from photo ‚úì`);
  switchKwTab(i,'one');
}

function discardScan(i){
  delete pendingScannedKws[i];
  const zone=document.getElementById('scan-zone-'+i);
  if(zone){
    zone.classList.remove('has-preview','scanning');
    zone.onclick=()=>triggerAisleScan(i);
    zone.innerHTML=`<div style="font-size:1.4rem;margin-bottom:6px">üì∏</div>
      <div style="font-size:.75rem;font-weight:600;margin-bottom:3px">Take or upload an aisle photo</div>
      <div style="font-size:.68rem">AI will identify what's on the shelves and add keywords automatically</div>`;
  }
  const panel=document.getElementById('panel-scan-'+i);
  if(panel){
    panel.querySelectorAll('.scan-result-row,.scan-accept-btn,.scan-discard-btn').forEach(el=>el.remove());
  }
}

async function scanAisleImage(b64, mime){
  const user=window._currentUser;
  if(!user){ showToast('Please sign in first'); return []; }
  const token=await user.getIdToken();

  // Resize before sending
  const MAX=1024;
  const resizedB64=await new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.width,h=img.height;
      if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX;}else{w=Math.round(w*MAX/h);h=MAX;}}
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg',0.85).split(',')[1]);
    };
    img.src=`data:${mime};base64,${b64}`;
  });

  const res=await fetch(
    'https://us-central1-instaisle-e8d6b.cloudfunctions.net/scanAisleImage',
    {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({imageBase64:resizedB64, mimeType:'image/jpeg'})
    }
  );
  if(!res.ok){
    const err=await res.json().catch(()=>({}));
    throw new Error(err?.error||`Server error ${res.status}`);
  }
  const data=await res.json();
  return Array.isArray(data.keywords)?data.keywords:[];
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=e=>resolve(e.target.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

function addAisleRow(){
  syncNames(); // persist typed names before re-render
  tempAisles.push({name:`Aisle ${tempAisles.length+1}`,keywords:[]});
  renderAisleRows();
  // scroll modal to bottom to reveal new aisle
  const modal=document.querySelector('#modal-store .modal');
  if(modal) setTimeout(()=>{ modal.scrollTop=modal.scrollHeight; },50);
}

function removeAisle(i){ syncNames(); tempAisles.splice(i,1); renumberAisleNames(); renderAisleRows(); }

function syncNames(){
  tempAisles.forEach((_,i)=>{
    const el=document.getElementById('aisle-name-'+i);
    if(el) tempAisles[i].name=el.value;
  });
}

// ‚îÄ‚îÄ AISLE DRAG-TO-REORDER (pointer events ‚Äî works inside scrolling modals) ‚îÄ‚îÄ
function initAisleDrag(){
  const handles=document.querySelectorAll('.aisle-drag-handle');
  handles.forEach(handle=>{
    handle.addEventListener('pointerdown', onAisleDragStart, {passive:false});
  });
}

let aisleGhost=null, aisleDragSrcIdx=null, aislePointerStartY=0, aisleScrollStart=0;

function onAisleDragStart(e){
  if(e.button!==undefined && e.button!==0) return; // left-click / touch only
  e.preventDefault();
  syncNames(); // save typed values before we reorder

  const handle=e.currentTarget;
  aisleDragSrcIdx=parseInt(handle.dataset.aisleIdx,10);
  const srcCard=document.getElementById('aisle-card-'+aisleDragSrcIdx);
  if(!srcCard) return;

  const modal=document.querySelector('#modal-store .modal');
  const cardRect=srcCard.getBoundingClientRect();
  const modalRect=modal ? modal.getBoundingClientRect() : {top:0,left:0};

  aislePointerStartY=e.clientY;
  aisleScrollStart=modal ? modal.scrollTop : 0;

  // Create ghost clone
  aisleGhost=srcCard.cloneNode(true);
  Object.assign(aisleGhost.style,{
    position:'fixed',
    top: cardRect.top+'px',
    left: cardRect.left+'px',
    width: cardRect.width+'px',
    zIndex: '500',
    opacity: '0.85',
    pointerEvents: 'none',
    boxShadow: '0 8px 32px rgba(0,0,0,.45)',
    border: '2px solid var(--green)',
    borderRadius: '14px',
    transition: 'none',
    margin: '0',
  });
  document.body.appendChild(aisleGhost);

  srcCard.classList.add('aisle-card-dragging');
  handle.classList.add('grabbing');

  document.addEventListener('pointermove', onAisleDragMove, {passive:false});
  document.addEventListener('pointerup',   onAisleDragEnd,  {passive:false});
  document.addEventListener('pointercancel', onAisleDragEnd,{passive:false});
}

function onAisleDragMove(e){
  if(!aisleGhost) return;
  e.preventDefault();

  const dy=e.clientY - aislePointerStartY;
  const modal=document.querySelector('#modal-store .modal');
  const scrollDy=modal ? modal.scrollTop - aisleScrollStart : 0;
  const srcCard=document.getElementById('aisle-card-'+aisleDragSrcIdx);
  if(!srcCard) return;

  const srcRect=srcCard.getBoundingClientRect();
  aisleGhost.style.top = (srcRect.top + dy + scrollDy) + 'px';

  // Find which card the ghost centre is hovering over
  const ghostCY=e.clientY;
  document.querySelectorAll('.card[data-aisle-idx]').forEach(card=>{
    const idx=parseInt(card.dataset.aisleIdx,10);
    card.classList.remove('aisle-card-dragover');
    if(idx===aisleDragSrcIdx) return;
    const r=card.getBoundingClientRect();
    if(ghostCY >= r.top && ghostCY <= r.bottom){
      card.classList.add('aisle-card-dragover');
    }
  });
}

function onAisleDragEnd(e){
  if(!aisleGhost) return;
  document.removeEventListener('pointermove', onAisleDragMove);
  document.removeEventListener('pointerup',   onAisleDragEnd);
  document.removeEventListener('pointercancel', onAisleDragEnd);

  // Find drop target
  let targetIdx=null;
  document.querySelectorAll('.card[data-aisle-idx]').forEach(card=>{
    if(card.classList.contains('aisle-card-dragover')){
      targetIdx=parseInt(card.dataset.aisleIdx,10);
    }
    card.classList.remove('aisle-card-dragover','aisle-card-dragging');
  });

  aisleGhost.remove(); aisleGhost=null;
  document.querySelectorAll('.aisle-drag-handle').forEach(h=>h.classList.remove('grabbing'));

  if(targetIdx!==null && targetIdx!==aisleDragSrcIdx){
    // Reorder tempAisles
    const moved=tempAisles.splice(aisleDragSrcIdx,1)[0];
    tempAisles.splice(targetIdx,0,moved);

    // Also reorder pendingScannedKws by the same move
    const newPending={};
    Object.keys(pendingScannedKws).forEach(k=>{
      const oldIdx=parseInt(k,10);
      let newIdx=oldIdx;
      if(oldIdx===aisleDragSrcIdx){ newIdx=targetIdx; }
      else if(aisleDragSrcIdx<targetIdx && oldIdx>aisleDragSrcIdx && oldIdx<=targetIdx){ newIdx=oldIdx-1; }
      else if(aisleDragSrcIdx>targetIdx && oldIdx>=targetIdx && oldIdx<aisleDragSrcIdx){ newIdx=oldIdx+1; }
      newPending[newIdx]=pendingScannedKws[k];
    });
    pendingScannedKws=newPending;

    renumberAisleNames();
    renderAisleRows();
  }

  aisleDragSrcIdx=null;
}

// Auto-renumber aisle names that match the pattern "Aisle N" or "Aisle N ‚Äì ‚Ä¶"
// so moving Aisle 3 to position 1 renames it to Aisle 1, shifting others up.
function renumberAisleNames(){
  tempAisles.forEach((aisle,i)=>{
    // Match "Aisle <number>" optionally followed by " ‚Äì rest of name"
    const m=aisle.name.match(/^Aisle\s+\d+(\s*[‚Äì-]\s*.*)?$/i);
    if(m){
      const suffix=m[1]||'';
      aisle.name=`Aisle ${i+1}${suffix}`;
    }
  });
}

async function saveStore(){
  syncNames();
  const name=document.getElementById('store-name-input').value.trim();
  if(!name){ showToast('Please enter a store name'); return; }
  if(!tempAisles.length){ showToast('Add at least one aisle'); return; }
  const aisles=tempAisles.map(a=>({name:a.name,keywords:[...a.keywords]}));

  if(state.editingStoreId){
    const store=state.stores.find(s=>s.id===state.editingStoreId);
    store.name=name; store.color=tempColor; store.aisles=aisles;
    if(state.lists[store.id]?.length){
      state.lists[store.id]=state.lists[store.id].map(item=>({
        ...item, aisleIndex: rematch(item.name,store)
      }));
    }
    if(window.persistStore) await window.persistStore(store.id);
  } else {
    const id='store-'+Date.now();
    const newStore={id,name,color:tempColor,aisles,ownerUid:window._currentUser?.uid,members:[],shareCode:null,isShared:false};
    state.stores.push(newStore);
    state.lists[id]=[]; state.corrections[id]={};
    if(!state.activeStoreId) state.activeStoreId=id;
    if(window.createStoreInFirestore) await window.createStoreInFirestore(newStore);
  }
  closeModal('modal-store'); renderAll(); showToast('Store saved ‚úì');
}

function rematch(itemName,store){
  const corr=state.corrections[store.id]||{};
  const norm=normalise(itemName);
  if(corr[norm]!==undefined) return corr[norm];
  return kwMatch(norm,store.aisles);
}

async function deleteStore(id){
  const store = state.stores.find(s => s.id === id);
  if (!store) return;

  // Only the owner can delete a store
  const uid = window._currentUser?.uid;
  if (store.ownerUid && uid && store.ownerUid !== uid) {
    showToast('Only the store owner can delete it'); return;
  }

  // Prevent deleting the last store
  if (state.stores.length === 1) {
    showToast('You must have at least one store'); return;
  }

  // Use custom confirm modal instead of confirm() which is blocked on some mobile browsers
  showDeleteConfirm(store.name, async () => {
    // Unsubscribe the real-time listener for this store
    if (window._storeUnsubs) {
      const idx = state.stores.findIndex(s => s.id === id);
      if (idx !== -1 && window._storeUnsubs[idx]) {
        window._storeUnsubs[idx]();
        window._storeUnsubs.splice(idx, 1);
      }
    }
    state.stores = state.stores.filter(s => s.id !== id);
    delete state.lists[id]; delete state.corrections[id];
    if (state.activeStoreId === id) state.activeStoreId = state.stores[0]?.id || null;
    if (window.deleteStoreFromFirestore) await window.deleteStoreFromFirestore(id);
    renderAll(); showToast('"' + store.name + '" deleted');
  });
}

// Custom confirm dialog (avoids mobile browser confirm() suppression)
function showDeleteConfirm(name, onConfirm) {
  const overlay = document.getElementById('modal-delete-confirm');
  document.getElementById('delete-confirm-name').textContent = '"' + name + '"';
  window._deleteConfirmCallback = onConfirm;
  openModal('modal-delete-confirm');
}

window.confirmDelete = function() {
  closeModal('modal-delete-confirm');
  if (window._deleteConfirmCallback) {
    window._deleteConfirmCallback();
    window._deleteConfirmCallback = null;
  }
};

window.cancelDelete = function() {
  closeModal('modal-delete-confirm');
  window._deleteConfirmCallback = null;
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LIST ‚Äì AI MATCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAddList(){
  if(!getActiveStore()){ showToast('Please select a store first'); switchScreen('stores'); return; }
  document.getElementById('list-text-input').value='';
  resetUploadZone();
  openModal('modal-add-list');
}

let uploadedImageB64 = null; // stores base64 of uploaded image for AI parsing
let uploadedImageType = null;

function handleFileUpload(e){
  const f=e.target.files[0]; if(!f) return;
  e.target.value='';
  const zone=document.getElementById('upload-zone');
  const iconEl=document.getElementById('upload-icon');
  const labelEl=document.getElementById('upload-label');

  // Detect if it's an image
  if(f.type.startsWith('image/')){
    const reader=new FileReader();
    reader.onload=ev=>{
      const dataUrl=ev.target.result;
      const img=new Image();
      img.onload=()=>{
        const MAX=1024;
        let w=img.width,h=img.height;
        if(w>MAX||h>MAX){ if(w>h){h=Math.round(h*MAX/w);w=MAX;}else{w=Math.round(w*MAX/h);h=MAX;} }
        const canvas=document.createElement('canvas');
        canvas.width=w; canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        const resized=canvas.toDataURL('image/jpeg',0.85);
        uploadedImageB64=resized.split(',')[1];
        uploadedImageType='image/jpeg';
        zone.classList.add('has-image');
        zone.innerHTML=`<img class="img-preview" src="${resized}" alt="List preview">
          <p style="font-size:.7rem;color:var(--green);margin-top:8px">‚úì Image ready ‚Äî tap Organise to read your list</p>`;
      };
      img.src=dataUrl;
    };
    reader.readAsDataURL(f);
  } else {
    // Text / any other file ‚Äî read as text
    uploadedImageB64=null; uploadedImageType=null;
    const reader=new FileReader();
    reader.onload=ev=>{
      document.getElementById('list-text-input').value=ev.target.result;
      zone.classList.remove('has-image');
      zone.innerHTML=`<div class="upload-icon">‚úÖ</div><p style="font-size:.78rem">${esc(f.name)} loaded</p>`;
    };
    reader.onerror=()=>{ showToast('Could not read file'); };
    reader.readAsText(f);
  }
}

async function processListInput(){
  const store=getActiveStore();
  closeModal('modal-add-list');

  // ‚îÄ‚îÄ Image path ‚îÄ‚îÄ
  if(uploadedImageB64){
    showProcessing('Reading your list with Gemini‚Ä¶');
    try {
      const names=await parseImageWithGemini(uploadedImageB64, uploadedImageType||'image/jpeg');
      uploadedImageB64=null; uploadedImageType=null;
      resetUploadZone();
      if(!names.length){ hideProcessing(); showToast('No items found ‚Äî try a clearer photo'); return; }
      showProcessing(`Found ${names.length} items ‚Äî sorting by aisle‚Ä¶`);
      const results=classifyItems(names,store);
      state.lists[store.id]=applyCorr(results,store);
      await window.persistStore(store.id);
      hideProcessing(); renderListScreen(); showToast(`${names.length} items from photo organised ‚úì`);
    } catch(err){
      hideProcessing(); console.error(err);
      showToast('Could not read image: '+(err.message||'unknown error'));
    }
    return;
  }

  // ‚îÄ‚îÄ Text path ‚îÄ‚îÄ
  const raw=document.getElementById('list-text-input').value.trim();
  resetUploadZone();
  if(!raw){ showToast('Enter at least one item'); return; }
  const names=raw.split('\n').map(l=>l.replace(/^[-‚Ä¢*\d.)]+\s*/,'').trim()).filter(Boolean);
  if(!names.length){ showToast('No items found'); return; }
  showProcessing('Sorting items by aisle‚Ä¶');
  const results=classifyItems(names,store);
  state.lists[store.id]=applyCorr(results,store);
  await window.persistStore(store.id);
  hideProcessing(); renderListScreen(); showToast(`${names.length} items organised ‚úì`);
}

function resetUploadZone(){
  uploadedImageB64=null; uploadedImageType=null;
  const zone=document.getElementById('upload-zone');
  if(zone){
    zone.classList.remove('has-image');
    zone.innerHTML=`<div class="upload-icon" id="upload-icon">üìé</div>
      <p style="font-size:.78rem" id="upload-label">Tap to upload a file or photo of your list</p>`;
  }
}

async function parseImageWithGemini(b64, mimeType){
  const user=window._currentUser;
  if(!user){ showToast('Please sign in first'); return []; }
  const token=await user.getIdToken();
  const res=await fetch(
    'https://us-central1-instaisle-e8d6b.cloudfunctions.net/parseShoppingList',
    {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},
      body:JSON.stringify({imageBase64:b64, mimeType})
    }
  );
  if(!res.ok){
    const err=await res.json().catch(()=>({}));
    throw new Error(err?.error||`Server error ${res.status}`);
  }
  const data=await res.json();
  return Array.isArray(data.items)?data.items.filter(Boolean):[];
}

function classifyItems(items,store){
  return items.map(name=>({
    name,
    aisleIndex: kwMatch(normalise(name),store.aisles),
    aiClassified: false,
    checked: false
  }));
}

function applyCorr(items,store){
  const corr=state.corrections[store.id]||{};
  return items.map(item=>{
    const norm=normalise(item.name);
    if(corr[norm]!==undefined) return {...item,aisleIndex:corr[norm],aiClassified:false};
    return item;
  });
}

function kwMatch(norm,aisles){
  let best=0,bestIdx=null;
  aisles.forEach((a,i)=>{
    let sc=0; a.keywords.forEach(k=>{ if(norm.includes(k.toLowerCase())) sc+=k.length; });
    if(sc>best){ best=sc; bestIdx=i; }
  });
  return bestIdx;
}

function normalise(s){ return s.toLowerCase().replace(/[^a-z0-9\s]/g,'').trim(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ITEM ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCheck(idx){
  const store=getActiveStore();
  state.lists[store.id][idx].checked=!state.lists[store.id][idx].checked;
  renderListScreen();
  persistActiveStore();
}
function clearChecked(){
  const store=getActiveStore();
  state.lists[store.id]=state.lists[store.id].filter(i=>!i.checked);
  renderListScreen(); showToast('Checked items removed');
  persistActiveStore();
}
function clearList(){
  if(!confirm('Clear the entire list?')) return;
  state.lists[getActiveStore().id]=[];
  renderListScreen();
  persistActiveStore();
}

// ‚îÄ‚îÄ Edit List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function openEditList() {
  const store = getActiveStore();
  if (!store) return;
  renderEditListItems();
  document.getElementById('edit-list-new-item').value = '';
  openModal('modal-edit-list');
  setTimeout(() => document.getElementById('edit-list-new-item').focus(), 300);
}

function renderEditListItems() {
  const store = getActiveStore();
  if (!store) return;
  const items = state.lists[store.id] || [];
  const container = document.getElementById('edit-list-items');

  if (!items.length) {
    container.innerHTML = '<div style="text-align:center;color:var(--muted);font-size:.85rem;padding:24px 0">No items ‚Äî add some above.</div>';
    return;
  }

  const groups = {};
  items.forEach((item, idx) => {
    const key = (item.aisleIndex !== null && item.aisleIndex !== undefined) ? item.aisleIndex : 'unmatched';
    if (!groups[key]) groups[key] = [];
    groups[key].push({ ...item, idx });
  });
  const keys = Object.keys(groups).filter(k => k !== 'unmatched').sort((a, b) => +a - +b);
  if (groups['unmatched']) keys.push('unmatched');

  let html = '';
  keys.forEach(key => {
    const gItems = groups[key];
    const isUM   = key === 'unmatched';
    const color  = isUM ? '#fbbf24' : AISLE_COLORS[+key % AISLE_COLORS.length];
    const aisle  = !isUM ? store.aisles[+key] : null;
    const aisleName = isUM ? '? Unmatched' : (aisle ? aisle.name : 'Aisle ' + (+key + 1));

    html += '<div style="font-size:.7rem;font-weight:700;text-transform:uppercase;' +
      'letter-spacing:.06em;color:' + color + ';margin:12px 0 6px;padding:0 2px">' + esc(aisleName) + '</div>';

    gItems.forEach(item => {
      const badge   = isUM ? '?' : 'A' + (+key + 1);
      const bgBadge = hexRgba(color, .18);
      html += '<div class="edit-list-item">' +
        '<span class="edit-item-name">' + esc(item.name) + '</span>' +
        '<span class="edit-item-aisle" style="background:' + bgBadge + ';color:' + color + '">' + badge + '</span>' +
        '<button class="edit-item-delete" onclick="deleteItemFromEdit(' + item.idx + ')" title="Remove">‚úï</button>' +
        '</div>';
    });
  });

  container.innerHTML = html;
}

async function deleteItemFromEdit(idx) {
  const store = getActiveStore();
  if (!store) return;
  state.lists[store.id].splice(idx, 1);
  await window.persistStore(store.id);
  renderEditListItems();
  renderListScreen();
}

async function addItemFromEdit() {
  const store = getActiveStore();
  if (!store) return;
  const input = document.getElementById('edit-list-new-item');
  const raw   = input.value.trim();
  if (!raw) return;

  // Split on commas or line breaks, clean up each entry
  const names = raw
    .split(/[,\n]+/)
    .map(s => s.replace(/^[-‚Ä¢*\d.)]+\s*/, '').trim())
    .filter(Boolean);

  if (!names.length) return;

  const results = classifyItems(names, store);
  const newItems = applyCorr(results, store);

  state.lists[store.id] = state.lists[store.id] || [];
  state.lists[store.id].push(...newItems);
  await window.persistStore(store.id);

  input.value = '';
  input.focus();
  renderEditListItems();
  renderListScreen();
  if (names.length > 1) showToast(names.length + ' items added ‚úì');
}

function openMoveItem(idx){
  const store=getActiveStore();
  const item=state.lists[store.id][idx];
  moveItemIndex=idx;
  document.getElementById('move-item-name').textContent=item.name;
  const opts=document.getElementById('move-aisle-options');
  opts.innerHTML=store.aisles.map((aisle,ai)=>{
    const color=AISLE_COLORS[ai%AISLE_COLORS.length];
    const isAct=item.aisleIndex===ai;
    return `<div class="card" style="cursor:pointer;border-color:${isAct?color:'var(--border)'};margin-bottom:8px" onclick="moveToAisle(${ai})">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:8px;height:8px;border-radius:50%;background:${color};flex-shrink:0"></div>
        <span style="font-size:.85rem;font-weight:${isAct?'600':'400'}">${esc(aisle.name)}</span>
        ${isAct?`<span style="margin-left:auto;color:${color};font-size:.7rem">Current</span>`:''}
      </div>
    </div>`;
  }).join('');
  const isUM=item.aisleIndex===null||item.aisleIndex===undefined;
  opts.innerHTML+=`<div class="card" style="cursor:pointer;border-color:${isUM?'var(--amber)':'var(--border)'};margin-bottom:8px" onclick="moveToAisle(null)">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:8px;height:8px;border-radius:50%;background:var(--amber);flex-shrink:0"></div>
      <span style="font-size:.85rem;font-weight:${isUM?'600':'400'}">Unmatched</span>
    </div>
  </div>`;
  openModal('modal-move-item');
}

function moveToAisle(aisleIndex){
  const store=getActiveStore();
  const item=state.lists[store.id][moveItemIndex];
  const norm=normalise(item.name);
  if(!state.corrections[store.id]) state.corrections[store.id]={};
  if(aisleIndex===null) delete state.corrections[store.id][norm];
  else state.corrections[store.id][norm]=aisleIndex;
  item.aisleIndex=aisleIndex;
  closeModal('modal-move-item'); renderListScreen(); showToast('Correction saved ‚úì');
  persistActiveStore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG ‚Äî MOUSE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dStart(e,idx,aisleKey){
  dragSrcIdx=idx; dragSrcAisle=aisleKey;
  e.dataTransfer.effectAllowed='move';
  setTimeout(()=>{
    const el=document.querySelector(`[data-item-idx="${idx}"]`);
    if(el) el.classList.add('dragging');
  },0);
}
function dEnd(e){
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('dragging','drag-over'));
  document.querySelectorAll('.drop-zone').forEach(el=>el.classList.remove('active'));
  dragSrcIdx=null; dragSrcAisle=null;
}
function dOver(e){
  e.preventDefault(); e.dataTransfer.dropEffect='move';
  if(+e.currentTarget.dataset.itemIdx!==dragSrcIdx) e.currentTarget.classList.add('drag-over');
}
function dDrop(e,targetIdx,targetAisleKey){
  e.preventDefault(); e.stopPropagation();
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('drag-over'));
  if(dragSrcIdx===null||dragSrcIdx===targetIdx) return;
  reorderItems(dragSrcIdx, targetIdx, targetAisleKey);
}
function dzOver(e){ e.preventDefault(); e.currentTarget.classList.add('active'); }
function dzLeave(e){ e.currentTarget.classList.remove('active'); }
function dzDrop(e,aisleKey){
  e.preventDefault(); e.currentTarget.classList.remove('active');
  if(dragSrcIdx===null) return;
  moveToEndOfAisle(dragSrcIdx, aisleKey);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DRAG ‚Äî TOUCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tStart(e,idx,aisleKey){
  if(!e.target.classList.contains('drag-handle')&&!e.target.closest('.drag-handle')) return;
  e.preventDefault();
  const touch=e.touches[0];
  touchSrcIdx=idx; touchSrcAisle=aisleKey;
  const el=e.currentTarget;
  const rect=el.getBoundingClientRect();
  touchOffX=touch.clientX-rect.left; touchOffY=touch.clientY-rect.top;
  touchClone=el.cloneNode(true);
  Object.assign(touchClone.style,{
    position:'fixed',left:rect.left+'px',top:rect.top+'px',width:rect.width+'px',
    opacity:'0.82',zIndex:'999',border:'2px solid var(--green)',borderRadius:'10px',
    pointerEvents:'none',background:'#22263a',transition:'none'
  });
  document.body.appendChild(touchClone);
  el.style.opacity='0.3';
}
function tMove(e){
  if(!touchClone) return;
  e.preventDefault();
  const t=e.touches[0];
  touchClone.style.left=(t.clientX-touchOffX)+'px';
  touchClone.style.top=(t.clientY-touchOffY)+'px';
  touchClone.style.display='none';
  const under=document.elementFromPoint(t.clientX,t.clientY);
  touchClone.style.display='';
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('drag-over'));
  document.querySelectorAll('.drop-zone').forEach(el=>el.classList.remove('active'));
  const ti=under?.closest('.list-item');
  if(ti&&+ti.dataset.itemIdx!==touchSrcIdx) ti.classList.add('drag-over');
  const dz=under?.closest('.drop-zone');
  if(dz) dz.classList.add('active');
}
function tEnd(e){
  if(!touchClone){ touchSrcIdx=null; return; }
  const t=e.changedTouches[0];
  touchClone.remove(); touchClone=null;
  document.querySelectorAll('[data-item-idx]').forEach(el=>el.style.opacity='');
  document.querySelectorAll('.list-item').forEach(el=>el.classList.remove('drag-over'));
  document.querySelectorAll('.drop-zone').forEach(el=>el.classList.remove('active'));
  const under=document.elementFromPoint(t.clientX,t.clientY);
  const ti=under?.closest('.list-item');
  const dz=under?.closest('.drop-zone');
  if(touchSrcIdx===null){ touchSrcIdx=null; return; }
  if(ti&&+ti.dataset.itemIdx!==touchSrcIdx){
    reorderItems(touchSrcIdx,+ti.dataset.itemIdx,ti.dataset.aisleKey);
  } else if(dz){
    moveToEndOfAisle(touchSrcIdx,dz.dataset.aisleKey);
  }
  touchSrcIdx=null; touchSrcAisle=null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REORDER HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function reorderItems(srcIdx, targetIdx, targetAisleKey){
  const store=getActiveStore();
  const items=state.lists[store.id];
  const moved=items[srcIdx];
  const targetAisle=targetAisleKey==='unmatched'?null:+targetAisleKey;
  moved.aisleIndex=targetAisle;
  items.splice(srcIdx,1);
  const insertAt=srcIdx<targetIdx?targetIdx-1:targetIdx;
  items.splice(Math.max(0,insertAt),0,moved);
  saveCorr(moved,targetAisle,store);
  renderListScreen();
  persistActiveStore();
}

function moveToEndOfAisle(srcIdx, aisleKey){
  const store=getActiveStore();
  const items=state.lists[store.id];
  const moved=items[srcIdx];
  const targetAisle=aisleKey==='unmatched'?null:+aisleKey;
  moved.aisleIndex=targetAisle;
  items.splice(srcIdx,1);
  items.push(moved);
  saveCorr(moved,targetAisle,store);
  renderListScreen();
  persistActiveStore();
}

function saveCorr(item,aisleIndex,store){
  const norm=normalise(item.name);
  if(!state.corrections[store.id]) state.corrections[store.id]={};
  if(aisleIndex===null) delete state.corrections[store.id][norm];
  else state.corrections[store.id][norm]=aisleIndex;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROCESSING OVERLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showProcessing(msg){
  document.getElementById('processing-text').textContent=msg||'';
  document.getElementById('processing-overlay').classList.add('show');
}
function hideProcessing(){
  document.getElementById('processing-overlay').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getActiveStore(){ return state.stores.find(s=>s.id===state.activeStoreId)||null; }
function openModal(id) {
  document.getElementById(id).classList.add('open');
  history.pushState({ type: 'modal', modalId: id }, '', '');
}
function closeModal(id) {
  const el = document.getElementById(id);
  if (!el || !el.classList.contains('open')) return;
  el.classList.remove('open');
  // If the current history state is for this modal, go back
  if (history.state?.type === 'modal' && history.state?.modalId === id) {
    history.back();
  }
}
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2600);
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function hexRgba(hex,a){
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE SAVE HOOKS
// Patch state-mutating functions to persist to Firestore
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function persistActiveStore() {
  if (window.persistStore && state.activeStoreId) {
    window.persistStore(state.activeStoreId);
  }
}


boot();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/InstAisle/sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
